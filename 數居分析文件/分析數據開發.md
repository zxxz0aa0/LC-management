# Orders 資料表前端數據分析功能 - 實作計劃

## 一、專案背景與需求確認

### 用戶需求
1. **主要目的**: 營運效率監控
2. **使用對象**: 管理層（看整體趨勢）
3. **優先實作維度**:
   - **地理與路線分析** (維度 5)
   - **時間模式分析** (維度 6)
4. **頁面設計**: 分頁式設計（地理分析、時間分析各自獨立頁面）
5. **必要功能**: 日期範圍篩選器、Excel 報表匯出

### 技術架構
- **後端**: Laravel 10 + PHP 8.1
- **前端**: Vite + Tailwind CSS + Alpine.js + AdminLTE 3.2
- **圖表**: Chart.js 4.4.0
- **快取**: Laravel Cache (30 分鐘)
- **匯出**: maatwebsite/excel (已安裝)

---

## 二、後端架構設計

### 2.1 Controller 結構

**StatisticsController**（統一管理所有統計功能）
- 位置: `app/Http/Controllers/StatisticsController.php`
- 主要方法:
  - `geographyIndex()` - 地理分析頁面
  - `timeAnalysisIndex()` - 時間分析頁面
  - `getGeographyData(Request $request)` - API: 地理分析數據
  - `getTimeAnalysisData(Request $request)` - API: 時間分析數據
  - `exportGeographyReport(Request $request)` - 匯出地理報表
  - `exportTimeReport(Request $request)` - 匯出時間報表

### 2.2 Service 層設計

**GeographyAnalysisService**
- 位置: `app/Services/GeographyAnalysisService.php`
- 核心方法:
  - `getPopularPickupLocations()` - 上車區域統計（全部區域）
  - `getPopularDropoffLocations()` - 下車區域統計（全部區域）
  - `getCrossCountyOrders()` - 跨縣市訂單統計
  - `getPopularRoutes()` - 區域路線統計（全部路線）

**TimeAnalysisService**
- 位置: `app/Services/TimeAnalysisService.php`
- 核心方法:
  - `getPeakHoursAnalysis()` - 尖峰時段分析（0-23 小時）
  - `getWeekdayDistribution()` - 週間分布（週一到週日）
  - `getMonthlyTrends()` - 月份趨勢（過去 12 個月）
  - `getAdvanceBookingAnalysis()` - 提前預約分析

**StatisticsCacheService** (可選，視效能需求)
- 位置: `app/Services/StatisticsCacheService.php`
- 提供統一的快取管理和清除機制

### 2.3 API 路由設計

```php
// routes/web.php

Route::middleware('auth')->prefix('statistics')->name('statistics.')->group(function () {
    // 頁面路由
    Route::get('/geography', [StatisticsController::class, 'geographyIndex'])
        ->name('geography.index');
    Route::get('/time-analysis', [StatisticsController::class, 'timeAnalysisIndex'])
        ->name('time.index');

    // API 路由
    Route::get('/api/geography', [StatisticsController::class, 'getGeographyData'])
        ->name('api.geography');
    Route::get('/api/time-analysis', [StatisticsController::class, 'getTimeAnalysisData'])
        ->name('api.time');

    // 匯出路由
    Route::get('/export/geography', [StatisticsController::class, 'exportGeographyReport'])
        ->name('export.geography');
    Route::get('/export/time-analysis', [StatisticsController::class, 'exportTimeReport'])
        ->name('export.time');
});
```

### 2.4 快取策略

- **快取鍵格式**: `statistics:{type}:{hash(filters)}`
- **快取時間**: 30 分鐘（可依需求調整）
- **快取清除**: 提供手動清除機制
- **範例實作**:
```php
$cacheKey = 'statistics:pickup_locations:' . md5(json_encode($request->all()));
return Cache::remember($cacheKey, now()->addMinutes(30), function () {
    // 查詢邏輯
});
```

### 2.5 資料庫索引建議

**現有索引已足夠**，先實作後測試效能。若查詢較慢，再考慮新增：
- `(pickup_county, pickup_district, ride_date)` - 上車地點分析
- `(dropoff_county, dropoff_district, ride_date)` - 下車地點分析
- `(created_at, ride_date)` - 提前預約分析

---

## 三、前端架構設計

### 3.1 頁面檔案結構

```
resources/views/statistics/
├── geography.blade.php              # 地理分析主頁面
├── time-analysis.blade.php          # 時間分析主頁面
└── components/
    ├── date-range-filter.blade.php  # 日期範圍篩選器
    ├── chart-card.blade.php         # 圖表卡片組件
    └── export-button.blade.php      # 匯出按鈕組件

public/js/statistics/
├── geography.js                     # 地理分析圖表邏輯
└── time-analysis.js                 # 時間分析圖表邏輯
```

### 3.2 圖表類型選擇

#### 地理分析圖表

| 統計項目 | 圖表類型 | Chart.js 類型 | 備註 |
|---------|---------|--------------|------|
| 上車區域統計 | 橫向長條圖（可滾動） | `bar` (horizontal) | 顯示全部區域 |
| 下車區域統計 | 橫向長條圖（可滾動） | `bar` (horizontal) | 顯示全部區域 |
| 跨縣市訂單統計 | 圓餅圖 | `pie` 或 `doughnut` | - |
| 區域路線統計 | 橫向長條圖（可滾動） | `bar` (horizontal) | 顯示全部路線 |

#### 時間分析圖表

| 統計項目 | 圖表類型 | Chart.js 類型 |
|---------|---------|--------------|
| 尖峰時段分析（24小時） | 折線圖 | `line` |
| 週間分布（週一～週日） | 直向長條圖 | `bar` (vertical) |
| 月份趨勢（12個月） | 折線圖 + 區域圖 | `line` with `fill` |
| 提前預約天數分布 | 直向長條圖 | `bar` (vertical) |

### 3.3 日期範圍篩選器

**快捷選項**:
- 今天、最近 7 天、**最近 30 天（預設）**、最近 90 天
- 本月、上月、今年

**自訂範圍**:
- 開始日期、結束日期（使用 `<input type="date">`）
- 驗證規則：結束日期 >= 開始日期，範圍不超過 1 年

**Alpine.js 實作**:
```javascript
function dateRangeFilter() {
    return {
        startDate: '',
        endDate: '',
        init() { this.setQuickRange('last30days'); },
        setQuickRange(range) { /* 計算日期並呼叫 applyFilter() */ },
        async applyFilter() { /* 呼叫 API 更新圖表 */ }
    }
}
```

### 3.4 導航選單整合

在 `resources/views/layouts/navigation.blade.php` 新增：

```
導航選單
├── ...現有選單...
└── 數據分析 ▼
    ├── 地理分析
    └── 時間分析
```

---

## 四、核心統計邏輯設計

### 4.1 地理與路線分析

#### 1. 上車區域統計（全部區域）

**Eloquent 查詢**:
```php
Order::selectRaw('
    pickup_county, pickup_district,
    COUNT(*) as order_count,
    COUNT(DISTINCT customer_id) as unique_customers
')
->whereBetween('ride_date', [$startDate, $endDate])
->whereIn('status', ['assigned', 'open', 'bkorder']) // 排除已取消
->where('is_main_order', true) // 避免共乘重複計算
->groupBy('pickup_county', 'pickup_district')
->orderByDesc('order_count')
->get();
```

**資料處理**: 合併縣市與區域為完整區域名稱（例如：新北市板橋區）

#### 2. 下車區域統計（全部區域）

邏輯同上車區域，將 `pickup_*` 改為 `dropoff_*`

#### 3. 跨縣市訂單統計

**查詢邏輯**:
```php
$crossCountyOrders = Order::where('pickup_county', '!=', 'dropoff_county')->count();
$sameCountyOrders = $totalOrders - $crossCountyOrders;
$crossCountyPercentage = ($crossCountyOrders / $totalOrders) * 100;
```

**回傳資料**:
- 總訂單數、跨縣市訂單數、同縣市訂單數、跨縣市百分比
- 前 5 名跨縣市路線組合

#### 4. 區域路線統計（全部路線）

**查詢邏輯**:
```php
Order::selectRaw('
    pickup_county, pickup_district,
    dropoff_county, dropoff_district,
    COUNT(*) as order_count
')
->whereBetween('ride_date', [$startDate, $endDate])
->whereIn('status', ['assigned', 'open', 'bkorder'])
->where('is_main_order', true)
->groupBy('pickup_county', 'pickup_district',
    'dropoff_county', 'dropoff_district')
->orderByDesc('order_count')
->get();
```

**顯示格式**: "新北市板橋區 → 台北市中正區"

### 4.2 時間模式分析

#### 1. 尖峰時段分析（0-23 小時）

**查詢邏輯**:
```php
Order::selectRaw('
    HOUR(ride_time) as hour,
    COUNT(*) as order_count
')
->whereBetween('ride_date', [$startDate, $endDate])
->groupBy('hour')
->orderBy('hour')
->get();
```

**資料處理**: 填補缺失的小時（確保 0-23 小時都有數據），識別尖峰時段前 3 名

#### 2. 週間分布（週一到週日）

**查詢邏輯**:
```php
Order::selectRaw('
    DAYOFWEEK(ride_date) as weekday,
    COUNT(*) as order_count
')
->whereBetween('ride_date', [$startDate, $endDate])
->groupBy('weekday')
->get();
```

**資料處理**: MySQL `DAYOFWEEK` 返回 1-7（1=週日），轉換為中文週名

#### 3. 月份趨勢（過去 12 個月）

**查詢邏輯**:
```php
Order::selectRaw('
    DATE_FORMAT(ride_date, "%Y-%m") as month,
    COUNT(*) as order_count,
    COUNT(CASE WHEN status = "assigned" THEN 1 END) as assigned_count
')
->whereBetween('ride_date', [$startDate, $endDate])
->groupBy('month')
->orderBy('month')
->get();
```

**資料處理**: 填補缺失月份，計算月成長率

#### 4. 提前預約分析

**查詢邏輯**:
```php
Order::selectRaw('
    DATEDIFF(ride_date, DATE(created_at)) as advance_days,
    COUNT(*) as order_count
')
->whereBetween('ride_date', [$startDate, $endDate])
->having('advance_days', '>=', 0)
->groupBy('advance_days')
->get();
```

**分類統計**:
- 當天預約（0 天）
- 3 天內（1-3 天）
- 7 天內（4-7 天）
- 7 天以上

---

## 五、報表匯出功能

### 5.1 Export 類別設計

**GeographyStatisticsExport**
- 位置: `app/Exports/GeographyStatisticsExport.php`
- 結構: 4 個工作表（上車地點、下車地點、跨縣市統計、熱門路線）

**TimeStatisticsExport**
- 位置: `app/Exports/TimeStatisticsExport.php`
- 結構: 4 個工作表（尖峰時段、週間分布、月份趨勢、提前預約）

### 5.2 檔案命名規則

```php
$filename = "地理分析報表_{$startDate}至{$endDate}.xlsx";
$filename = "時間分析報表_{$startDate}至{$endDate}.xlsx";
```

### 5.3 報表內容格式

**工作表範例（上車區域統計）**:

| 排名 | 上車區域 | 訂單數 | 獨特客戶數 |
|-----|---------|-------|----------|
| 1 | 新北市板橋區 | 1,250 | 345 |
| 2 | 新北市中和區 | 980 | 268 |
| 3 | 台北市中正區 | 756 | 189 |

---

## 六、實作步驟

### 階段一：後端基礎建設
1. ⬜ 建立 `GeographyAnalysisService.php`
2. ⬜ 建立 `TimeAnalysisService.php`
3. ⬜ 建立 `StatisticsController.php`
4. ⬜ 設定路由（`routes/web.php`）
5. ⬜ 測試 API 端點

### 階段二：前端頁面建置
6. ⬜ 建立 Blade 模板（geography.blade.php、time-analysis.blade.php）
7. ⬜ 建立組件（date-range-filter、chart-card、export-button）
8. ⬜ 引入 Chart.js CDN
9. ⬜ 建立 JavaScript 檔案（geography.js、time-analysis.js）
10. ⬜ 實作 Alpine.js 日期篩選器

### 階段三：數據展示與優化
11. ⬜ 實作地理分析 4 個圖表
12. ⬜ 實作時間分析 4 個圖表
13. ⬜ 實作快取機制
14. ⬜ 效能測試與優化

### 階段四：報表匯出功能
15. ⬜ 建立 `GeographyStatisticsExport.php`
16. ⬜ 建立 `TimeStatisticsExport.php`
17. ⬜ 測試 Excel 匯出功能

### 階段五：選單整合與測試
18. ⬜ 修改 `navigation.blade.php` 新增數據分析選單
19. ⬜ 全面測試（功能、效能、RWD）
20. ⬜ 程式碼格式化（`./vendor/bin/pint`）

---

## 七、關鍵檔案清單

### 必須建立的檔案（按優先順序）

1. **app/Services/GeographyAnalysisService.php**
2. **app/Services/TimeAnalysisService.php**
3. **app/Http/Controllers/StatisticsController.php**
4. **resources/views/statistics/geography.blade.php**
5. **resources/views/statistics/time-analysis.blade.php**
6. **resources/views/statistics/components/date-range-filter.blade.php**
7. **resources/views/statistics/components/chart-card.blade.php**
8. **resources/views/statistics/components/export-button.blade.php**
9. **public/js/statistics/geography.js**
10. **public/js/statistics/time-analysis.js**
11. **app/Exports/GeographyStatisticsExport.php**
12. **app/Exports/TimeStatisticsExport.php**

### 必須修改的檔案

1. **routes/web.php** - 新增統計路由群組
2. **resources/views/layouts/navigation.blade.php** - 新增數據分析選單

---

## 八、預期時間估計

| 階段 | 預計時間 |
|------|---------|
| 階段一：後端基礎建設 | 8-10 小時 |
| 階段二：前端頁面建置 | 10-12 小時 |
| 階段三：數據展示與優化 | 12-15 小時 |
| 階段四：報表匯出功能 | 6-8 小時 |
| 階段五：選單整合與測試 | 6-8 小時 |
| **總計** | **46-59 小時（約 6-8 個工作日）** |

---

## 九、注意事項

### 安全性
- ✅ 所有統計路由使用 `auth` 中介層保護
- ✅ 驗證所有輸入參數（日期格式、範圍合理性）
- ✅ 限制日期範圍不超過 1 年，避免惡意查詢

### 效能優化
- ✅ 地理統計按區域分組（提升查詢效能，減少資料量）
- ✅ 使用快取機制（30 分鐘）
- ✅ 先使用現有索引，必要時再新增
- ✅ 排除已取消訂單，只統計有效訂單
- ✅ 共乘訂單只計算主訂單（`is_main_order = true`）
- ✅ 前端圖表動態高度，超過容器時啟用滾動

### 使用者體驗
- ✅ 提供載入動畫
- ✅ 圖表支援 hover 互動
- ✅ 無數據時顯示友善提示
- ✅ 預設日期範圍為「最近 30 天」

### 擴展性
- ✅ Service 層設計便於新增其他分析維度
- ✅ 組件化設計便於新增圖表
- ✅ 統一的 API 回應格式

---

## 附錄：全部可實作的數據分析維度

以下是從 orders 資料表可以實作的完整分析維度清單，供未來擴展參考：

### 1. 訂單統計分析
數量趨勢、狀態分布、訂單類型、成長率、取消分析

### 2. 客戶行為分析
活躍客戶排名、客戶留存率、新增客戶趨勢、客戶分群

### 3. 司機與派遣分析
司機工作量、隊編統計、媒合效率、派遣率、排趟完成率

### 4. 需求與服務分析
輪椅需求、爬梯機需求、陪同人數分布、服務類型組合

### 5. 地理與路線分析 ✅ **（已實作）**
熱門上下車地點、跨區訂單、熱門路線 Top 10、地標使用統計

### 6. 時間模式分析 ✅ **（已實作）**
尖峰時段、週間分布、月份趨勢、節假日影響、提前預約分析

### 7. 共乘模式分析
共乘占比、群組規模、共乘解散率、共乘效益

### 8. 營運效率指標
訂單完成率、取消率、黑名單訂單、無車可派頻率、平均處理時間

---

## 十、修改歷史

### 2025-12-05 (2)：新增訂單來源篩選功能

#### 修改原因
為了讓使用者能夠依據訂單來源（新北長照、台北長照）查看不同的統計數據，提供更精準的數據分析能力。

#### 主要變更

**1. 新增篩選維度**
- **篩選欄位**: order_type（訂單來源）
- **可選值**: 全部、新北長照、台北長照
- **適用範圍**: 地理分析 + 時間分析兩個頁面的所有統計項目

**2. 後端修改**
- Order 模型新增 `ORDER_TYPES` 常數，集中管理訂單來源類型
- GeographyAnalysisService 的 4 個方法全部支援 order_type 篩選
- TimeAnalysisService 的 4 個方法全部支援 order_type 篩選
- StatisticsController 的 4 個方法新增 order_type 參數驗證
- 快取鍵更新：包含 order_type 參數，確保不同篩選條件的快取獨立

**3. 前端修改**
- 日期範圍篩選器新增「訂單來源」下拉選單
- 欄位配置調整為 4 個 col-md-3（開始日期、結束日期、訂單來源、查詢按鈕）
- Alpine.js 組件新增 orderType 資料屬性
- API 請求和匯出 URL 都包含 order_type 參數

#### 修改檔案清單

**後端檔案（4 個）**
1. `app/Models/Order.php`
   - 新增 ORDER_TYPES 常數：`['新北長照', '台北長照']`

2. `app/Services/GeographyAnalysisService.php`
   - 4 個方法的快取鍵加入 order_type
   - 每個方法新增條件篩選：`if ($request->filled('order_type')) { $query->where('order_type', $request->order_type); }`

3. `app/Services/TimeAnalysisService.php`
   - 4 個方法的快取鍵加入 order_type
   - 每個方法新增條件篩選邏輯

4. `app/Http/Controllers/StatisticsController.php`
   - 4 個方法新增驗證規則：`'order_type' => 'nullable|string|in:'.implode(',', \App\Models\Order::ORDER_TYPES)`

**前端檔案（3 個）**
5. `resources/views/statistics/components/date-range-filter.blade.php`
   - 新增訂單來源下拉選單
   - 欄位配置從 5-5-2 調整為 3-3-3-3

6. `public/js/statistics/geography.js`
   - Alpine.js 組件新增 orderType 資料屬性
   - API 請求 URL 加入 order_type 參數
   - 匯出 URL 加入 order_type 參數

7. `public/js/statistics/time-analysis.js`
   - 進行相同的修改，確保兩個頁面功能一致

#### 查詢邏輯變更

**快取鍵更新**（以上車區域統計為例）：
```php
// 修改前
$cacheKey = 'statistics:pickup_locations:'.md5(json_encode($request->only(['start_date', 'end_date']))).":{$limitKey}";

// 修改後
$cacheKey = 'statistics:pickup_locations:'.md5(json_encode($request->only(['start_date', 'end_date', 'order_type']))).":{$limitKey}";
```

**條件篩選邏輯**：
```php
// 篩選訂單來源
if ($request->filled('order_type')) {
    $query->where('order_type', $request->order_type);
}
```

#### 前端篩選器格式

**修改前**:
| 開始日期 (col-md-5) | 結束日期 (col-md-5) | 查詢按鈕 (col-md-2) |

**修改後**:
| 開始日期 (col-md-3) | 結束日期 (col-md-3) | 訂單來源 (col-md-3) | 查詢按鈕 (col-md-3) |

#### API 參數變更

**所有統計 API 端點現在接受 3 個參數**：
- `start_date` (必填)
- `end_date` (必填)
- `order_type` (可選)

**驗證規則**：
```php
$validated = $request->validate([
    'start_date' => 'required|date',
    'end_date' => 'required|date|after_or_equal:start_date',
    'order_type' => 'nullable|string|in:新北長照,台北長照',
]);
```

#### 快取策略影響
- 不同 order_type 的查詢結果會產生獨立的快取
- 快取鍵格式：`statistics:{type}:{hash(start_date,end_date,order_type)}:{limit}`
- 快取時間維持 30 分鐘不變

#### 效能影響
- 查詢效能：新增一個 WHERE 條件，影響極小
- 快取效能：不同篩選條件的快取獨立管理，提升使用者體驗
- 資料量：依訂單來源篩選後，單次查詢的資料量減少

#### 使用者體驗改善
- 可以分別查看「新北長照」和「台北長照」的統計數據
- 預設為「全部」，顯示所有訂單來源的統計
- 切換訂單來源時，圖表即時更新
- Excel 匯出包含當前篩選條件

#### 注意事項
1. 已執行 `php artisan cache:clear` 清除舊快取
2. 已執行 `./vendor/bin/pint` 程式碼格式化
3. Order 模型的 ORDER_TYPES 常數作為單一真實來源（Single Source of Truth）
4. 前端和後端驗證都使用這個常數，確保一致性

---

### 2025-12-05 (1)：地理統計改為區域級別

#### 修改原因
為了提供更清晰的區域分布統計，將原本按「完整地址」的統計改為按「區域」（縣市+區域）統計。

#### 主要變更

**1. 統計範圍調整**
- **原本**: 按完整地址分組，顯示 Top 10
- **修改後**: 按縣市+區域分組，顯示全部區域
- **影響範圍**: 上車地點、下車地點、路線統計

**2. 顯示格式變更**
- **原本**: 板橋區 XX路100號
- **修改後**: 新北市板橋區
- **路線格式**: 新北市板橋區 → 台北市中正區

**3. 前端圖表優化**
- 實作動態高度計算：`Math.max(450, dataCount * 25)`
- 每筆資料佔用 25px 高度
- 容器固定 450px，超過時啟用垂直滾動

#### 修改檔案清單

**後端檔案（4 個）**
1. `app/Services/GeographyAnalysisService.php`
   - 移除 `pickup_address` 和 `dropoff_address` 欄位
   - 移除 Top 10 限制（`limit(10)`）
   - 移除 `extractKeyAddress()` 方法
   - 回傳格式改為 `area: '新北市板橋區'`

2. `app/Exports/PickupLocationsSheet.php`
   - 移除「完整地址」欄位
   - 標題改為「上車區域統計」

3. `app/Exports/DropoffLocationsSheet.php`
   - 移除「完整地址」欄位
   - 標題改為「下車區域統計」

4. `app/Exports/PopularRoutesSheet.php`
   - 移除「完整路線」欄位
   - 標題改為「區域路線統計」

**前端檔案（3 個）**
5. `public/js/statistics/geography.js`
   - 實作動態高度計算
   - 資料映射從 `display_name` 改為 `area`
   - 3 個圖表函數都已更新

6. `resources/views/statistics/components/chart-card.blade.php`
   - 加入 `overflow-y: auto` 支援滾動

7. `resources/views/statistics/geography.blade.php`
   - 圖表標題更新為「上車區域統計」、「下車區域統計」、「區域路線統計」
   - Tooltip 文字更新

#### 查詢邏輯變更

**修改前**:
```php
Order::selectRaw('
    pickup_county, pickup_district, pickup_address,
    COUNT(*) as order_count,
    COUNT(DISTINCT customer_id) as unique_customers
')
->groupBy('pickup_county', 'pickup_district', 'pickup_address')
->orderByDesc('order_count')
->limit(10)
->get();
```

**修改後**:
```php
Order::selectRaw('
    pickup_county, pickup_district,
    COUNT(*) as order_count,
    COUNT(DISTINCT customer_id) as unique_customers
')
->groupBy('pickup_county', 'pickup_district')
->orderByDesc('order_count')
->get();
```

#### Excel 報表格式變更

**修改前**:
| 排名 | 上車地點 | 完整地址 | 訂單數 | 獨特客戶數 |

**修改後**:
| 排名 | 上車區域 | 訂單數 | 獨特客戶數 |

#### 效能影響
- 區域統計的資料量比地址統計少很多（預估 50-200 筆 vs 數千筆）
- 查詢效能提升（減少 GROUP BY 欄位）
- 前端渲染效能略微下降（顯示更多資料），但仍在可接受範圍
- 快取鍵自動更新（因查詢欄位不同）

#### 注意事項
1. 已執行 `php artisan cache:clear` 清除舊快取
2. 已執行 `./vendor/bin/pint` 程式碼格式化
3. 同一區域的所有訂單會被合併統計
4. 獨特客戶數計算保持不變（COUNT DISTINCT）
