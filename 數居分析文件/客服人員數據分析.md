# 客服人員數據分析－問題紀錄

- 版本：1.1
- 更新日期：2025-12-05

---

## 背景
2025-12-05 客服統計頁篩選查詢回傳 500，瀏覽器 Network response 顯示 SQL error（same_day_orders 別名）。

## 錯誤訊息
```json
{
  "error": "查詢統計數據時發生錯誤",
  "message": "SQLSTATE[42S22]: Column not found: 1247 Reference 'same_day_orders' not supported (reference to group function) (Connection: mysql, SQL: select created_by, SUM(CASE WHEN DATE(ride_date) = DATE(created_at) THEN 1 ELSE 0 END) as same_day_orders, SUM(CASE WHEN DATE(ride_date) > DATE(created_at) THEN 1 ELSE 0 END) as advance_orders from `orders` where `created_at` between 2025-11-05 and 2025-12-05 and `created_by` is not null group by `created_by` order by same_day_orders + advance_orders desc)"
}
```

## 原因
- MySQL 啟用 ONLY_FULL_GROUP_BY 時，ORDER BY 直接使用聚合欄位別名（same_day_orders + advance_orders）會被視為「對聚合函式的引用」，不被接受。

## 處理方式
1) `app/Services/CustomerServiceAnalysisService::getOrderTypesByUser`
   - 排序改用 SUM 表達式本身，不再用別名，避免 MySQL 解析錯誤。
2) `app/Http/Controllers/StatisticsController::getCustomerServiceData`
   - catch 區塊新增 `Log::error`，紀錄 message、trace、request 參數，方便之後排查。

## 預防建議
- 聚合查詢的 ORDER BY 盡量用原始表達式或包外層子查詢，不要直接用彙總別名，確保在 ONLY_FULL_GROUP_BY 環境下可用。
- 統計／報表 API 的例外處理要記錄詳細錯誤與請求參數，避免靜默 500。
- 若升級 MySQL 或調整 sql_mode，先檢查聚合/排序語句相容性。

## 驗證
- 客服統計頁重新查詢，API 200，圖表正常顯示。
- `storage/logs/laravel.log` 無新的 error；若有，訊息應包含 request 與 trace，便於追蹤。
