# LC Management 系統修改調整記錄

**修改日期：** 2025-08-17  
**修改內容：** 客戶備註編輯功能 + 駕駛資訊分離功能 + 卡片摺疊功能 + 日期地點重複檢查功能

---

## 🎯 功能一：客戶備註編輯功能

### 修改目的
在客戶搜尋組件中新增快速編輯客戶備註的功能，無需進入完整編輯頁面。

### 修改檔案

#### 1. 後端控制器
**檔案：** `app/Http/Controllers/CustomerController.php`
- **新增方法：** `updateNote(Request $request, Customer $customer)`
- **功能：** 處理客戶備註的 AJAX 更新請求
- **驗證：** 備註最多1000字
- **返回：** JSON 格式響應

#### 2. 路由設定
**檔案：** `routes/web.php`
- **新增路由：** `PATCH /customers/{customer}/note`
- **命名：** `customers.updateNote`

#### 3. 前端視圖
**檔案：** `resources/views/orders/components/customer-search.blade.php`
- **新增：** 備註編輯按鈕（第130-135行）
- **新增：** 備註編輯 Modal（第147-175行）
- **功能：** 點擊編輯按鈕開啟 Modal 編輯備註

#### 4. JavaScript 功能
**檔案：** `public/js/orders/index.js`
- **新增函數：** `updateCustomerNote(customerId)`
- **功能：** AJAX 提交備註更新，即時更新頁面顯示
- **特色：** 載入狀態、錯誤處理、成功提示

### 使用方式
1. 在訂單頁面搜尋客戶
2. 當搜尋到單一客戶時，在備註欄位旁會出現編輯按鈕
3. 點擊編輯按鈕開啟 Modal 視窗
4. 編輯備註後點擊「儲存」即可更新

---

## 🎯 功能二：駕駛資訊分離功能

### 修改目的
將原本單一駕駛欄位改為去程駕駛和回程駕駛分離管理，回程訂單可指派不同駕駛或不指派駕駛。

### 修改檔案

#### 1. 前端表單結構
**檔案：** `resources/views/orders/components/order-form.blade.php`
- **修改區域：** 駕駛資訊區塊（第417-507行）
- **新結構：**
  - 去程駕駛區塊（driver_*）
  - 回程駕駛區塊（return_driver_*）
  - 複製去程駕駛按鈕

#### 2. 後端邏輯
**檔案：** `app/Http/Controllers/OrderController.php`

##### 2.1 createReturnOrder 方法修改
- **位置：** 第853-896行
- **新邏輯：**
  - 檢查是否有填入回程駕駛資訊
  - 有填入：使用回程駕駛資訊
  - 沒填入：駕駛欄位保持為空

##### 2.2 表單驗證更新
- **位置：** 第134-138行
- **新增驗證：**
  - `return_driver_id` (nullable|integer)
  - `return_driver_name` (nullable|string)
  - `return_driver_plate_number` (nullable|string)
  - `return_driver_fleet_number` (nullable|string)

#### 3. 共乘服務更新
**檔案：** `app/Services/CarpoolGroupService.php`

##### 3.1 createReturnOrders 方法
- **位置：** 第136-178行
- **新增：** 回程駕駛資訊處理邏輯

##### 3.2 prepareOrderData 方法
- **位置：** 第245-249行
- **新增：** 駕駛資訊處理

#### 4. JavaScript 功能增強
**檔案：** `public/js/orders/form.js`

##### 4.1 bindDriverEvents 方法更新
- **位置：** 第90-124行
- **新功能：**
  - 支援兩組駕駛搜尋按鈕
  - 複製去程駕駛功能

##### 4.2 handleDriverSearch 方法更新
- **位置：** 第331-362行
- **新增參數：** `type = 'outbound'`
- **支援：** 去程('outbound') 和回程('return') 駕駛搜尋

##### 4.3 handleDriverClear 方法更新
- **位置：** 第367-382行
- **新增參數：** `type = 'outbound'`
- **功能：** 分別清除去程或回程駕駛資訊

##### 4.4 新增方法
- **handleCopyOutboundDriver：** 複製去程駕駛到回程（第387-404行）
- **handleReturnDriverFleetInput：** 回程駕駛隊編輸入處理（第423-431行）

### 資料流程
1. **單日訂單（無回程）：** 只處理去程駕駛欄位
2. **往返訂單（有回程）：**
   - 去程訂單：使用表單的去程駕駛資訊 → 寫入 driver_* 欄位
   - 回程訂單：使用表單的回程駕駛資訊 → 寫入 driver_* 欄位
3. **共乘訂單：** 每個成員的去程/回程訂單分別處理駕駛資訊

### 使用方式
1. **去程駕駛：** 填入駕駛隊編進行搜尋，或手動輸入
2. **回程駕駛：** 可選填，留空則回程訂單不指派駕駛
3. **快速複製：** 點擊「複製去程駕駛」按鈕快速填入相同駕駛

---

## 🎯 功能三：卡片摺疊功能

### 修改目的
為表單的各個區塊新增開合功能，提升頁面整潔度和用戶體驗。

### 修改檔案
**檔案：** `resources/views/orders/components/order-form.blade.php`

#### 修改的區塊

##### 1. 共乘資訊區塊
- **card-header：** 第361-368行
  - 新增 `data-bs-toggle="collapse"`
  - 新增 `data-bs-target="#carpoolInfoCollapse"`
  - 新增箭頭圖示和點擊樣式
- **card-body：** 第370行
  - 包裝在 `<div class="collapse class" id="carpoolInfoCollapse">`

##### 2. 駕駛資訊區塊
- **card-header：** 第419-426行
  - 新增 `data-bs-toggle="collapse"`
  - 新增 `data-bs-target="#driverInfoCollapse"`
  - 新增箭頭圖示和點擊樣式
- **card-body：** 第428行
  - 包裝在 `<div class="collapse class" id="driverInfoCollapse">`

### 技術實作
- **框架：** Bootstrap 5 Collapse 組件
- **觸發方式：** 點擊 card-header
- **預設狀態：** 展開 (class="collapse show")
- **視覺提示：** 箭頭圖示 + cursor: pointer

### 使用方式
點擊卡片標題即可展開或收合該區塊的內容。

---

## 📋 檔案修改總覽

### 後端檔案
1. `app/Http/Controllers/CustomerController.php` - 新增客戶備註更新功能
2. `app/Http/Controllers/OrderController.php` - 修改回程訂單建立邏輯、表單驗證 + 新增日期地點重複檢查 API
3. `app/Services/CarpoolGroupService.php` - 支援回程駕駛資訊處理
4. `routes/web.php` - 新增客戶備註更新路由 + 日期地點重複檢查路由

### 前端檔案
1. `resources/views/orders/components/customer-search.blade.php` - 新增備註編輯功能
2. `resources/views/orders/components/order-form.blade.php` - 駕駛資訊分離 + 卡片摺疊功能
3. `public/js/orders/index.js` - 客戶備註 AJAX 更新功能
4. `public/js/orders/form.js` - 駕駛搜尋功能增強 + 日期地點重複檢查功能

---

## 🔧 技術特點

### 向下相容性
- **無資料庫變更：** 使用現有欄位結構
- **現有功能保持：** 所有原有功能正常運作
- **共乘邏輯完整：** 共乘功能完全支援新的駕駛分離邏輯

### 用戶體驗
- **AJAX 無刷新：** 備註更新不需重新載入頁面
- **即時反饋：** 操作成功/失敗的即時提示
- **操作便利：** 複製駕駛、卡片摺疊等便利功能
- **錯誤處理：** 完整的前後端錯誤處理機制

### 程式碼品質
- **模組化設計：** 功能拆分清楚，易於維護
- **錯誤處理：** 完整的異常處理和用戶提示
- **程式碼複用：** JavaScript 函數支援參數化，減少重複代碼

---

## 🧪 測試確認

### 語法檢查
- ✅ PHP 語法檢查通過
- ✅ JavaScript 語法檢查通過
- ✅ Vite 建置成功

### 功能測試
- ✅ 客戶備註編輯功能
- ✅ 去程/回程駕駛分離功能
- ✅ 共乘訂單駕駛分離
- ✅ 卡片摺疊功能
- ✅ 日期地點重複檢查功能
- ✅ 表單驗證正常

---

## 📝 使用說明

### 客戶備註編輯
1. 在訂單頁面搜尋客戶
2. 點擊備註旁的編輯按鈕
3. 在 Modal 中編輯備註
4. 點擊儲存即時更新

### 駕駛資訊分離
1. **去程駕駛：** 在「去程駕駛」區塊填入駕駛資訊
2. **回程駕駛：** 在「回程駕駛」區塊填入駕駛資訊（可選）
3. **快速複製：** 點擊「複製去程駕駛」快速填入
4. **訂單建立：** 系統會根據填入的資訊分別處理去程和回程訂單

### 卡片摺疊
點擊卡片標題即可展開或收合內容，提升頁面整潔度。

### 日期地點重複檢查
1. **即時檢查：** 填入客戶、日期、上車地址時自動檢查
2. **初始檢查：** 編輯訂單或複製歷史訂單時自動檢查
3. **警告提示：** 發現重複時在下車地址下方顯示警告
4. **智能判斷：** 空白新建訂單不會觸發檢查

---

## 🎯 功能四：日期地點重複檢查功能

### 修改目的
新增檢查客戶在相同日期和相同上車地點是否已有訂單的功能，防止重複建立相同地點的訂單。

### 修改檔案

#### 1. 後端 API 開發
**檔案：** `app/Http/Controllers/OrderController.php`
- **新增方法：** `checkDatePickupDuplicate(Request $request)`（第683-719行）
- **功能：** 檢查 customer_id + ride_date + pickup_address 的重複組合
- **驗證：** customer_id, ride_date, pickup_address, order_id(編輯模式)
- **返回：** JSON 格式響應，包含重複狀態和現有訂單資訊

#### 2. 路由設定
**檔案：** `routes/web.php`
- **新增路由：** `POST /orders/check-date-pickup-duplicate`（第58行）
- **命名：** `orders.checkDatePickupDuplicate`

#### 3. 前端 JavaScript 功能
**檔案：** `public/js/orders/form.js`

##### 3.1 事件綁定
- **位置：** 第67-75行
- **功能：** 監聽 ride_date 和 pickup_address 輸入框的 change/blur 事件

##### 3.2 檢查方法
- **新增方法：** `checkDatePickupDuplicate()`（第1213-1290行）
- **功能：** 發送 AJAX 請求檢查重複
- **特色：** 完整除錯記錄、錯誤處理

##### 3.3 顯示方法
- **showDatePickupWarning()：** 顯示重複警告（第1351-1378行）
- **showDatePickupSuccess()：** 顯示可用提示（第1383-1409行）
- **clearDatePickupWarning()：** 清除警告（第1412-1415行）

##### 3.4 初始檢查
- **新增方法：** `performInitialDatePickupCheck()`（第1420-1443行）
- **功能：** 頁面載入時自動檢查（僅在有完整資料時）
- **調用位置：** init() 方法中（第25行）

### 技術特點

#### 檢查邏輯
- **檢查條件：** customer_id + ride_date + pickup_address 組合
- **觸發時機：** 使用者輸入時 + 頁面載入時（有資料時）
- **編輯支援：** 編輯訂單時排除當前訂單

#### 顯示位置
- **警告位置：** 下車地址欄位下方
- **樣式：** 仿照現有重複檢查的 alert 樣式
- **獨立運作：** 與現有時間重複檢查並行，互不干擾

#### 智能判斷
- **初始檢查：** 只在有完整資料（客戶、日期、地址）時執行
- **編輯模式：** 自動排除當前訂單，避免誤報
- **地址驗證：** 地址長度至少3個字元才執行檢查

### 使用方式

#### 即時檢查
1. 填入客戶資訊
2. 選擇用車日期
3. 輸入上車地址
4. 系統自動檢查並顯示結果

#### 初始檢查
- 編輯現有訂單時自動檢查
- 複製歷史訂單時自動檢查
- 空白新建訂單時跳過檢查

### 錯誤處理
- **前端驗證：** 檢查必要欄位完整性
- **後端驗證：** 資料格式和類型驗證
- **AJAX 錯誤：** 完整錯誤記錄和用戶提示
- **網路問題：** 自動清除警告狀態