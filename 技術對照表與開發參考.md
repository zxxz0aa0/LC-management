# 訂單管理系統 - 技術對照表與開發參考

## 📋 文件目的

本文件提供外部系統開發人員詳細的技術參考資料，確保生成的 Excel 檔案能被訂單管理系統正確匯入。

---

## 🎯 欄位技術對照表

### 完整欄位對照 (A-N 欄，共 14 欄)

| Excel 欄位 | 欄位索引 | 中文名稱 | 英文欄位名 | 資料型別 | 驗證規則 | 預設值 | 說明 |
|------------|---------|----------|-----------|---------|----------|---------|------|
| **A** | `row[0]` | 訂單編號 | `order_code` | string | required, unique | - | 系統唯一識別碼 |
| **B** | `row[1]` | 姓名 | `name` | string | required | - | 乘客姓名 |
| **C** | `row[2]` | 電話 | `phone` | string | required | - | 聯絡電話 |
| **D** | `row[3]` | 編號 | `unit_number` | string | required | - | 內部編號或案號 |
| **E** | `row[4]` | 類型 | `type` | string | required | - | 訂單類型分類 |
| **F** | `row[5]` | 日期 | `date` | date | required | - | 車趟日期，支援多種格式 |
| **G** | `row[6]` | 時間 | `time` | time | required | - | 車趟時間 HH:MM |
| **H** | `row[7]` | 上車區 | `origin_area` | string | required | - | 上車區域 |
| **I** | `row[8]` | 上車地址 | `origin_address` | string | required | - | 詳細上車地址 |
| **J** | `row[9]` | 下車區 | `dest_area` | string | required | - | 下車區域 |
| **K** | `row[10]` | 下車地址 | `dest_address` | string | required | - | 詳細下車地址 |
| **L** | `row[11]` | 備註 | `remark` | string | nullable | `''` | 額外說明 |
| **M** | `row[12]` | 隊員編號 | `assigned_user_id` | string | nullable, max:255 | `null` | 駕駛員編號 |
| **N** | `row[13]` | 特殊狀態 | `special_status` | string | nullable | `null` | 特殊標記 |

---

## 🔧 Laravel 驗證規則對應

### 系統內部驗證邏輯

```php
// OrderController.php 的驗證規則
$validator = Validator::make([
    'order_code' => $row[0] ?? null,           // A 欄：訂單編號
    'name' => $row[1] ?? null,                 // B 欄：姓名
    'phone' => $row[2] ?? null,                // C 欄：電話
    'unit_number' => $row[3] ?? null,          // D 欄：編號
    'type' => $row[4] ?? null,                 // E 欄：類型
    'date' => $date,                           // F 欄：日期 (經過轉換)
    'time' => $row[6] ?? null,                 // G 欄：時間
    'origin_area' => $row[7] ?? null,          // H 欄：上車區
    'origin_address' => $row[8] ?? null,       // I 欄：上車地址
    'dest_area' => $row[9] ?? null,            // J 欄：下車區
    'dest_address' => $row[10] ?? null,        // K 欄：下車地址
    'remark' => $row[11] ?? '',                // L 欄：備註
    'assigned_user_id' => $row[12],            // M 欄：隊員編號
    'special_status' => $row[13] ?? null,      // N 欄：特殊狀態
], [
    'order_code' => 'required|string|unique:orders,order_code',
    'name' => 'required|string',
    'phone' => 'required|string',
    'unit_number' => 'required|string',
    'type' => 'required|string',
    'date' => 'required|date',
    'time' => 'required',
    'origin_area' => 'required|string',
    'origin_address' => 'required|string',
    'dest_area' => 'required|string',
    'dest_address' => 'required|string',
    'assigned_user_id' => 'nullable|string|max:255',
    'special_status' => 'nullable|string',
]);
```

---

## 📅 日期轉換邏輯

### 系統支援的日期格式處理

系統使用兩層日期轉換邏輯：

```php
// 第一層：Excel 數字日期轉換
if (is_numeric($rawDate)) {
    try {
        $date = ExcelDate::excelToDateTimeObject($rawDate)->format('Y-m-d');
    } catch (\Exception $e) {
        $date = null;
    }
}

// 第二層：文字日期轉換
elseif (!empty($rawDate)) {
    try {
        $date = Carbon::parse($rawDate)->format('Y-m-d');
    } catch (\Exception $e) {
        $date = null;
    }
}
```

### 外部系統建議實作

```php
// PHP 範例：生成相容的日期格式
function formatDateForImport($date) {
    // 方法 1：使用 Excel 數字格式（推薦）
    return \PhpOffice\PhpSpreadsheet\Shared\Date::PHPToExcel($date);
    
    // 方法 2：使用 ISO 字串格式
    return date('Y-m-d', strtotime($date));
}
```

---

## ⚡ 狀態自動判定邏輯

### 系統內建狀態設定規則

```php
// 根據隊員編號自動判定訂單狀態
'status' => !empty($row[12]) ? 'assigned' : 'open',
'assigned_user_id' => $row[12] ?? null,
```

### 狀態對應表

| 隊員編號欄位值 | 系統設定狀態 | 中文顯示 |
|---------------|-------------|----------|
| 有值 (如："D001") | `assigned` | 已指派 |
| 空值或 null | `open` | 待搢單 |

---

## 🗂️ 資料庫欄位對應

### Orders 資料表欄位結構

```sql
-- 基於 orders 資料表結構的欄位對應
CREATE TABLE `orders` (
    `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
    `order_code` varchar(255) NOT NULL,      -- Excel A 欄
    `date` date NOT NULL,                    -- Excel F 欄
    `time` time NOT NULL,                    -- Excel G 欄
    `origin_area` varchar(255) NOT NULL,     -- Excel H 欄
    `origin_address` varchar(255) NOT NULL,  -- Excel I 欄
    `dest_area` varchar(255) NOT NULL,       -- Excel J 欄
    `dest_address` varchar(255) NOT NULL,    -- Excel K 欄
    `remark` text,                           -- Excel L 欄
    `assigned_user_id` bigint(20) unsigned, -- Excel M 欄
    `status` enum('open','assigned','completed') DEFAULT 'open',
    `created_at` timestamp NULL DEFAULT NULL,
    `updated_at` timestamp NULL DEFAULT NULL,
    UNIQUE KEY `orders_order_code_unique` (`order_code`)
);
```

### 擴展欄位 (Model 層新增)

```php
// Order.php Model 的 fillable 屬性
protected $fillable = [
    'name',                  // Excel B 欄 - 透過 Model 層處理
    'phone',                 // Excel C 欄 - 透過 Model 層處理
    'unit_number',           // Excel D 欄 - 透過 Model 層處理
    'type',                  // Excel E 欄 - 透過 Model 層處理
    'special_status',        // Excel N 欄 - 透過 Model 層處理
    // ... 其他欄位
];
```

---

## 💻 完整程式碼範例

### PHP + PhpSpreadsheet 範例

```php
<?php
use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;

function generateOrdersExcel($orders, $filename = '訂單匯入.xlsx') {
    $spreadsheet = new Spreadsheet();
    $sheet = $spreadsheet->getActiveSheet();
    
    // 設定標題列（第1行）
    $headers = [
        'A1' => '訂單編號',    // row[0]
        'B1' => '姓名',        // row[1]
        'C1' => '電話',        // row[2]
        'D1' => '編號',        // row[3]
        'E1' => '類型',        // row[4]
        'F1' => '日期',        // row[5]
        'G1' => '時間',        // row[6]
        'H1' => '上車區',      // row[7]
        'I1' => '上車地址',    // row[8]
        'J1' => '下車區',      // row[9]
        'K1' => '下車地址',    // row[10]
        'L1' => '備註',        // row[11]
        'M1' => '隊員編號',    // row[12]
        'N1' => '特殊狀態'     // row[13]
    ];
    
    foreach ($headers as $cell => $value) {
        $sheet->setCellValue($cell, $value);
    }
    
    // 填入資料（從第2行開始）
    $row = 2;
    foreach ($orders as $order) {
        $sheet->setCellValue("A{$row}", $order['order_code']);
        $sheet->setCellValue("B{$row}", $order['name']);
        $sheet->setCellValue("C{$row}", $order['phone']);
        $sheet->setCellValue("D{$row}", $order['unit_number']);
        $sheet->setCellValue("E{$row}", $order['type']);
        
        // 日期格式化 - 重要！
        $sheet->setCellValue("F{$row}", $order['date']); // YYYY-MM-DD
        
        // 時間格式化 - 重要！
        $timeFormatted = date('H:i', strtotime($order['time']));
        $sheet->setCellValue("G{$row}", $timeFormatted);
        
        $sheet->setCellValue("H{$row}", $order['origin_area']);
        $sheet->setCellValue("I{$row}", $order['origin_address']);
        $sheet->setCellValue("J{$row}", $order['dest_area']);
        $sheet->setCellValue("K{$row}", $order['dest_address']);
        $sheet->setCellValue("L{$row}", $order['remark'] ?? '');
        $sheet->setCellValue("M{$row}", $order['assigned_user_id'] ?? '');
        $sheet->setCellValue("N{$row}", $order['special_status'] ?? '');
        
        $row++;
    }
    
    // 儲存檔案
    $writer = new Xlsx($spreadsheet);
    $writer->save($filename);
    
    return $filename;
}

// 使用範例
$orders = [
    [
        'order_code' => 'ORD20250824001',
        'name' => '王小明',
        'phone' => '0912345678',
        'unit_number' => 'A001',
        'type' => '新北長照',
        'date' => '2025-08-24',
        'time' => '14:30:00',
        'origin_area' => '板橋區',
        'origin_address' => '民族路100號',
        'dest_area' => '新莊區',
        'dest_address' => '中正路200號',
        'remark' => '輪椅乘客',
        'assigned_user_id' => '',        // 空值 = 待搶單
        'special_status' => '優先'
    ]
];

$filename = generateOrdersExcel($orders);
echo "Excel 檔案已生成：{$filename}";
```

### Node.js + ExcelJS 範例

```javascript
const ExcelJS = require('exceljs');

async function generateOrdersExcel(orders, filename = '訂單匯入.xlsx') {
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('訂單資料');
    
    // 設定標題列
    const headers = [
        '訂單編號', '姓名', '電話', '編號', '類型', '日期', '時間',
        '上車區', '上車地址', '下車區', '下車地址', '備註', '隊員編號', '特殊狀態'
    ];
    
    worksheet.addRow(headers);
    
    // 新增資料列
    orders.forEach(order => {
        worksheet.addRow([
            order.order_code,           // A 欄 row[0]
            order.name,                 // B 欄 row[1]
            order.phone,                // C 欄 row[2]
            order.unit_number,          // D 欄 row[3]
            order.type,                 // E 欄 row[4]
            order.date,                 // F 欄 row[5] - YYYY-MM-DD
            order.time.substring(0, 5), // G 欄 row[6] - HH:MM
            order.origin_area,          // H 欄 row[7]
            order.origin_address,       // I 欄 row[8]
            order.dest_area,            // J 欄 row[9]
            order.dest_address,         // K 欄 row[10]
            order.remark || '',         // L 欄 row[11]
            order.assigned_user_id || '', // M 欄 row[12]
            order.special_status || ''  // N 欄 row[13]
        ]);
    });
    
    // 儲存檔案
    await workbook.xlsx.writeFile(filename);
    return filename;
}
```

### Python + openpyxl 範例

```python
from openpyxl import Workbook
from datetime import datetime

def generate_orders_excel(orders, filename='訂單匯入.xlsx'):
    wb = Workbook()
    ws = wb.active
    ws.title = '訂單資料'
    
    # 設定標題列
    headers = [
        '訂單編號', '姓名', '電話', '編號', '類型', '日期', '時間',
        '上車區', '上車地址', '下車區', '下車地址', '備註', '隊員編號', '特殊狀態'
    ]
    
    for col, header in enumerate(headers, 1):
        ws.cell(row=1, column=col, value=header)
    
    # 新增資料列
    for row_idx, order in enumerate(orders, 2):
        data = [
            order.get('order_code'),           # A 欄 row[0]
            order.get('name'),                 # B 欄 row[1]
            order.get('phone'),                # C 欄 row[2]
            order.get('unit_number'),          # D 欄 row[3]
            order.get('type'),                 # E 欄 row[4]
            order.get('date'),                 # F 欄 row[5] - YYYY-MM-DD
            order.get('time', '')[:5],         # G 欄 row[6] - HH:MM
            order.get('origin_area'),          # H 欄 row[7]
            order.get('origin_address'),       # I 欄 row[8]
            order.get('dest_area'),            # J 欄 row[9]
            order.get('dest_address'),         # K 欄 row[10]
            order.get('remark', ''),           # L 欄 row[11]
            order.get('assigned_user_id', ''), # M 欄 row[12]
            order.get('special_status', '')    # N 欄 row[13]
        ]
        
        for col_idx, value in enumerate(data, 1):
            ws.cell(row=row_idx, column=col_idx, value=value)
    
    wb.save(filename)
    return filename

# 使用範例
orders = [{
    'order_code': 'ORD20250824001',
    'name': '王小明',
    'phone': '0912345678',
    'unit_number': 'A001',
    'type': '新北長照',
    'date': '2025-08-24',
    'time': '14:30',
    'origin_area': '板橋區',
    'origin_address': '民族路100號',
    'dest_area': '新莊區',
    'dest_address': '中正路200號',
    'remark': '輪椅乘客',
    'assigned_user_id': '',     # 空值 = 待搶單狀態
    'special_status': '優先'
}]

filename = generate_orders_excel(orders)
print(f'Excel 檔案已生成：{filename}')
```

---

## 🧪 資料驗證測試

### 必填欄位測試

```php
// 測試必填欄位
$testCases = [
    'order_code' => ['', 'ORD001'],      // 空值會失敗
    'name' => ['', '王小明'],            // 空值會失敗
    'phone' => ['', '0912345678'],       // 空值會失敗
    'unit_number' => ['', 'A001'],       // 空值會失敗
    'type' => ['', '新北長照'],          // 空值會失敗
    'date' => ['', '2025-08-24'],        // 空值會失敗
    'time' => ['', '14:30'],             // 空值會失敗
    'origin_area' => ['', '板橋區'],     // 空值會失敗
    'origin_address' => ['', '民族路'],  // 空值會失敗
    'dest_area' => ['', '新莊區'],       // 空值會失敗
    'dest_address' => ['', '中正路'],    // 空值會失敗
];
```

### 選填欄位測試

```php
// 測試選填欄位
$optionalFields = [
    'remark' => ['', '輪椅乘客', null],           // 允許空值
    'assigned_user_id' => ['', 'D001', null],    // 允許空值
    'special_status' => ['', '優先', null]        // 允許空值
];
```

---

## ⚠️ 常見錯誤與解決方案

### 1. 訂單編號重複錯誤

**錯誤訊息**：`The order code has already been taken.`

**解決方案**：
- 確保 `order_code` 欄位在資料庫中唯一
- 匯入前檢查是否已存在相同編號

```php
// 檢查重複邏輯
$existingCodes = Order::pluck('order_code')->toArray();
foreach ($orders as $order) {
    if (in_array($order['order_code'], $existingCodes)) {
        // 處理重複問題
    }
}
```

### 2. 日期格式錯誤

**錯誤訊息**：`The date does not match the format Y-m-d.`

**解決方案**：
- 確保日期格式為 YYYY-MM-DD
- 或使用 Excel 數字日期格式

```php
// 安全的日期格式化
function safeDateFormat($date) {
    if (is_numeric($date)) {
        return \PhpOffice\PhpSpreadsheet\Shared\Date::excelToDateTimeObject($date)->format('Y-m-d');
    }
    return date('Y-m-d', strtotime($date));
}
```

### 3. 時間格式錯誤

**常見問題**：時間格式不一致

**解決方案**：
- 統一使用 HH:MM 格式
- 避免使用 AM/PM 格式

```php
// 時間格式標準化
function standardizeTime($time) {
    return date('H:i', strtotime($time));
}
```

---

## 📊 效能最佳化建議

### 1. 大批量匯入

```php
// 使用批次插入提升效能
DB::transaction(function() use ($validatedData) {
    Order::insert($validatedData); // 批次插入
});
```

### 2. 記憶體管理

```php
// 處理大檔案時分批處理
$chunkSize = 1000;
$chunks = array_chunk($data, $chunkSize);

foreach ($chunks as $chunk) {
    // 處理每個區塊
    processOrderChunk($chunk);
}
```

---

## 🔍 除錯指南

### 1. 啟用詳細錯誤記錄

```php
// 在匯入前啟用日誌記錄
Log::info('開始匯入訂單', ['file_size' => $file->getSize()]);

foreach ($data as $index => $row) {
    Log::debug('處理第 ' . ($index + 1) . ' 行', $row);
}
```

### 2. 資料格式檢查

```php
// 檢查每行資料格式
foreach ($data as $index => $row) {
    Log::info("第 {$index} 行資料:", [
        'count' => count($row),
        'data' => array_slice($row, 0, 14)  // 只記錄前14欄
    ]);
}
```

---

## 📝 版本相容性

| 版本 | 支援欄位數 | 說明 |
|------|-----------|------|
| v1.0 | 12 欄 | 基礎版本，不含隊員編號和特殊狀態 |
| v1.1 | 13 欄 | 新增隊員編號欄位 |
| v1.2 | 14 欄 | **當前版本**，新增特殊狀態欄位 |

### 向下相容處理

```php
// 系統會自動適應不同欄位數量
$columnCount = count($row);
switch ($columnCount) {
    case 12:
        // 舊格式，special_status 設為 null
        $specialStatus = null;
        break;
    case 13:
        // 中期格式，special_status 設為 null
        $specialStatus = null;
        break;
    case 14:
        // 最新格式
        $specialStatus = $row[13] ?? null;
        break;
    default:
        // 不支援的格式
        throw new InvalidArgumentException('不支援的欄位數量');
}
```

---

## 📞 技術支援

### 開發相關問題

1. **Excel 格式不正確**: 檢查欄位順序和資料型別
2. **匯入失敗**: 查看 Laravel 日誌檔案
3. **資料驗證錯誤**: 參考本文件的驗證規則表
4. **效能問題**: 考慮分批處理大量資料

### 聯繫方式

- **系統版本**: 訂單管理系統 v2025.08
- **Laravel 版本**: 10.x
- **相依套件**: Maatwebsite/Laravel-Excel

---

*文件製作日期: 2025-08-24*  
*適用系統版本: 訂單管理系統 v2025.08*  
*技術文件版本: v1.0*