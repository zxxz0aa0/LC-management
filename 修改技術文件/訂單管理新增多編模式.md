# 訂單管理 - 新增多編模式

本文說明「多編模式」的前後端設計與批次編輯流程，已用 UTF-8 儲存以避免亂碼。

## 功能摘要
- 於訂單列表提供「多編模式」檢視，支援勾選多筆訂單並一次更新。
- 前端使用 DataTables 顯示與排序，搭配 Modal 送出批次更新。
- 後端提供 `/orders/batch-edit` API 進行資料驗證與批次更新。

## 主要修改檔案
- `resources/views/orders/index.blade.php`：新增「多編模式」選項與區塊切換。
- `resources/views/orders/components/order-table-edit.blade.php`：多編模式表格、批次編輯 Modal、DataTables 初始化與前端驗證。
- `public/js/orders/index.js`：表格模式切換、初始化 DataTable 入口。
- `routes/web.php`：POST `/orders/batch-edit` 路由。
- `app/Http/Controllers/OrderController.php`：`batchEdit()` 驗證與回傳。
- `app/Services/BatchEditService.php`：實際批次更新、欄位過濾與群組處理。

## 前端流程（多編模式）
1) 在 `index.blade.php` 選擇「多編模式」，顯示 `order-table-edit` 區塊並呼叫 `window.orderIndex.initializeEditTable()`。
2) DataTable 初始化：排序欄位（日期、時間）、搜尋、分頁，勾選與操作欄禁用排序。
3) 使用者勾選列 → 顯示已選筆數，若含共乘訂單顯示警示。
4) Modal 填寫欲更新欄位（留空則不更新）；時間欄支援 HHMM 自動格式化。
5) 送出前驗證：至少勾選一筆、地址格式（含縣市區）、欄位長度限制。
6) 成功後提醒並重新整理；失敗則復原按鈕文字並顯示訊息。

## 後端流程
- 路由：`POST /orders/batch-edit` → `OrderController@batchEdit`。
- 驗證（可依實作調整）：
  - `order_ids`: required|array|min:1，且存在於 orders。
  - `ride_time`: nullable|date_format:H:i。
  - `pickup_address`/`dropoff_address`: nullable|string|max:255。
  - `remark`: nullable|string|max:1000。
  - `status`: nullable|string|in:open,assigned,bkorder,blocked,cancelled,cancelledOOC,cancelledNOC,cancelledCOTD,blacklist,no_send,regular_sedans,no_car。
  - `special_status`: nullable|string|in:網路單,Line,代管單,黑名單,多趟單。
  - `customer_phone`: nullable|string|max:20。
  - `wheelchair`/`stair_machine`: nullable|string|in:是,否,未知。
- Service：`BatchEditService` 過濾允許欄位、處理共乘群組同步（若有）、回傳成功筆數與訊息。

## 範例請求
```json
POST /orders/batch-edit
{
  "order_ids": [1,2,3],
  "ride_time": "09:30",
  "pickup_address": "台北市信義區市府路45號",
  "status": "assigned",
  "wheelchair": "否",
  "stair_machine": "未知",
  "remark": "批次更新測試"
}
```

## 注意事項
- 隱藏的表格切換時需重新 `draw()` 或重新初始化 DataTable，避免排序/分頁失效。
- Modal 只送出有填寫的欄位，留空不覆蓋原值。
- 若有共乘訂單，更新時需同時處理同群組的訂單（依需求在 Service 中實作）。
- 確認頁面已載入 jQuery 與 DataTables（`layouts/app.blade.php` 已引入 CDN）。

## 待辦 / 檢查清單
- [ ] 確認後端驗證規則與前端選單選項一致。
- [ ] 確認群組訂單同步邏輯符合需求。
- [ ] 依需要新增欄位時，同步更新：Blade 表單、Service ALLOWED_FIELDS、Controller 驗證。
- [ ] 若需限制一次更新筆數，於 Controller/Service 加上筆數上限與提示。
