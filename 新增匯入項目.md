# 訂單管理新增匯入按鈕與功能說明書

## 📋 概述
我想要在order-table.blade.php這裡面的匯入功能多一個匯入按鈕，匯入EXCEL檔案，匯入後會依照訂單編號去更新orders資料表裡的欄位資料，Ａ欄位為訂單編號作為查詢訂單資料表訂單、Ｅ欄位為隊員編號用來是搜尋drivers資料表資料將進行對應填入orders資料表、Ｈ欄位為媒合時間填入orders資料表媒合時間欄位（目前orders資料表裡面沒有媒合欄位所以要創建一個）、Ｍ欄為狀態欄位要將orders資料表status欄位更新



### EXCEL檔案格式
- **檔案類型**: `.xlsx` (Excel 2007 或更新版本)
- **編碼**: UTF-8
- **工作表**: 使用第一個工作表的資料


## 下方是我要匯入的EXCEL檔的欄位詳細說明

### 1. 訂單編號 (order_code)
- **資料型態**: `string`
- **資料庫欄位**: `orders.order_code`
- **說明**: 唯一的訂單識別碼
- **範例**: "ORD20250829001"

### 2. 類型 (type)
- **資料型態**: `string`
- **資料庫欄位**: `orders.type`
- **說明**: 訂單類型，如「新北長照」等
- **範例**: "新北長照"

### 3. 姓名 (name)
- **資料型態**: `string`
- **資料庫欄位**: `orders.name`
- **說明**: 乘客姓名
- **範例**: "王小明"

### 4. 電話 (phone)
- **資料型態**: `string`
- **資料庫欄位**: `orders.phone`
- **說明**: 乘客聯絡電話
- **範例**: "0912345678"

### 5. 隊員編號 (assigned_user_id)
- **資料型態**: `string` (nullable)
- **資料庫欄位**: `orders.assigned_user_id`
- **說明**: 指派的駕駛員隊編，可為空
- **範例**: "A001", null

### 6. 日期 (date)
- **資料型態**: `date`
- **資料庫欄位**: `orders.date`
- **說明**: 車趟日期
- **格式**: YYYY-MM-DD
- **範例**: "2025-08-29"

### 7. 時間 (time)
- **資料型態**: `time`
- **資料庫欄位**: `orders.time`
- **說明**: 車趟時間，顯示時截取前5位 (HH:MM)
- **處理邏輯**: `substr($order->time, 0, 5)`
- **範例**: "08:30"

### 8. 媒合時間 (match_time)
- **資料型態**: `時間字串或「-」`
- **資料來源**: `order_match_requests` 關聯表
- **說明**: 駕駛員申請的媒合時間，複雜處理邏輯
- **處理邏輯**:
  ```php
  $validMatch = $order->matchRequests->whereNotIn('status', ['canceled'])->first();
  if($validMatch) {
      時間格式: H:i
      如果 status !== 'success' 則顯示: 時間 / 駕駛員隊號
  } else {
      顯示: -
  }
  ```
- **範例**: 
  - "08:45" (已確認媒合)
  - "08:45 / A001" (待確認媒合)
  - "-" (無媒合申請)

### 9. 上車地址 (origin_address)
- **資料型態**: `string` (組合欄位)
- **資料來源**: `orders.origin_area` + `orders.origin_address`
- **說明**: 完整上車地址，由區域+詳細地址組成
- **範例**: "板橋區中正路100號"

### 10. 下車地址 (dest_address)
- **資料型態**: `string` (組合欄位)
- **資料來源**: `orders.dest_area` + `orders.dest_address`
- **說明**: 完整下車地址，由區域+詳細地址組成
- **範例**: "新莊區中華路200號"

### 11. 備註 (remark)
- **資料型態**: `text` (nullable)
- **資料庫欄位**: `orders.remark`
- **說明**: 訂單備註資訊，可為空
- **範例**: "輪椅使用者", null

### 12. 特殊狀態 (special_status)
- **資料型態**: `string` (nullable)
- **資料庫欄位**: `orders.special_status`
- **說明**: 訂單特殊狀態標記，可為空
- **範例**: "急件", "VIP", null

### 13. 狀態 (status)
- **資料型態**: `enum` 轉中文顯示
- **資料庫欄位**: `orders.status`
- **可能值與對應中文**:
  - `open` → "待搶單"
  - `assigned` → "已指派"  
  - `cancelled` → "已取消"
  - `bkorder` → "已候補"
  - `completed` → "已完成"
- **匯出格式**: HTML span 標籤包裹的中文狀態文字
- **範例**: `<span class="badge bg-primary">已指派</span>`


## drivers資料表資料對應填入orders資料表說明

1. EXCEL的隊員編號要填入driver_fleet_number欄位，再去查找drivers資料表的fleet_number欄位
2. drivers資料表的name欄位要填入orders資料表的driver_name欄位
3. drivers資料表的plate_number欄位要填入orders資料表的driver_plate_number欄位
4. drivers資料表的id欄位要填入orders資料表的driver_id欄位

---

# 🔧 批量更新功能技術實作說明

## 📋 需求分析
基於原有的訂單匯入功能，新增批量更新功能，允許透過 Excel 檔案更新現有訂單的指派資訊，而非建立新訂單。

### 核心需求
- **A欄（訂單編號）**: 作為查詢鍵值，更新現有訂單
- **E欄（隊員編號）**: 更新駕駛指派資訊
- **H欄（媒合時間）**: 新增媒合時間欄位並更新
- **M欄（狀態）**: 更新訂單狀態

---

## 🏗️ 技術架構設計

### 1. 資料庫結構變更
**檔案**: `database/migrations/2025_08_30_004701_add_match_time_to_orders_table.php`

```php
public function up(): void
{
    Schema::table('orders', function (Blueprint $table) {
        $table->datetime('match_time')->nullable()->comment('媒合時間');
    });
}
```

**變更說明**:
- 新增 `match_time` 欄位到 `orders` 表
- 設置為 `nullable` 允許空值
- 使用 `datetime` 類型儲存完整日期時間

### 2. Model 層更新
**檔案**: `app/Models/Order.php`

```php
// 新增到 $fillable 陣列
'carpool_id_number', 'match_time',

// 新增到 $casts 陣列
'match_time' => 'datetime',
```

**變更說明**:
- 將 `match_time` 加入可填寫欄位白名單
- 設置自動類型轉換為 Carbon 實例

### 3. 控制器層實作
**檔案**: `app/Http/Controllers/OrderController.php`

```php
public function batchUpdate(Request $request)
{
    $request->validate([
        'file' => 'required|file|mimes:xlsx,xls',
    ]);

    try {
        $importer = new \App\Imports\OrderBatchUpdateImport;
        Excel::import($importer, $request->file('file'));

        return redirect()->route('orders.index')->with([
            'success' => "批量更新完成：成功 {$importer->successCount} 筆，失敗 {$importer->skipCount} 筆。",
            'import_errors' => $importer->errorMessages,
        ]);
    } catch (\Exception $e) {
        // 錯誤處理...
    }
}
```

**技術特點**:
- 使用相同的驗證規則確保檔案格式正確
- 統一的錯誤處理機制
- 回傳詳細的處理結果統計

### 4. 匯入處理類別
**檔案**: `app/Imports/OrderBatchUpdateImport.php`

#### 核心功能架構
```php
class OrderBatchUpdateImport implements ToCollection, WithChunkReading
{
    public $successCount = 0;
    public $skipCount = 0;
    public $errorMessages = [];
    private $driverCache = [];

    public function collection(Collection $rows) { /* 主要處理邏輯 */ }
    private function processRow(Collection $row, int $rowNumber) { /* 單行處理 */ }
    private function getDriverByFleetNumber(string $fleetNumber): ?Driver { /* 駕駛查詢 */ }
    private function parseDateTime(string $dateTimeString): Carbon { /* 時間解析 */ }
    public function chunkSize(): int { return 100; }
}
```

#### 核心演算法設計

**1. Excel 欄位映射邏輯**
```php
$orderNumber = trim($row[0] ?? ''); // A欄 - 訂單編號
$fleetNumber = trim($row[4] ?? ''); // E欄 - 隊員編號 (index 4 = 第5欄)
$matchTime = trim($row[7] ?? '');   // H欄 - 媒合時間 (index 7 = 第8欄)  
$status = trim($row[12 ?? '');      // M欄 - 狀態 (index 12 = 第13欄)
```

**2. 事務安全處理**
```php
DB::transaction(function () use ($order, $fleetNumber, $matchTime, $status, $rowNumber) {
    $updateData = [];
    
    // 處理駕駛資訊...
    // 處理媒合時間...
    // 處理狀態...
    
    if (!empty($updateData)) {
        $order->update($updateData);
        $this->successCount++;
    }
});
```

**3. 駕駛資訊快取機制**
```php
private function getDriverByFleetNumber(string $fleetNumber): ?Driver
{
    if (!isset($this->driverCache[$fleetNumber])) {
        $this->driverCache[$fleetNumber] = Driver::where('fleet_number', $fleetNumber)->first();
    }
    return $this->driverCache[$fleetNumber];
}
```

**4. 智能時間解析**
```php
private function parseDateTime(string $dateTimeString): Carbon
{
    $formats = [
        'Y-m-d H:i:s', 'Y/m/d H:i:s', 'Y-m-d H:i', 'Y/m/d H:i',
        'Y-m-d', 'Y/m/d', 'H:i:s', 'H:i'
    ];
    
    foreach ($formats as $format) {
        try {
            return Carbon::createFromFormat($format, $dateTimeString);
        } catch (\Exception $e) {
            continue;
        }
    }
    
    return Carbon::parse($dateTimeString); // 最後嘗試自動解析
}
```

### 5. 前端介面實作
**檔案**: `resources/views/orders/components/order-table.blade.php`

#### UI 組件設計
```html
<!-- 批量更新按鈕 -->
<button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#batchUpdateModal">
    <i class="fas fa-edit me-2"></i>批量更新
</button>

<!-- 批量更新 Modal -->
<div class="modal fade" id="batchUpdateModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal Header with warning style -->
            <!-- Form with file upload -->
            <!-- Detailed instructions and examples -->
        </div>
    </div>
</div>
```

#### 使用者體驗設計
- **視覺識別**: 使用警告色 (`btn-warning`) 區別於新增匯入
- **詳細說明**: 提供完整的欄位對應說明和範例
- **格式展示**: 使用表格展示 Excel 欄位結構

### 6. 路由配置
**檔案**: `routes/web.php`

```php
Route::post('/orders/batch-update', [OrderController::class, 'batchUpdate'])->name('orders.batch-update');
```

**路由策略**:
- 放置在匯入相關路由群組中
- 使用 POST 方法處理檔案上傳
- 統一命名規範 `orders.batch-update`

---

## 🔒 安全性與效能設計

### 1. 資料安全
- **事務完整性**: 使用 `DB::transaction()` 確保原子操作
- **輸入驗證**: 檔案類型限制和必要欄位檢查  
- **SQL 注入防護**: 使用 Eloquent ORM 查詢
- **Mass Assignment 保護**: 透過 `$fillable` 白名單控制

### 2. 記憶體管理
- **分批處理**: 實作 `WithChunkReading` 介面，每次處理100行
- **快取機制**: 駕駛資訊查詢快取避免重複查詢
- **記憶體監控**: 記錄處理前後記憶體使用狀況

### 3. 錯誤處理
- **層級錯誤處理**: 控制器、匯入類別、單行處理三層錯誤捕獲
- **詳細日誌**: 使用 Laravel Log 記錄處理過程和錯誤
- **使用者回饋**: 提供成功/失敗統計和錯誤訊息列表

### 4. 併發控制
- **資料庫鎖定**: 透過事務機制避免併發更新衝突
- **訂單狀態檢查**: 更新前驗證訂單存在性
- **重試機制**: 支援例外狀況下的錯誤重試

---

## 📊 系統整合與監控

### 1. 日誌記錄策略
```php
Log::info('批量更新匯入開始', [
    'total_rows' => $rows->count(),
    'memory_before' => $this->formatBytes($startMemory),
]);

Log::info('成功更新訂單', [
    'order_number' => $order->order_number,
    'updates' => array_keys($updateData),
]);
```

### 2. 效能監控指標
- **處理時間**: 記錄匯入開始到結束的耗時
- **記憶體使用**: 追蹤記憶體峰值和使用量
- **成功率統計**: 提供成功/失敗/跳過的詳細統計

### 3. 錯誤追蹤
- **行級錯誤**: 精確定位到 Excel 的具體行數
- **欄位級錯誤**: 標記具體的欄位處理錯誤
- **系統級錯誤**: 捕獲和記錄系統異常

---

## ✅ 實作完成狀態

### 已完成項目
1. ✅ **資料庫結構** - 新增 `match_time` 欄位到 orders 表
2. ✅ **Model 更新** - 更新 Order 模型支援新欄位
3. ✅ **後端邏輯** - 實作 `OrderBatchUpdateImport` 處理類別
4. ✅ **控制器方法** - 新增 `batchUpdate` 方法到 `OrderController`
5. ✅ **前端介面** - 新增批量更新按鈕和詳細說明 Modal
6. ✅ **路由配置** - 註冊 `orders.batch-update` 路由
7. ✅ **程式碼品質** - 通過 Laravel Pint 格式化和語法檢查
8. ✅ **資料庫遷移** - 執行遷移成功新增欄位

### 功能特點
- **併發安全**: 使用 DB::transaction 確保資料一致性
- **錯誤處理**: 完整的例外處理和錯誤訊息記錄
- **記憶體最佳化**: 使用 chunk 分批處理，避免記憶體溢出
- **智能對應**: 自動根據隊員編號查詢並填入駕駛資訊
- **靈活格式**: 支援多種日期時間格式自動解析
- **詳細日誌**: 提供詳細的處理過程記錄
- **使用者友善**: 直觀的 UI 設計和詳細的使用說明

### 技術債務與後續優化
1. **佇列處理**: 大量資料可考慮使用 Job Queue 異步處理
2. **快取優化**: 可考慮使用 Redis 快取駕駛資訊
3. **API 化**: 可提供 REST API 支援程式化批量更新
4. **範本下載**: 可新增批量更新專用的 Excel 範本下載功能

---

## 🚀 使用指南

### 操作步驟
1. **進入訂單列表頁面** - 導航到 `/orders`
2. **點擊批量更新按鈕** - 位於頁面右上角按鈕群組
3. **準備 Excel 檔案** - 按照指定格式準備更新資料
4. **上傳並處理** - 選擇檔案後點擊「開始批量更新」
5. **查看結果** - 系統會顯示處理結果統計

### Excel 格式範例
```
| A欄      | B欄 | C欄 | D欄 | E欄     | F欄 | G欄 | H欄              | ... | M欄    |
|----------|-----|-----|-----|---------|-----|-----|------------------|-----|--------|
| 訂單編號  |     |     |     | 隊員編號 |     |     | 媒合時間          |     | 狀態    |
| ORD001   |     |     |     | A001    |     |     | 2025-08-29 08:30 |     | 已指派  |
| ORD002   |     |     |     | B002    |     |     | 2025-08-29 09:15 |     | 已指派  |
```

### 狀態對應表
| Excel 中文狀態 | 資料庫英文值 | 說明     |
|---------------|-------------|----------|
| 待搶單        | open        | 開放搶單 |
| 已指派        | assigned    | 已指派駕駛 |
| 已取消        | cancelled   | 已取消   |
| 已候補        | bkorder     | 候補狀態 |
| 已完成        | completed   | 已完成   |

