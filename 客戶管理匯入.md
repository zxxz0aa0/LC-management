# å®¢æˆ¶ç®¡ç†åŒ¯å…¥åŠŸèƒ½

## ğŸ“‹ æ¦‚è¿°

LC-managementç³»çµ±çš„å®¢æˆ¶åŒ¯å…¥åŠŸèƒ½ç¶“éå…¨é¢é‡æ§‹ï¼Œæä¾›äº†ç©©å®šã€é«˜æ•ˆã€æ˜“ç”¨çš„Excelæ‰¹æ¬¡åŒ¯å…¥è§£æ±ºæ–¹æ¡ˆã€‚æ–°ç³»çµ±è§£æ±ºäº†EMAILç´„æŸè¡çªã€æ”¯æ´ä¸­æ–‡æ¨™é¡Œã€æä¾›æ™ºèƒ½åŒ¯å…¥æ–¹å¼é¸æ“‡ï¼Œä¸¦å…·å‚™å®Œå–„çš„é€²åº¦è¿½è¹¤å’ŒéŒ¯èª¤è™•ç†æ©Ÿåˆ¶ã€‚

### ä¸»è¦ç‰¹è‰²

- âœ… **ä¸­è‹±æ–‡æ¨™é¡Œæ”¯æ´**ï¼šè‡ªå‹•è­˜åˆ¥ä¸­æ–‡å’Œè‹±æ–‡æ¨™é¡Œï¼Œå‘ä¸‹ç›¸å®¹èˆŠæ ¼å¼
- âœ… **EMAILç´„æŸä¿®å¾©**ï¼šæ”¯æ´å¤šç­†ç©ºEMAILè¨˜éŒ„åŒ¯å…¥ï¼Œç„¡å”¯ä¸€ç´„æŸè¡çª
- âœ… **æ™ºèƒ½åŒ¯å…¥æ–¹å¼**ï¼šæ ¹æ“šè³‡æ–™é‡è‡ªå‹•é¸æ“‡ç›´æ¥è™•ç†æˆ–ä½‡åˆ—è™•ç†
- âœ… **å¯¦æ™‚é€²åº¦è¿½è¹¤**ï¼šå®Œæ•´çš„é€²åº¦ç›£æ§å’ŒéŒ¯èª¤å ±å‘Š
- âœ… **è¨˜æ†¶é«”å„ªåŒ–**ï¼šæ‰¹æ¬¡è™•ç†å’Œå‹•æ…‹è¨˜æ†¶é«”ç®¡ç†
- âœ… **ä½µç™¼å®‰å…¨**ï¼šä½¿ç”¨UUIDæœƒè©±IDï¼Œæ”¯æ´å¤šä½¿ç”¨è€…åŒæ™‚åŒ¯å…¥

### ç³»çµ±éœ€æ±‚

- Laravel 10.x
- PHP 8.1+
- MySQL 5.7+
- maatwebsite/excel 3.1+
- è¨˜æ†¶é«”å»ºè­° >= 512MB

---

## ğŸ—ï¸ æ¶æ§‹è¨­è¨ˆ

### æ•´é«”æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯ä»‹é¢      â”‚    â”‚   Controller     â”‚    â”‚   Service       â”‚
â”‚                 â”‚    â”‚                  â”‚    â”‚                 â”‚
â”‚ â€¢ æª”æ¡ˆä¸Šå‚³      â”‚â—„â”€â”€â–ºâ”‚ CustomerControllerâ”‚â—„â”€â”€â–ºâ”‚CustomerImportServiceâ”‚
â”‚ â€¢ é€²åº¦ç›£æ§      â”‚    â”‚ â€¢ import()       â”‚    â”‚ â€¢ processImport()â”‚
â”‚ â€¢ éŒ¯èª¤é¡¯ç¤º      â”‚    â”‚ â€¢ importProgress()â”‚    â”‚ â€¢ validateData() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚                        â”‚
                                â–¼                        â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   Import Class   â”‚    â”‚   Database      â”‚
                       â”‚                  â”‚    â”‚                 â”‚
                       â”‚ CustomerImport   â”‚    â”‚ â€¢ customers     â”‚
                       â”‚ â€¢ ToCollection   â”‚    â”‚ â€¢ import_sessionsâ”‚
                       â”‚ â€¢ WithChunkReadingâ”‚    â”‚                 â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒçµ„ä»¶

#### 1. CustomerImportService
**ä½ç½®**: `app/Services/CustomerImportService.php`
**è·è²¬**: çµ±ä¸€çš„åŒ¯å…¥æ¥­å‹™é‚è¼¯è™•ç†

```php
class CustomerImportService
{
    // ä¸­è‹±æ–‡æ¨™é¡Œå°ç…§
    private static $headerMapping = [
        'å§“å' => 'name',
        'èº«åˆ†è­‰è™Ÿ' => 'id_number',
        'å‡ºç”Ÿå¹´æœˆæ—¥' => 'birthday',
        // ... æ›´å¤šå°ç…§
    ];
    
    public function processImport(Collection $rows): array
    public function setImportSession(ImportSession $session)
}
```

#### 2. CustomerImport
**ä½ç½®**: `app/Imports/CustomerImport.php`
**è·è²¬**: Laravel ExcelåŒ¯å…¥è™•ç†å™¨

```php
class CustomerImport implements ShouldQueue, ToCollection, WithChunkReading
{
    public $timeout = 7200; // 2å°æ™‚è¶…æ™‚
    
    public function collection(Collection $rows)
    public function chunkSize(): int // å‹•æ…‹èª¿æ•´æ‰¹æ¬¡å¤§å°
}
```

#### 3. ImportSession Model
**ä½ç½®**: `app/Models/ImportSession.php`
**è·è²¬**: åŒ¯å…¥æœƒè©±ç®¡ç†å’Œé€²åº¦è¿½è¹¤

```php
class ImportSession extends Model
{
    // ç‹€æ…‹: pending, processing, completed, failed
    public function getProgressPercentageAttribute(): float
    public function isCompleted(): bool
    public function isFailed(): bool
}
```

### è³‡æ–™æµç¨‹

```
1. ä½¿ç”¨è€…ä¸Šå‚³æª”æ¡ˆ
   â†“
2. ä¼°ç®—æª”æ¡ˆè¡Œæ•¸
   â†“
3. å»ºç«‹ImportSession
   â†“
4. åˆ¤æ–·è™•ç†æ–¹å¼ (< 1000ç­†ç›´æ¥è™•ç† / >= 1000ç­†ä½‡åˆ—è™•ç†)
   â†“
5. CustomerImportè™•ç†Excelè³‡æ–™
   â†“
6. CustomerImportServiceåŸ·è¡Œæ¥­å‹™é‚è¼¯
   â†“
7. æ‰¹æ¬¡å¯«å…¥è³‡æ–™åº«
   â†“
8. æ›´æ–°ImportSessioné€²åº¦
   â†“
9. è¿”å›çµæœæˆ–é‡å®šå‘è‡³é€²åº¦é é¢
```

---

## ğŸ“– ä½¿ç”¨æŒ‡å—

### 1. ä¸‹è¼‰åŒ¯å…¥ç¯„æœ¬

**è·¯ç”±**: `GET /customers/template`
**æ§åˆ¶å™¨æ–¹æ³•**: `CustomerController::downloadTemplate()`

```bash
# ç›´æ¥ä¸‹è¼‰
curl -O http://your-domain/customers/template

# æˆ–åœ¨ç€è¦½å™¨ä¸­è¨ªå•
http://your-domain/customers/template
```

### 2. æº–å‚™Excelæª”æ¡ˆ

#### æ”¯æ´çš„æ¨™é¡Œæ ¼å¼

**ä¸­æ–‡æ¨™é¡Œ**ï¼ˆæ¨è–¦ï¼‰:
```
å§“å | èº«åˆ†è­‰è™Ÿ | å‡ºç”Ÿå¹´æœˆæ—¥ | æ€§åˆ¥ | è¯çµ¡é›»è©± | åœ°å€ | è¯çµ¡äºº | è¯çµ¡äººé›»è©± | é—œä¿‚ | é›»å­éƒµä»¶ | è¼ªæ¤… | çˆ¬æ¢¯æ©Ÿ | å…±ä¹˜ | èº«åˆ†åˆ¥ | å‚™è¨» | aå–®ä½ | å€‹ç®¡å¸« | ç‰¹æ®Šæƒ…æ³ | ç¸£å¸‚ç…§é¡§ | æœå‹™å…¬å¸ | ç…§æœƒæ—¥æœŸ | ç‹€æ…‹
```

**è‹±æ–‡æ¨™é¡Œ**ï¼ˆç›¸å®¹ï¼‰:
```
name | id_number | birthday | gender | phone_number | addresses | contact_person | contact_phone | contact_relationship | email | wheelchair | stair_climbing_machine | ride_sharing | identity | note | a_mechanism | a_manager | special_status | county_care | service_company | referral_date | status
```

#### è³‡æ–™æ ¼å¼è¦æ±‚

| æ¬„ä½ | æ ¼å¼ | å¿…å¡« | èªªæ˜ |
|------|------|------|------|
| å§“å | æ–‡å­— | âœ… | å®¢æˆ¶å§“å |
| èº«åˆ†è­‰è™Ÿ | æ–‡å­— | âœ… | å”¯ä¸€è­˜åˆ¥ç¢¼ |
| å‡ºç”Ÿå¹´æœˆæ—¥ | YYYY-MM-DD | âŒ | æ¨™æº–æ—¥æœŸæ ¼å¼ |
| é›»å­éƒµä»¶ | emailæ ¼å¼ | âŒ | å¯ç©ºç™½ï¼Œæ”¯æ´å¤šç­†ç©ºå€¼ |
| è¯çµ¡é›»è©± | æ–‡å­— | âŒ | å¯ç”¨é€—è™Ÿåˆ†éš”å¤šç­† |
| åœ°å€ | æ–‡å­— | âŒ | å¯ç”¨é€—è™Ÿåˆ†éš”å¤šç­† |

#### EMAILæ¬„ä½ç‰¹åˆ¥èªªæ˜
```
âœ… æœ‰æ•ˆæ ¼å¼:
- test@example.com
- user@domain.com,admin@domain.com  (å¤šç­†ç”¨é€—è™Ÿåˆ†éš”)
- (ç©ºç™½)  (æ”¯æ´å¤šç­†è¨˜éŒ„éƒ½ç©ºç™½)

âŒ ç„¡æ•ˆæ ¼å¼:
- 0
- null
- invalid-email
```

### 3. åŸ·è¡ŒåŒ¯å…¥æ“ä½œ

#### å‰ç«¯è¡¨å–®ç¯„ä¾‹
```html
<form action="{{ route('customers.import') }}" method="POST" enctype="multipart/form-data">
    @csrf
    <div class="form-group">
        <label for="file">é¸æ“‡Excelæª”æ¡ˆ</label>
        <input type="file" name="file" id="file" accept=".xlsx,.xls" required>
        <small class="text-muted">æ”¯æ´.xlsxå’Œ.xlsæ ¼å¼ï¼Œæœ€å¤§50MB</small>
    </div>
    <button type="submit" class="btn btn-primary">é–‹å§‹åŒ¯å…¥</button>
</form>
```

#### åŒ¯å…¥æ–¹å¼è‡ªå‹•é¸æ“‡
- **å°é‡è³‡æ–™** (< 1000ç­†): ç›´æ¥è™•ç†ï¼Œç«‹å³é¡¯ç¤ºçµæœ
- **å¤§é‡è³‡æ–™** (â‰¥ 1000ç­†): ä½‡åˆ—è™•ç†ï¼Œé‡å®šå‘è‡³é€²åº¦é é¢

### 4. é€²åº¦ç›£æ§

#### é€²åº¦é é¢åŠŸèƒ½
- **å¯¦æ™‚é€²åº¦æ¢**: é¡¯ç¤ºè™•ç†ç™¾åˆ†æ¯”
- **çµ±è¨ˆè³‡è¨Š**: å·²è™•ç†/æˆåŠŸ/éŒ¯èª¤/å‰©é¤˜ç­†æ•¸
- **éŒ¯èª¤è¨Šæ¯**: è©³ç´°çš„éŒ¯èª¤åˆ—è¡¨
- **è‡ªå‹•é‡æ–°æ•´ç†**: 3ç§’é–“éš”è¼ªè©¢æ›´æ–°

#### JavaScripté€²åº¦è¼ªè©¢ç¯„ä¾‹
```javascript
function fetchProgress() {
    fetch(`/api/customers/import-progress/${sessionId}`)
        .then(response => response.json())
        .then(data => {
            // æ›´æ–°é€²åº¦æ¢
            document.getElementById('progress-bar').style.width = data.progress_percentage + '%';
            
            // æ›´æ–°çµ±è¨ˆæ•¸å­—
            document.getElementById('processed-count').textContent = data.processed_rows;
            document.getElementById('success-count').textContent = data.success_count;
            document.getElementById('error-count').textContent = data.error_count;
            
            // æª¢æŸ¥æ˜¯å¦å®Œæˆ
            if (data.status === 'completed' || data.status === 'failed') {
                clearInterval(pollInterval);
            }
        });
}
```

---

## ğŸ”Œ APIæ–‡æª”

### è·¯ç”±åˆ—è¡¨

| æ–¹æ³• | è·¯ç”± | åç¨± | èªªæ˜ |
|------|------|------|------|
| POST | `/customers/import` | customers.import | åŸ·è¡ŒåŒ¯å…¥ |
| GET | `/customers/import-progress/{sessionId}` | customers.import.progress | é€²åº¦é é¢ |
| GET | `/api/customers/import-progress/{sessionId}` | api.customers.import.progress | é€²åº¦API |
| GET | `/customers/template` | customers.template | ä¸‹è¼‰ç¯„æœ¬ |

### 1. åŸ·è¡ŒåŒ¯å…¥

**POST** `/customers/import`

**è«‹æ±‚åƒæ•¸**:
```json
{
    "file": "multipart/form-data Excelæª”æ¡ˆ"
}
```

**é©—è­‰è¦å‰‡**:
- file: required|file|mimes:xlsx,xls|max:51200 (50MB)

**æˆåŠŸå›æ‡‰**:
```json
// å°é‡è³‡æ–™ç›´æ¥è™•ç†
{
    "redirect": "/customers",
    "success": "åŒ¯å…¥å®Œæˆï¼æˆåŠŸï¼š150 ç­†ï¼ŒéŒ¯èª¤ï¼š5 ç­†",
    "import_errors": ["ç¬¬ 10 åˆ—ï¼šç¼ºå°‘èº«åˆ†è­‰è™Ÿ", "ç¬¬ 25 åˆ—ï¼šé›»å­éƒµä»¶æ ¼å¼éŒ¯èª¤"]
}

// å¤§é‡è³‡æ–™ä½‡åˆ—è™•ç†  
{
    "redirect": "/customers/import-progress/uuid-session-id",
    "success": "å¤§é‡åŒ¯å…¥å·²é–‹å§‹è™•ç†ï¼Œé è¨ˆ 5000 ç­†è³‡æ–™ã€‚è«‹ç›£æ§é€²åº¦ã€‚"
}
```

**éŒ¯èª¤å›æ‡‰**:
```json
{
    "errors": {
        "file": ["åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤"]
    }
}
```

### 2. é€²åº¦æŸ¥è©¢API

**GET** `/api/customers/import-progress/{sessionId}`

**è·¯å¾‘åƒæ•¸**:
- sessionId: UUIDæ ¼å¼çš„æœƒè©±ID

**å›æ‡‰æ ¼å¼**:
```json
{
    "session_id": "12345678-1234-1234-1234-123456789abc",
    "filename": "customers.xlsx", 
    "total_rows": 1000,
    "processed_rows": 350,
    "success_count": 340,
    "error_count": 10,
    "status": "processing",
    "status_text": "è™•ç†ä¸­",
    "progress_percentage": 35.0,
    "remaining_rows": 650,
    "error_messages": [
        "ç¬¬ 15 åˆ—ï¼šç¼ºå°‘èº«åˆ†è­‰è™Ÿ",
        "ç¬¬ 28 åˆ—ï¼šé›»å­éƒµä»¶æ ¼å¼éŒ¯èª¤"
    ],
    "started_at": "2025-08-27 10:30:15",
    "completed_at": null,
    "processing_time": 45
}
```

**ç‹€æ…‹èªªæ˜**:
- `pending`: ç­‰å¾…è™•ç†
- `processing`: è™•ç†ä¸­  
- `completed`: å·²å®Œæˆ
- `failed`: å¤±æ•—

### 3. éŒ¯èª¤è™•ç†

**HTTPç‹€æ…‹ç¢¼**:
- 200: æˆåŠŸ
- 404: æ‰¾ä¸åˆ°åŒ¯å…¥æœƒè©±
- 422: é©—è­‰å¤±æ•—
- 500: ä¼ºæœå™¨éŒ¯èª¤

**éŒ¯èª¤è¨Šæ¯æ ¼å¼**:
```json
{
    "error": "æ‰¾ä¸åˆ°åŒ¯å…¥æœƒè©±",
    "session_id": "invalid-uuid"
}
```

---

## ğŸ‘¨â€ğŸ’» é–‹ç™¼æŒ‡å—

### ç¨‹å¼ç¢¼çµæ§‹

```
app/
â”œâ”€â”€ Services/
â”‚   â””â”€â”€ CustomerImportService.php      # åŒ¯å…¥æ¥­å‹™é‚è¼¯
â”œâ”€â”€ Imports/
â”‚   â””â”€â”€ CustomerImport.php            # Excelè™•ç†å™¨
â”œâ”€â”€ Models/
â”‚   â”œâ”€â”€ ImportSession.php             # æœƒè©±æ¨¡å‹
â”‚   â””â”€â”€ Customer.php                  # å®¢æˆ¶æ¨¡å‹
â”œâ”€â”€ Http/Controllers/
â”‚   â””â”€â”€ CustomerController.php        # æ§åˆ¶å™¨æ–¹æ³•
â””â”€â”€ Exports/
    â””â”€â”€ CustomerTemplateExport.php     # ç¯„æœ¬ç”Ÿæˆ

resources/views/customers/
â””â”€â”€ import-progress.blade.php          # é€²åº¦é é¢

database/migrations/
â”œâ”€â”€ 2025_08_27_075624_create_import_sessions_table.php
â””â”€â”€ 2025_08_26_233024_modify_customers_email_remove_unique_constraint.php
```

### æ ¸å¿ƒé¡åˆ¥è©³è§£

#### CustomerImportService

**ä¸»è¦æ–¹æ³•**:

```php
public function processImport(Collection $rows): array
{
    // è™•ç†åŒ¯å…¥çš„ä¸»è¦é‚è¼¯
    // è¿”å›: ['processed' => int, 'success' => int, 'errors' => int, 'error_messages' => array]
}

public function setImportSession(ImportSession $session): self
{
    // è¨­å®šåŒ¯å…¥æœƒè©±ï¼Œç”¨æ–¼é€²åº¦è¿½è¹¤
}

private function mapHeaders(array $row, array $headers): array  
{
    // ä¸­è‹±æ–‡æ¨™é¡Œå°ç…§é‚è¼¯
}

private function validateCustomerData(array $data, int $rowNumber): array
{
    // è³‡æ–™é©—è­‰é‚è¼¯
}

private function prepareCustomerData(array $data): array
{
    // è³‡æ–™æ ¼å¼åŒ–å’Œé è™•ç†
}
```

**è¨˜æ†¶é«”å„ªåŒ–ç­–ç•¥**:
```php
private function processBatch(array $batch)
{
    DB::transaction(function () use ($batch) {
        foreach ($batch as $customerData) {
            Customer::updateOrCreate(
                ['id_number' => $customerData['id_number']],
                $customerData
            );
        }
    });
}
```

#### CustomerImport

**å‹•æ…‹è¨˜æ†¶é«”ç®¡ç†**:
```php
public function chunkSize(): int
{
    $memoryUsage = memory_get_usage(true);
    $memoryMB = $memoryUsage / 1024 / 1024;

    if ($memoryMB > 200) {
        return 100;  // é«˜è¨˜æ†¶é«”ä½¿ç”¨æ™‚æ¸›å°‘æ‰¹æ¬¡
    } elseif ($memoryMB > 100) {
        return 300;
    } else {
        return 500;  // é è¨­æ‰¹æ¬¡å¤§å°
    }
}
```

### æ“´å±•é–‹ç™¼

#### 1. æ–°å¢æ¬„ä½æ”¯æ´

**æ­¥é©Ÿ1**: æ›´æ–°æ¨™é¡Œå°ç…§è¡¨
```php
// CustomerImportService.php
private static $headerMapping = [
    // ç¾æœ‰æ¬„ä½...
    'æ–°æ¬„ä½ä¸­æ–‡' => 'new_field_english',
];
```

**æ­¥é©Ÿ2**: æ›´æ–°è³‡æ–™æº–å‚™æ–¹æ³•
```php
private function prepareCustomerData(array $data): array
{
    return [
        // ç¾æœ‰æ¬„ä½...
        'new_field_english' => $data['new_field_english'] ?? null,
    ];
}
```

**æ­¥é©Ÿ3**: æ›´æ–°Customeræ¨¡å‹$fillable
```php
// Customer.php
protected $fillable = [
    // ç¾æœ‰æ¬„ä½...
    'new_field_english',
];
```

**æ­¥é©Ÿ4**: æ›´æ–°ç¯„æœ¬
```php
// CustomerTemplateExport.php
public function headings(): array
{
    return [
        // ç¾æœ‰æ¨™é¡Œ...
        'æ–°æ¬„ä½ä¸­æ–‡',
    ];
}
```

#### 2. è‡ªè¨‚é©—è­‰è¦å‰‡

```php
private function validateCustomerData(array $data, int $rowNumber): array
{
    // ç¾æœ‰é©—è­‰...
    
    // æ–°å¢è‡ªè¨‚é©—è­‰
    if (!empty($data['new_field']) && !preg_match('/^pattern$/', $data['new_field'])) {
        return [
            'valid' => false,
            'error' => "ç¬¬ {$rowNumber} åˆ—ï¼šæ–°æ¬„ä½æ ¼å¼éŒ¯èª¤"
        ];
    }
    
    return ['valid' => true];
}
```

#### 3. æ–°å¢åŒ¯å…¥å¾Œè™•ç†

```php
private function processBatch(array $batch)
{
    DB::transaction(function () use ($batch) {
        foreach ($batch as $customerData) {
            $customer = Customer::updateOrCreate(
                ['id_number' => $customerData['id_number']],
                $customerData
            );
            
            // æ–°å¢å¾Œè™•ç†é‚è¼¯
            $this->postProcessCustomer($customer, $customerData);
        }
    });
}

private function postProcessCustomer(Customer $customer, array $data)
{
    // ä¾‹å¦‚: ç™¼é€æ­¡è¿éƒµä»¶ã€å»ºç«‹é—œè¯è¨˜éŒ„ç­‰
}
```

### æ¸¬è©¦æŒ‡å—

#### å–®å…ƒæ¸¬è©¦ç¯„ä¾‹

```php
// tests/Unit/CustomerImportServiceTest.php
class CustomerImportServiceTest extends TestCase
{
    public function test_ä¸­æ–‡æ¨™é¡Œå°ç…§()
    {
        $service = new CustomerImportService();
        $headers = ['å§“å', 'èº«åˆ†è­‰è™Ÿ', 'é›»å­éƒµä»¶'];
        $row = ['ç‹å°æ˜', 'A123456789', 'test@example.com'];
        
        $result = $this->invokeMethod($service, 'mapHeaders', [$row, $headers]);
        
        $this->assertEquals('ç‹å°æ˜', $result['name']);
        $this->assertEquals('A123456789', $result['id_number']);
        $this->assertEquals('test@example.com', $result['email']);
    }
    
    public function test_EMAILé©—è­‰()
    {
        $service = new CustomerImportService();
        
        // æ¸¬è©¦æœ‰æ•ˆEMAIL
        $result = $this->invokeMethod($service, 'parseEmail', ['test@example.com']);
        $this->assertEquals('test@example.com', $result);
        
        // æ¸¬è©¦ç©ºå€¼
        $result = $this->invokeMethod($service, 'parseEmail', ['']);
        $this->assertNull($result);
        
        // æ¸¬è©¦ç„¡æ•ˆå€¼
        $result = $this->invokeMethod($service, 'parseEmail', ['0']);
        $this->assertNull($result);
    }
}
```

#### åŠŸèƒ½æ¸¬è©¦ç¯„ä¾‹

```php
// tests/Feature/CustomerImportTest.php
class CustomerImportTest extends TestCase
{
    public function test_å°é‡è³‡æ–™ç›´æ¥åŒ¯å…¥()
    {
        Storage::fake('local');
        
        $file = UploadedFile::fake()->create('test.xlsx', 100);
        
        $response = $this->post('/customers/import', [
            'file' => $file
        ]);
        
        $response->assertRedirect('/customers')
                 ->assertSessionHas('success');
    }
    
    public function test_å¤§é‡è³‡æ–™ä½‡åˆ—åŒ¯å…¥()
    {
        Storage::fake('local');
        
        // æ¨¡æ“¬å¤§æª”æ¡ˆ
        $file = UploadedFile::fake()->create('large.xlsx', 10000);
        
        $response = $this->post('/customers/import', [
            'file' => $file
        ]);
        
        $response->assertRedirect()
                 ->assertSessionHas('success');
    }
}
```

### éƒ¨ç½²æ³¨æ„äº‹é …

#### 1. ç’°å¢ƒè¨­å®š

**è¨˜æ†¶é«”é™åˆ¶**:
```ini
# php.ini
memory_limit = 2G
max_execution_time = 7200
upload_max_filesize = 50M
post_max_size = 50M
```

**ä½‡åˆ—è¨­å®š**:
```bash
# .env
QUEUE_CONNECTION=database
# æˆ– redis (å»ºè­°ç”Ÿç”¢ç’°å¢ƒ)
```

**ä½‡åˆ—åŸ·è¡Œ**:
```bash
# èƒŒæ™¯åŸ·è¡Œ
php artisan queue:work --timeout=7200 --memory=2048

# ä½¿ç”¨Supervisor (æ¨è–¦)
[program:lc-management-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /path/to/project/artisan queue:work --sleep=3 --tries=3 --timeout=7200
directory=/path/to/project
autostart=true
autorestart=true
user=www-data
numprocs=2
```

#### 2. è³‡æ–™åº«å„ªåŒ–

**ç´¢å¼•å»ºè­°**:
```sql
-- ImportSessionè¡¨
CREATE INDEX idx_import_sessions_session_id ON import_sessions(session_id);
CREATE INDEX idx_import_sessions_status ON import_sessions(status);
CREATE INDEX idx_import_sessions_created_at ON import_sessions(created_at);

-- Customerè¡¨  
CREATE INDEX idx_customers_id_number ON customers(id_number);
CREATE INDEX idx_customers_created_at ON customers(created_at);
```

#### 3. ç›£æ§è¨­å®š

**æ—¥èªŒç›£æ§**:
```bash
# ç›£æ§åŒ¯å…¥ç›¸é—œæ—¥èªŒ
tail -f storage/logs/laravel.log | grep -i import
```

**æ•ˆèƒ½ç›£æ§**:
- ç›£æ§è¨˜æ†¶é«”ä½¿ç”¨é‡
- ç›£æ§ä½‡åˆ—è™•ç†æ™‚é–“  
- ç›£æ§å¤±æ•—ä»»å‹™æ•¸é‡
- ç›£æ§è³‡æ–™åº«é€£ç·šæ•¸

---

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

#### 1. åŒ¯å…¥åœæ»¯ä¸å‰

**ç—‡ç‹€**: é€²åº¦é•·æ™‚é–“ä¸æ›´æ–°
**å¯èƒ½åŸå› **:
- ä½‡åˆ—è™•ç†å™¨æœªå•Ÿå‹•
- è¨˜æ†¶é«”ä¸è¶³
- è³‡æ–™åº«é€£ç·šä¸­æ–·

**è§£æ±ºæ–¹æ³•**:
```bash
# æª¢æŸ¥ä½‡åˆ—ç‹€æ…‹
php artisan queue:work --once --verbose

# æª¢æŸ¥å¤±æ•—ä»»å‹™
php artisan queue:failed

# é‡å•Ÿä½‡åˆ—
php artisan queue:restart

# æª¢æŸ¥è¨˜æ†¶é«”ä½¿ç”¨
php -r "echo 'Memory: ' . memory_get_usage(true)/1024/1024 . ' MB';"
```

#### 2. EMAILç´„æŸéŒ¯èª¤

**ç—‡ç‹€**: "Duplicate entry for key 'customers_email_unique'"
**åŸå› **: EMAILå”¯ä¸€ç´„æŸæœªæ­£ç¢ºç§»é™¤

**è§£æ±ºæ–¹æ³•**:
```bash
# æª¢æŸ¥ç´„æŸç‹€æ…‹
php artisan tinker
>>> DB::select("SHOW INDEX FROM customers WHERE Key_name = 'customers_email_unique'");

# æ‰‹å‹•ç§»é™¤ç´„æŸ
>>> DB::statement("ALTER TABLE customers DROP INDEX customers_email_unique");
```

#### 3. è¨˜æ†¶é«”ä¸è¶³

**ç—‡ç‹€**: "PHP Fatal error: Allowed memory size exhausted"
**è§£æ±ºæ–¹æ³•**:

èª¿æ•´æ‰¹æ¬¡å¤§å°:
```php
// CustomerImport.php
public function chunkSize(): int
{
    return 100; // æ¸›å°‘æ‰¹æ¬¡å¤§å°
}
```

å¢åŠ è¨˜æ†¶é«”é™åˆ¶:
```bash
php -d memory_limit=2G artisan queue:work
```

#### 4. æª”æ¡ˆæ ¼å¼éŒ¯èª¤

**ç—‡ç‹€**: Excelè®€å–å¤±æ•—æˆ–è³‡æ–™éŒ¯èª¤
**æª¢æŸ¥é …ç›®**:
- æª”æ¡ˆæ˜¯å¦ç‚º.xlsxæˆ–.xlsæ ¼å¼
- æ¨™é¡Œåˆ—æ˜¯å¦åœ¨ç¬¬ä¸€è¡Œ
- æ˜¯å¦æœ‰åˆä½µå„²å­˜æ ¼
- ç‰¹æ®Šå­—å…ƒç·¨ç¢¼å•é¡Œ

**è§£æ±ºæ–¹æ³•**:
```php
// å¢åŠ æª”æ¡ˆæ ¼å¼é©—è­‰
$reader = new \PhpOffice\PhpSpreadsheet\Reader\Xlsx;
if (!$reader->canRead($filePath)) {
    throw new Exception('æª”æ¡ˆæ ¼å¼ä¸æ”¯æ´');
}
```

### éŒ¯èª¤è¨Šæ¯è§£æ

| éŒ¯èª¤è¨Šæ¯ | åŸå›  | è§£æ±ºæ–¹æ³• |
|---------|------|----------|
| "ç¼ºå°‘èº«åˆ†è­‰è™Ÿ" | å¿…å¡«æ¬„ä½ç‚ºç©º | æª¢æŸ¥Excelè³‡æ–™å®Œæ•´æ€§ |
| "é›»å­éƒµä»¶æ ¼å¼éŒ¯èª¤" | EMAILæ ¼å¼ä¸æ­£ç¢º | ä¿®æ­£EMAILæ ¼å¼æˆ–ç•™ç©º |
| "æ‰¾ä¸åˆ°åŒ¯å…¥æœƒè©±" | Session IDç„¡æ•ˆ | æª¢æŸ¥URLåƒæ•¸æˆ–é‡æ–°åŒ¯å…¥ |
| "æª”æ¡ˆå¤§å°è¶…éé™åˆ¶" | æª”æ¡ˆè¶…é50MB | åˆ†å‰²æª”æ¡ˆæˆ–èª¿æ•´é™åˆ¶ |
| "è™•ç†è¶…æ™‚" | è™•ç†æ™‚é–“è¶…é2å°æ™‚ | æª¢æŸ¥è³‡æ–™é‡æˆ–ç³»çµ±æ•ˆèƒ½ |

### æ•ˆèƒ½èª¿å„ª

#### 1. è³‡æ–™åº«å„ªåŒ–

**é€£ç·šæ± è¨­å®š**:
```env
DB_CONNECTION=mysql
DB_POOL_SIZE=10
DB_MAX_CONNECTIONS=100
```

**æŸ¥è©¢å„ªåŒ–**:
```php
// ä½¿ç”¨æ‰¹æ¬¡æ’å…¥
DB::table('customers')->insert($batchData);

// é¿å…N+1æŸ¥è©¢
$customers = Customer::with('relations')->get();
```

#### 2. è¨˜æ†¶é«”å„ªåŒ–

**åƒåœ¾å›æ”¶**:
```php
// å®šæœŸæ¸…ç†è¨˜æ†¶é«”
if ($processedCount % 1000 === 0) {
    gc_collect_cycles();
}
```

**å¤§ç‰©ä»¶é‡‹æ”¾**:
```php
// è™•ç†å®Œæˆå¾Œé‡‹æ”¾ç‰©ä»¶
unset($spreadsheet, $worksheet);
```

#### 3. ä½‡åˆ—å„ªåŒ–

**å¤šé€²ç¨‹è™•ç†**:
```bash
# å•Ÿå‹•å¤šå€‹Worker
php artisan queue:work --queue=imports --sleep=1 &
php artisan queue:work --queue=imports --sleep=1 &
```

**å„ªå…ˆç´šè¨­å®š**:
```php
// é«˜å„ªå…ˆç´šåŒ¯å…¥
CustomerImport::dispatch($sessionId)->onQueue('high-priority');
```

### æ—¥èªŒåˆ†æ

#### é‡è¦æ—¥èªŒé—œéµå­—

```bash
# åŒ¯å…¥é–‹å§‹
grep "é–‹å§‹æ–°å®¢æˆ¶åŒ¯å…¥" storage/logs/laravel.log

# è™•ç†é€²åº¦
grep "ä½‡åˆ—é€²åº¦æ›´æ–°" storage/logs/laravel.log

# éŒ¯èª¤è¿½è¹¤
grep "å®¢æˆ¶åŒ¯å…¥è™•ç†å¤±æ•—" storage/logs/laravel.log

# æ•ˆèƒ½ç›£æ§
grep "processing_time\|memory_used" storage/logs/laravel.log
```

#### æ—¥èªŒæ ¼å¼ç¯„ä¾‹

```
[2025-08-27 10:30:15] local.INFO: é–‹å§‹æ–°å®¢æˆ¶åŒ¯å…¥ 
{
    "filename": "customers.xlsx",
    "file_size": 2048576,
    "user_id": 1
}

[2025-08-27 10:35:20] local.INFO: å®¢æˆ¶åŒ¯å…¥è™•ç†å®Œæˆ 
{
    "session_id": "12345678-1234-1234-1234-123456789abc",
    "result": {"processed": 1000, "success": 995, "errors": 5},
    "processing_time": "305ç§’",
    "memory_used": "128MB"
}
```

---

## ğŸ“‹ ç‰ˆæœ¬æ›´æ–°è¨˜éŒ„

### v2.0.0 (2025-08-27) - å…¨é¢é‡æ§‹

#### é‡å¤§è®Šæ›´
- âœ… **æ–°æ¶æ§‹**: æ¡ç”¨Service + Import + Sessionä¸‰å±¤æ¶æ§‹
- âœ… **EMAILç´„æŸä¿®å¾©**: ç§»é™¤uniqueç´„æŸï¼Œæ”¯æ´å¤šç­†ç©ºå€¼
- âœ… **ä¸­æ–‡æ¨™é¡Œæ”¯æ´**: å®Œå…¨æ”¯æ´ä¸­æ–‡Excelç¯„æœ¬
- âœ… **æ™ºèƒ½åŒ¯å…¥**: è‡ªå‹•é¸æ“‡ç›´æ¥/ä½‡åˆ—è™•ç†æ–¹å¼
- âœ… **é€²åº¦è¿½è¹¤**: å…¨æ–°ImportSessionæ¨¡å‹

#### æ–°å¢åŠŸèƒ½
- è¨˜æ†¶é«”å‹•æ…‹ç®¡ç†
- æ‰¹æ¬¡è™•ç†å„ªåŒ–
- éŒ¯èª¤è¨Šæ¯åœ‹éš›åŒ–
- APIé€²åº¦æŸ¥è©¢æ¥å£

#### ç§»é™¤åŠŸèƒ½
- èˆŠçš„CustomersImporté¡
- QueuedCustomersImporté¡  
- ProcessCustomerImportJob
- ImportProgressæ¨¡å‹

#### å‘ä¸‹ç›¸å®¹
- âœ… æ”¯æ´èˆŠçš„è‹±æ–‡æ¨™é¡ŒExcelæª”æ¡ˆ
- âœ… ä¿ç•™æ‰€æœ‰ç¾æœ‰Customeræ¨¡å‹æ¬„ä½
- âœ… APIè·¯ç”±ä¿æŒç›¸å®¹

### v1.x.x (æ­·å²ç‰ˆæœ¬)
- åŸºæœ¬åŒ¯å…¥åŠŸèƒ½
- è‹±æ–‡æ¨™é¡Œæ”¯æ´
- åŸºç¤é€²åº¦è¿½è¹¤

---

## ğŸ¤ è²¢ç»æŒ‡å—

### é–‹ç™¼æµç¨‹

1. Forkå°ˆæ¡ˆ
2. å»ºç«‹åŠŸèƒ½åˆ†æ”¯: `git checkout -b feature/new-feature`
3. æäº¤è®Šæ›´: `git commit -am 'Add new feature'`  
4. æ¨é€åˆ†æ”¯: `git push origin feature/new-feature`
5. å»ºç«‹Pull Request

### ç¨‹å¼ç¢¼è¦ç¯„

- éµå¾ªPSR-12ç¨‹å¼ç¢¼é¢¨æ ¼
- ä½¿ç”¨Laravel Pintæ ¼å¼åŒ–: `./vendor/bin/pint`
- æ’°å¯«å–®å…ƒæ¸¬è©¦
- æ›´æ–°ç›¸é—œæ–‡æª”

### æ¸¬è©¦è¦æ±‚

```bash
# åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
php artisan test

# æ¸¬è©¦è¦†è“‹ç‡
php artisan test --coverage

# ç‰¹å®šæ¸¬è©¦
php artisan test --filter=CustomerImportTest
```

---

## ğŸ“ æŠ€è¡“æ”¯æ´

### å•é¡Œå›å ±

å¦‚é‡åˆ°æŠ€è¡“å•é¡Œï¼Œè«‹æä¾›ä»¥ä¸‹è³‡è¨Šï¼š
- Laravelç‰ˆæœ¬
- PHPç‰ˆæœ¬  
- éŒ¯èª¤è¨Šæ¯
- å¾©ç¾æ­¥é©Ÿ
- ç›¸é—œæ—¥èªŒ

### è¯ç¹«æ–¹å¼

- GitHub Issues: å„ªå…ˆè™•ç†
- æŠ€è¡“æ–‡æª”: åƒè€ƒCLAUDE.md
- é–‹ç™¼æŒ‡å—: æœ¬æ–‡æª”é–‹ç™¼ç« ç¯€

---

*æœ€å¾Œæ›´æ–°: 2025-08-27*
*æ–‡æª”ç‰ˆæœ¬: v2.0.0*