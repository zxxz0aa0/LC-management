# 客戶管理匯入功能

## 📋 概述

LC-management系統的客戶匯入功能經過全面重構，提供了穩定、高效、易用的Excel批次匯入解決方案。新系統解決了EMAIL約束衝突、支援中文標題、提供智能匯入方式選擇，並具備完善的進度追蹤和錯誤處理機制。

### 主要特色

- ✅ **中英文標題支援**：自動識別中文和英文標題，向下相容舊格式
- ✅ **EMAIL約束修復**：支援多筆空EMAIL記錄匯入，無唯一約束衝突
- ✅ **智能匯入方式**：根據資料量自動選擇直接處理或佇列處理
- ✅ **實時進度追蹤**：完整的進度監控和錯誤報告
- ✅ **記憶體優化**：批次處理和動態記憶體管理
- ✅ **併發安全**：使用UUID會話ID，支援多使用者同時匯入

### 系統需求

- Laravel 10.x
- PHP 8.1+
- MySQL 5.7+
- maatwebsite/excel 3.1+
- 記憶體建議 >= 512MB

---

## 🏗️ 架構設計

### 整體架構

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   前端介面      │    │   Controller     │    │   Service       │
│                 │    │                  │    │                 │
│ • 檔案上傳      │◄──►│ CustomerController│◄──►│CustomerImportService│
│ • 進度監控      │    │ • import()       │    │ • processImport()│
│ • 錯誤顯示      │    │ • importProgress()│    │ • validateData() │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        ▼
                       ┌──────────────────┐    ┌─────────────────┐
                       │   Import Class   │    │   Database      │
                       │                  │    │                 │
                       │ CustomerImport   │    │ • customers     │
                       │ • ToCollection   │    │ • import_sessions│
                       │ • WithChunkReading│    │                 │
                       └──────────────────┘    └─────────────────┘
```

### 核心組件

#### 1. CustomerImportService
**位置**: `app/Services/CustomerImportService.php`
**職責**: 統一的匯入業務邏輯處理

```php
class CustomerImportService
{
    // 中英文標題對照
    private static $headerMapping = [
        '姓名' => 'name',
        '身分證號' => 'id_number',
        '出生年月日' => 'birthday',
        // ... 更多對照
    ];
    
    public function processImport(Collection $rows): array
    public function setImportSession(ImportSession $session)
}
```

#### 2. CustomerImport
**位置**: `app/Imports/CustomerImport.php`
**職責**: Laravel Excel匯入處理器

```php
class CustomerImport implements ShouldQueue, ToCollection, WithChunkReading
{
    public $timeout = 7200; // 2小時超時
    
    public function collection(Collection $rows)
    public function chunkSize(): int // 動態調整批次大小
}
```

#### 3. ImportSession Model
**位置**: `app/Models/ImportSession.php`
**職責**: 匯入會話管理和進度追蹤

```php
class ImportSession extends Model
{
    // 狀態: pending, processing, completed, failed
    public function getProgressPercentageAttribute(): float
    public function isCompleted(): bool
    public function isFailed(): bool
}
```

### 資料流程

```
1. 使用者上傳檔案
   ↓
2. 估算檔案行數
   ↓
3. 建立ImportSession
   ↓
4. 判斷處理方式 (< 1000筆直接處理 / >= 1000筆佇列處理)
   ↓
5. CustomerImport處理Excel資料
   ↓
6. CustomerImportService執行業務邏輯
   ↓
7. 批次寫入資料庫
   ↓
8. 更新ImportSession進度
   ↓
9. 返回結果或重定向至進度頁面
```

---

## 📖 使用指南

### 1. 下載匯入範本

**路由**: `GET /customers/template`
**控制器方法**: `CustomerController::downloadTemplate()`

```bash
# 直接下載
curl -O http://your-domain/customers/template

# 或在瀏覽器中訪問
http://your-domain/customers/template
```

### 2. 準備Excel檔案

#### 支援的標題格式

**中文標題**（推薦）:
```
姓名 | 身分證號 | 出生年月日 | 性別 | 聯絡電話 | 地址 | 聯絡人 | 聯絡人電話 | 關係 | 電子郵件 | 輪椅 | 爬梯機 | 共乘 | 身分別 | 備註 | a單位 | 個管師 | 特殊情況 | 縣市照顧 | 服務公司 | 照會日期 | 狀態
```

**英文標題**（相容）:
```
name | id_number | birthday | gender | phone_number | addresses | contact_person | contact_phone | contact_relationship | email | wheelchair | stair_climbing_machine | ride_sharing | identity | note | a_mechanism | a_manager | special_status | county_care | service_company | referral_date | status
```

#### 資料格式要求

| 欄位 | 格式 | 必填 | 說明 |
|------|------|------|------|
| 姓名 | 文字 | ✅ | 客戶姓名 |
| 身分證號 | 文字 | ✅ | 唯一識別碼 |
| 出生年月日 | YYYY-MM-DD | ❌ | 標準日期格式 |
| 電子郵件 | email格式 | ❌ | 可空白，支援多筆空值 |
| 聯絡電話 | 文字 | ❌ | 可用逗號分隔多筆 |
| 地址 | 文字 | ❌ | 可用逗號分隔多筆 |

#### EMAIL欄位特別說明
```
✅ 有效格式:
- test@example.com
- user@domain.com,admin@domain.com  (多筆用逗號分隔)
- (空白)  (支援多筆記錄都空白)

❌ 無效格式:
- 0
- null
- invalid-email
```

### 3. 執行匯入操作

#### 前端表單範例
```html
<form action="{{ route('customers.import') }}" method="POST" enctype="multipart/form-data">
    @csrf
    <div class="form-group">
        <label for="file">選擇Excel檔案</label>
        <input type="file" name="file" id="file" accept=".xlsx,.xls" required>
        <small class="text-muted">支援.xlsx和.xls格式，最大50MB</small>
    </div>
    <button type="submit" class="btn btn-primary">開始匯入</button>
</form>
```

#### 匯入方式自動選擇
- **小量資料** (< 1000筆): 直接處理，立即顯示結果
- **大量資料** (≥ 1000筆): 佇列處理，重定向至進度頁面

### 4. 進度監控

#### 進度頁面功能
- **實時進度條**: 顯示處理百分比
- **統計資訊**: 已處理/成功/錯誤/剩餘筆數
- **錯誤訊息**: 詳細的錯誤列表
- **自動重新整理**: 3秒間隔輪詢更新

#### JavaScript進度輪詢範例
```javascript
function fetchProgress() {
    fetch(`/api/customers/import-progress/${sessionId}`)
        .then(response => response.json())
        .then(data => {
            // 更新進度條
            document.getElementById('progress-bar').style.width = data.progress_percentage + '%';
            
            // 更新統計數字
            document.getElementById('processed-count').textContent = data.processed_rows;
            document.getElementById('success-count').textContent = data.success_count;
            document.getElementById('error-count').textContent = data.error_count;
            
            // 檢查是否完成
            if (data.status === 'completed' || data.status === 'failed') {
                clearInterval(pollInterval);
            }
        });
}
```

---

## 🔌 API文檔

### 路由列表

| 方法 | 路由 | 名稱 | 說明 |
|------|------|------|------|
| POST | `/customers/import` | customers.import | 執行匯入 |
| GET | `/customers/import-progress/{sessionId}` | customers.import.progress | 進度頁面 |
| GET | `/api/customers/import-progress/{sessionId}` | api.customers.import.progress | 進度API |
| GET | `/customers/template` | customers.template | 下載範本 |

### 1. 執行匯入

**POST** `/customers/import`

**請求參數**:
```json
{
    "file": "multipart/form-data Excel檔案"
}
```

**驗證規則**:
- file: required|file|mimes:xlsx,xls|max:51200 (50MB)

**成功回應**:
```json
// 小量資料直接處理
{
    "redirect": "/customers",
    "success": "匯入完成！成功：150 筆，錯誤：5 筆",
    "import_errors": ["第 10 列：缺少身分證號", "第 25 列：電子郵件格式錯誤"]
}

// 大量資料佇列處理  
{
    "redirect": "/customers/import-progress/uuid-session-id",
    "success": "大量匯入已開始處理，預計 5000 筆資料。請監控進度。"
}
```

**錯誤回應**:
```json
{
    "errors": {
        "file": ["匯入失敗：檔案格式錯誤"]
    }
}
```

### 2. 進度查詢API

**GET** `/api/customers/import-progress/{sessionId}`

**路徑參數**:
- sessionId: UUID格式的會話ID

**回應格式**:
```json
{
    "session_id": "12345678-1234-1234-1234-123456789abc",
    "filename": "customers.xlsx", 
    "total_rows": 1000,
    "processed_rows": 350,
    "success_count": 340,
    "error_count": 10,
    "status": "processing",
    "status_text": "處理中",
    "progress_percentage": 35.0,
    "remaining_rows": 650,
    "error_messages": [
        "第 15 列：缺少身分證號",
        "第 28 列：電子郵件格式錯誤"
    ],
    "started_at": "2025-08-27 10:30:15",
    "completed_at": null,
    "processing_time": 45
}
```

**狀態說明**:
- `pending`: 等待處理
- `processing`: 處理中  
- `completed`: 已完成
- `failed`: 失敗

### 3. 錯誤處理

**HTTP狀態碼**:
- 200: 成功
- 404: 找不到匯入會話
- 422: 驗證失敗
- 500: 伺服器錯誤

**錯誤訊息格式**:
```json
{
    "error": "找不到匯入會話",
    "session_id": "invalid-uuid"
}
```

---

## 👨‍💻 開發指南

### 程式碼結構

```
app/
├── Services/
│   └── CustomerImportService.php      # 匯入業務邏輯
├── Imports/
│   └── CustomerImport.php            # Excel處理器
├── Models/
│   ├── ImportSession.php             # 會話模型
│   └── Customer.php                  # 客戶模型
├── Http/Controllers/
│   └── CustomerController.php        # 控制器方法
└── Exports/
    └── CustomerTemplateExport.php     # 範本生成

resources/views/customers/
└── import-progress.blade.php          # 進度頁面

database/migrations/
├── 2025_08_27_075624_create_import_sessions_table.php
└── 2025_08_26_233024_modify_customers_email_remove_unique_constraint.php
```

### 核心類別詳解

#### CustomerImportService

**主要方法**:

```php
public function processImport(Collection $rows): array
{
    // 處理匯入的主要邏輯
    // 返回: ['processed' => int, 'success' => int, 'errors' => int, 'error_messages' => array]
}

public function setImportSession(ImportSession $session): self
{
    // 設定匯入會話，用於進度追蹤
}

private function mapHeaders(array $row, array $headers): array  
{
    // 中英文標題對照邏輯
}

private function validateCustomerData(array $data, int $rowNumber): array
{
    // 資料驗證邏輯
}

private function prepareCustomerData(array $data): array
{
    // 資料格式化和預處理
}
```

**記憶體優化策略**:
```php
private function processBatch(array $batch)
{
    DB::transaction(function () use ($batch) {
        foreach ($batch as $customerData) {
            Customer::updateOrCreate(
                ['id_number' => $customerData['id_number']],
                $customerData
            );
        }
    });
}
```

#### CustomerImport

**動態記憶體管理**:
```php
public function chunkSize(): int
{
    $memoryUsage = memory_get_usage(true);
    $memoryMB = $memoryUsage / 1024 / 1024;

    if ($memoryMB > 200) {
        return 100;  // 高記憶體使用時減少批次
    } elseif ($memoryMB > 100) {
        return 300;
    } else {
        return 500;  // 預設批次大小
    }
}
```

### 擴展開發

#### 1. 新增欄位支援

**步驟1**: 更新標題對照表
```php
// CustomerImportService.php
private static $headerMapping = [
    // 現有欄位...
    '新欄位中文' => 'new_field_english',
];
```

**步驟2**: 更新資料準備方法
```php
private function prepareCustomerData(array $data): array
{
    return [
        // 現有欄位...
        'new_field_english' => $data['new_field_english'] ?? null,
    ];
}
```

**步驟3**: 更新Customer模型$fillable
```php
// Customer.php
protected $fillable = [
    // 現有欄位...
    'new_field_english',
];
```

**步驟4**: 更新範本
```php
// CustomerTemplateExport.php
public function headings(): array
{
    return [
        // 現有標題...
        '新欄位中文',
    ];
}
```

#### 2. 自訂驗證規則

```php
private function validateCustomerData(array $data, int $rowNumber): array
{
    // 現有驗證...
    
    // 新增自訂驗證
    if (!empty($data['new_field']) && !preg_match('/^pattern$/', $data['new_field'])) {
        return [
            'valid' => false,
            'error' => "第 {$rowNumber} 列：新欄位格式錯誤"
        ];
    }
    
    return ['valid' => true];
}
```

#### 3. 新增匯入後處理

```php
private function processBatch(array $batch)
{
    DB::transaction(function () use ($batch) {
        foreach ($batch as $customerData) {
            $customer = Customer::updateOrCreate(
                ['id_number' => $customerData['id_number']],
                $customerData
            );
            
            // 新增後處理邏輯
            $this->postProcessCustomer($customer, $customerData);
        }
    });
}

private function postProcessCustomer(Customer $customer, array $data)
{
    // 例如: 發送歡迎郵件、建立關聯記錄等
}
```

### 測試指南

#### 單元測試範例

```php
// tests/Unit/CustomerImportServiceTest.php
class CustomerImportServiceTest extends TestCase
{
    public function test_中文標題對照()
    {
        $service = new CustomerImportService();
        $headers = ['姓名', '身分證號', '電子郵件'];
        $row = ['王小明', 'A123456789', 'test@example.com'];
        
        $result = $this->invokeMethod($service, 'mapHeaders', [$row, $headers]);
        
        $this->assertEquals('王小明', $result['name']);
        $this->assertEquals('A123456789', $result['id_number']);
        $this->assertEquals('test@example.com', $result['email']);
    }
    
    public function test_EMAIL驗證()
    {
        $service = new CustomerImportService();
        
        // 測試有效EMAIL
        $result = $this->invokeMethod($service, 'parseEmail', ['test@example.com']);
        $this->assertEquals('test@example.com', $result);
        
        // 測試空值
        $result = $this->invokeMethod($service, 'parseEmail', ['']);
        $this->assertNull($result);
        
        // 測試無效值
        $result = $this->invokeMethod($service, 'parseEmail', ['0']);
        $this->assertNull($result);
    }
}
```

#### 功能測試範例

```php
// tests/Feature/CustomerImportTest.php
class CustomerImportTest extends TestCase
{
    public function test_小量資料直接匯入()
    {
        Storage::fake('local');
        
        $file = UploadedFile::fake()->create('test.xlsx', 100);
        
        $response = $this->post('/customers/import', [
            'file' => $file
        ]);
        
        $response->assertRedirect('/customers')
                 ->assertSessionHas('success');
    }
    
    public function test_大量資料佇列匯入()
    {
        Storage::fake('local');
        
        // 模擬大檔案
        $file = UploadedFile::fake()->create('large.xlsx', 10000);
        
        $response = $this->post('/customers/import', [
            'file' => $file
        ]);
        
        $response->assertRedirect()
                 ->assertSessionHas('success');
    }
}
```

### 部署注意事項

#### 1. 環境設定

**記憶體限制**:
```ini
# php.ini
memory_limit = 2G
max_execution_time = 7200
upload_max_filesize = 50M
post_max_size = 50M
```

**佇列設定**:
```bash
# .env
QUEUE_CONNECTION=database
# 或 redis (建議生產環境)
```

**佇列執行**:
```bash
# 背景執行
php artisan queue:work --timeout=7200 --memory=2048

# 使用Supervisor (推薦)
[program:lc-management-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /path/to/project/artisan queue:work --sleep=3 --tries=3 --timeout=7200
directory=/path/to/project
autostart=true
autorestart=true
user=www-data
numprocs=2
```

#### 2. 資料庫優化

**索引建議**:
```sql
-- ImportSession表
CREATE INDEX idx_import_sessions_session_id ON import_sessions(session_id);
CREATE INDEX idx_import_sessions_status ON import_sessions(status);
CREATE INDEX idx_import_sessions_created_at ON import_sessions(created_at);

-- Customer表  
CREATE INDEX idx_customers_id_number ON customers(id_number);
CREATE INDEX idx_customers_created_at ON customers(created_at);
```

#### 3. 監控設定

**日誌監控**:
```bash
# 監控匯入相關日誌
tail -f storage/logs/laravel.log | grep -i import
```

**效能監控**:
- 監控記憶體使用量
- 監控佇列處理時間  
- 監控失敗任務數量
- 監控資料庫連線數

---

## 🔧 故障排除

### 常見問題

#### 1. 匯入停滯不前

**症狀**: 進度長時間不更新
**可能原因**:
- 佇列處理器未啟動
- 記憶體不足
- 資料庫連線中斷

**解決方法**:
```bash
# 檢查佇列狀態
php artisan queue:work --once --verbose

# 檢查失敗任務
php artisan queue:failed

# 重啟佇列
php artisan queue:restart

# 檢查記憶體使用
php -r "echo 'Memory: ' . memory_get_usage(true)/1024/1024 . ' MB';"
```

#### 2. EMAIL約束錯誤

**症狀**: "Duplicate entry for key 'customers_email_unique'"
**原因**: EMAIL唯一約束未正確移除

**解決方法**:
```bash
# 檢查約束狀態
php artisan tinker
>>> DB::select("SHOW INDEX FROM customers WHERE Key_name = 'customers_email_unique'");

# 手動移除約束
>>> DB::statement("ALTER TABLE customers DROP INDEX customers_email_unique");
```

#### 3. 記憶體不足

**症狀**: "PHP Fatal error: Allowed memory size exhausted"
**解決方法**:

調整批次大小:
```php
// CustomerImport.php
public function chunkSize(): int
{
    return 100; // 減少批次大小
}
```

增加記憶體限制:
```bash
php -d memory_limit=2G artisan queue:work
```

#### 4. 檔案格式錯誤

**症狀**: Excel讀取失敗或資料錯誤
**檢查項目**:
- 檔案是否為.xlsx或.xls格式
- 標題列是否在第一行
- 是否有合併儲存格
- 特殊字元編碼問題

**解決方法**:
```php
// 增加檔案格式驗證
$reader = new \PhpOffice\PhpSpreadsheet\Reader\Xlsx;
if (!$reader->canRead($filePath)) {
    throw new Exception('檔案格式不支援');
}
```

### 錯誤訊息解析

| 錯誤訊息 | 原因 | 解決方法 |
|---------|------|----------|
| "缺少身分證號" | 必填欄位為空 | 檢查Excel資料完整性 |
| "電子郵件格式錯誤" | EMAIL格式不正確 | 修正EMAIL格式或留空 |
| "找不到匯入會話" | Session ID無效 | 檢查URL參數或重新匯入 |
| "檔案大小超過限制" | 檔案超過50MB | 分割檔案或調整限制 |
| "處理超時" | 處理時間超過2小時 | 檢查資料量或系統效能 |

### 效能調優

#### 1. 資料庫優化

**連線池設定**:
```env
DB_CONNECTION=mysql
DB_POOL_SIZE=10
DB_MAX_CONNECTIONS=100
```

**查詢優化**:
```php
// 使用批次插入
DB::table('customers')->insert($batchData);

// 避免N+1查詢
$customers = Customer::with('relations')->get();
```

#### 2. 記憶體優化

**垃圾回收**:
```php
// 定期清理記憶體
if ($processedCount % 1000 === 0) {
    gc_collect_cycles();
}
```

**大物件釋放**:
```php
// 處理完成後釋放物件
unset($spreadsheet, $worksheet);
```

#### 3. 佇列優化

**多進程處理**:
```bash
# 啟動多個Worker
php artisan queue:work --queue=imports --sleep=1 &
php artisan queue:work --queue=imports --sleep=1 &
```

**優先級設定**:
```php
// 高優先級匯入
CustomerImport::dispatch($sessionId)->onQueue('high-priority');
```

### 日誌分析

#### 重要日誌關鍵字

```bash
# 匯入開始
grep "開始新客戶匯入" storage/logs/laravel.log

# 處理進度
grep "佇列進度更新" storage/logs/laravel.log

# 錯誤追蹤
grep "客戶匯入處理失敗" storage/logs/laravel.log

# 效能監控
grep "processing_time\|memory_used" storage/logs/laravel.log
```

#### 日誌格式範例

```
[2025-08-27 10:30:15] local.INFO: 開始新客戶匯入 
{
    "filename": "customers.xlsx",
    "file_size": 2048576,
    "user_id": 1
}

[2025-08-27 10:35:20] local.INFO: 客戶匯入處理完成 
{
    "session_id": "12345678-1234-1234-1234-123456789abc",
    "result": {"processed": 1000, "success": 995, "errors": 5},
    "processing_time": "305秒",
    "memory_used": "128MB"
}
```

---

## 📋 版本更新記錄

### v2.0.0 (2025-08-27) - 全面重構

#### 重大變更
- ✅ **新架構**: 採用Service + Import + Session三層架構
- ✅ **EMAIL約束修復**: 移除unique約束，支援多筆空值
- ✅ **中文標題支援**: 完全支援中文Excel範本
- ✅ **智能匯入**: 自動選擇直接/佇列處理方式
- ✅ **進度追蹤**: 全新ImportSession模型

#### 新增功能
- 記憶體動態管理
- 批次處理優化
- 錯誤訊息國際化
- API進度查詢接口

#### 移除功能
- 舊的CustomersImport類
- QueuedCustomersImport類  
- ProcessCustomerImportJob
- ImportProgress模型

#### 向下相容
- ✅ 支援舊的英文標題Excel檔案
- ✅ 保留所有現有Customer模型欄位
- ✅ API路由保持相容

### v1.x.x (歷史版本)
- 基本匯入功能
- 英文標題支援
- 基礎進度追蹤

---

## 🤝 貢獻指南

### 開發流程

1. Fork專案
2. 建立功能分支: `git checkout -b feature/new-feature`
3. 提交變更: `git commit -am 'Add new feature'`  
4. 推送分支: `git push origin feature/new-feature`
5. 建立Pull Request

### 程式碼規範

- 遵循PSR-12程式碼風格
- 使用Laravel Pint格式化: `./vendor/bin/pint`
- 撰寫單元測試
- 更新相關文檔

### 測試要求

```bash
# 執行所有測試
php artisan test

# 測試覆蓋率
php artisan test --coverage

# 特定測試
php artisan test --filter=CustomerImportTest
```

---

## 📞 技術支援

### 問題回報

如遇到技術問題，請提供以下資訊：
- Laravel版本
- PHP版本  
- 錯誤訊息
- 復現步驟
- 相關日誌

### 聯繫方式

- GitHub Issues: 優先處理
- 技術文檔: 參考CLAUDE.md
- 開發指南: 本文檔開發章節

---

*最後更新: 2025-08-27*
*文檔版本: v2.0.0*