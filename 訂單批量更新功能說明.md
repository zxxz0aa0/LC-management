# 訂單批量更新功能說明

## 📋 功能概述

訂單批量更新功能允許使用者透過上傳 Excel 檔案來批量更新現有訂單的資訊，包括駕駛指派、媒合時間和訂單狀態等。此功能特別支援共乘訂單的同步更新，確保共乘群組內所有訂單保持一致。

**主要特點**：
- 📝 支援批量更新訂單駕駛、媒合時間、狀態
- 🚗 智能駕駛匹配：輸入隊員編號自動填入完整駕駛資訊
- 🔗 共乘同步：自動識別並同步更新共乘組合的所有訂單
- ⚡ 效能優化：分塊讀取、快取機制、事務管理
- 🛡️ 容錯機制：單行錯誤不影響整體處理

---

## 📂 相關檔案結構

```
├── resources/views/orders/components/order-table.blade.php  (前端介面：第 13-15、378-469 行)
├── routes/web.php:65                                        (路由定義)
├── app/Http/Controllers/OrderController.php:1654-1680       (控制器方法)
└── app/Imports/OrderBatchUpdateImport.php                   (核心邏輯實作)
```

---

## 🔄 完整處理流程

### 1. 前端觸發

**位置**：`resources/views/orders/components/order-table.blade.php` 第 13-15 行

```html
<button type="button" class="btn btn-outline-dark"
        data-bs-toggle="modal"
        data-bs-target="#batchUpdateModal">
    <i class="fas fa-edit me-2"></i>批量更新
</button>
```

### 2. Modal 表單

**位置**：`resources/views/orders/components/order-table.blade.php` 第 378-469 行

- **提交路由**: `POST /orders/batch-update`
- **檔案類型**: `.xlsx`, `.xls`
- **表單欄位**: 檔案上傳欄位

**使用說明重點**：
- A欄（訂單編號）：用於查詢要更新的訂單，必填
- E欄（隊員編號）：更新駕駛資訊，對應 drivers 表的 fleet_number
- H欄（媒合時間）：更新媒合時間，格式：YYYY-MM-DD HH:MM:SS
- O欄（狀態）：更新訂單狀態（待搶單/已指派/已取消/已候補/已完成）
- 系統會根據訂單編號查詢現有訂單並更新相應欄位
- 找不到的訂單編號會被跳過
- 駕駛資訊會根據隊員編號自動填入駕駛姓名、車牌等

### 3. 路由處理

**位置**：`routes/web.php` 第 65 行

```php
Route::post('/orders/batch-update', [OrderController::class, 'batchUpdate'])
    ->name('orders.batch-update');
```

### 4. 控制器處理

**位置**：`app/Http/Controllers/OrderController.php` 第 1654-1680 行

```php
public function batchUpdate(Request $request)
{
    // 1. 驗證上傳檔案
    $request->validate([
        'file' => 'required|file|mimes:xlsx,xls',
    ]);

    // 2. 使用專門的 Import 類別處理批量更新
    $importer = new \App\Imports\OrderBatchUpdateImport;
    Excel::import($importer, $request->file('file'));

    // 3. 收集處理結果
    $success = $importer->successCount;
    $fail = $importer->skipCount;
    $errors = $importer->errorMessages;

    // 4. 返回結果訊息
    return redirect()->route('orders.index')->with([
        'success' => "批量更新完成：成功 {$success} 筆，失敗 {$fail} 筆。",
        'import_errors' => $errors,
    ]);
}
```

### 5. 核心邏輯實作

**位置**：`app/Imports/OrderBatchUpdateImport.php`

**實作介面**：
- `ToCollection`: 處理 Excel 資料集合
- `WithChunkReading`: 支援分塊讀取

**核心屬性**：
- `$successCount`: 成功更新數量
- `$skipCount`: 跳過數量
- `$errorMessages`: 錯誤訊息陣列
- `$driverCache`: 駕駛快取（避免重複查詢）

---

## 📊 支援的更新欄位

| Excel 欄位 | 索引 | 資料庫欄位 | 說明 | 是否必填 |
|-----------|------|-----------|------|---------|
| **A 欄** | 0 | `order_number` | 訂單編號（用於查詢） | ✅ 必填 |
| **E 欄** | 4 | `driver_*` | 隊員編號（對應 drivers.fleet_number） | ❌ 選填 |
| **H 欄** | 7 | `match_time` | 媒合時間 | ❌ 選填 |
| **O 欄** | 14 | `status` | 訂單狀態 | ❌ 選填 |

### Excel 欄位格式範例

| A欄 | B欄 | C欄 | D欄 | E欄 | F欄 | G欄 | H欄 | ... | O欄 |
|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
| 訂單編號 | - | - | - | 隊員編號 | - | - | 媒合時間 | ... | 狀態 |
| ORD20250829001 | | | | A001 | | | 2025-08-29 08:30 | | 已指派 |

---

## 🚀 核心業務邏輯

### 1. 訂單查詢邏輯

```php
// 根據訂單編號查詢
$orderNumber = trim($row[0] ?? ''); // A欄
$order = Order::where('order_number', $orderNumber)->first();

if (!$order) {
    throw new \Exception("找不到訂單編號：{$orderNumber}");
}
```

**驗證規則**：
- 訂單編號不可為空
- 必須存在於資料庫中

---

### 2. 駕駛資訊自動填入（E 欄）

當 E 欄（隊員編號）有值時，系統會自動查詢並填入完整駕駛資訊。

#### 駕駛查詢與快取機制

```php
private function getDriverByFleetNumber(string $fleetNumber): ?Driver
{
    // 使用快取避免重複查詢
    if (!isset($this->driverCache[$fleetNumber])) {
        $this->driverCache[$fleetNumber] = Driver::where('fleet_number', $fleetNumber)
            ->first();
    }

    return $this->driverCache[$fleetNumber];
}
```

#### 自動填入駕駛資訊

```php
if (!empty($fleetNumber)) {
    $driver = $this->getDriverByFleetNumber($fleetNumber);
    if ($driver) {
        $updateData['driver_id'] = $driver->id;
        $updateData['driver_name'] = $driver->name;
        $updateData['driver_plate_number'] = $driver->plate_number;
        $updateData['driver_fleet_number'] = $driver->fleet_number;
    } else {
        Log::warning("找不到隊員編號：{$fleetNumber}");
    }
}
```

**特點**：
- ✅ 一次輸入隊員編號，自動填入 4 個駕駛相關欄位
- ✅ 使用快取機制避免重複查詢相同駕駛
- ✅ 找不到駕駛時記錄警告但不中斷流程

---

### 3. 媒合時間處理（H 欄）

#### 支援多種日期時間格式

```php
private function parseDateTime(string $dateTimeString): Carbon
{
    $formats = [
        'Y-m-d H:i:s',    // 2025-08-29 08:30:00
        'Y/m/d H:i:s',    // 2025/08/29 08:30:00
        'Y-m-d H:i',      // 2025-08-29 08:30
        'Y/m/d H:i',      // 2025/08/29 08:30
        'Y-m-d',          // 2025-08-29
        'Y/m/d',          // 2025/08/29
        'H:i:s',          // 08:30:00
        'H:i',            // 08:30
    ];

    // 逐個格式嘗試解析
    foreach ($formats as $format) {
        try {
            return Carbon::createFromFormat($format, $dateTimeString);
        } catch (\Exception $e) {
            continue;
        }
    }

    // 最後嘗試 Carbon 自動解析
    return Carbon::parse($dateTimeString);
}
```

#### 處理邏輯

```php
if (!empty($matchTime) && $matchTime !== '-') {
    try {
        $updateData['match_time'] = $this->parseDateTime($matchTime);
    } catch (\Exception $e) {
        Log::warning("第 {$rowNumber} 行：媒合時間格式錯誤 {$matchTime}，跳過此欄位");
    }
}
```

**特殊處理**：
- 如果值為 `-`，則跳過不更新
- 格式錯誤時記錄警告但不中斷整個流程
- 支援 8 種常見日期時間格式

---

### 4. 訂單狀態更新（O 欄）

#### 狀態對照表

| 中文狀態 | 英文代碼 | 說明 |
|---------|---------|------|
| 待搶單 | `open` | 可派遣狀態 |
| 已指派 | `assigned` | 已指派駕駛 |
| 已取消 | `cancelled` | 已取消 |
| 已候補 | `bkorder` | 候補狀態 |
| 已完成 | `completed` | 已完成 |

#### 處理邏輯

```php
$statusMapping = [
    '待搶單' => 'open',
    '已指派' => 'assigned',
    '已取消' => 'cancelled',
    '已候補' => 'bkorder',
    '已完成' => 'completed',
];

// 移除 HTML 標籤並轉換
$cleanStatus = strip_tags($status);
if (array_key_exists($cleanStatus, $statusMapping)) {
    $updateData['status'] = $statusMapping[$cleanStatus];
} else {
    Log::warning("第 {$rowNumber} 行：未知的狀態值 {$status}，跳過此欄位");
}
```

**特點**：
- ✅ 支援中文狀態名稱，自動轉換為英文代碼
- ✅ 自動移除可能的 HTML 標籤
- ✅ 未知狀態值時記錄警告但不中斷

---

## 🔗 共乘訂單同步更新（核心亮點）

這是批量更新功能的**最重要特性**：當更新一個共乘訂單時，會**自動同步更新同組所有訂單**。

### 共乘群組查詢

```php
private function getCarpoolGroupOrders(Order $order): Collection
{
    // 如果不是共乘訂單，只返回自己
    if (empty($order->carpool_group_id)) {
        return collect([$order]);
    }

    // 查詢同一個共乘群組的所有訂單
    return Order::where('carpool_group_id', $order->carpool_group_id)
        ->where('is_group_dissolved', false) // 排除已解散的群組
        ->get();
}
```

### 批量同步更新

```php
// 使用事務確保原子性
DB::transaction(function () use ($order, $updateData) {
    // 1. 找出所有需要同步更新的共乘訂單
    $ordersToUpdate = $this->getCarpoolGroupOrders($order);
    $updatedCount = 0;

    // 2. 批量更新所有訂單
    foreach ($ordersToUpdate as $orderToUpdate) {
        $orderToUpdate->update($updateData);
        $updatedCount++;

        Log::info('成功更新訂單', [
            'order_number' => $orderToUpdate->order_number,
            'updates' => array_keys($updateData),
            'is_carpool_sync' => count($ordersToUpdate) > 1,
        ]);
    }

    $this->successCount += $updatedCount;
});
```

### 實際案例說明

**情境**：有一個共乘群組包含 3 筆訂單（訂單編號：ORD001、ORD002、ORD003）

**Excel 更新內容**：只更新 ORD001 的駕駛為「王小明（隊編 A001）」

| A欄（訂單編號） | E欄（隊員編號） | O欄（狀態） |
|---------------|---------------|-----------|
| ORD001 | A001 | 已指派 |

**更新前狀態**：
```
ORD001: 駕駛 = 空，狀態 = 待搶單
ORD002: 駕駛 = 空，狀態 = 待搶單
ORD003: 駕駛 = 空，狀態 = 待搶單
```

**更新後狀態（系統自動同步）**：
```
ORD001: 駕駛 = 王小明（A001），狀態 = 已指派
ORD002: 駕駛 = 王小明（A001），狀態 = 已指派 ← 自動同步
ORD003: 駕駛 = 王小明（A001），狀態 = 已指派 ← 自動同步
```

**重要特性**：
- ✅ 只需更新一筆，同組所有訂單自動同步
- ✅ 使用事務確保原子性（全部成功或全部失敗）
- ✅ 排除已解散的共乘群組
- ✅ 詳細記錄每筆更新
- ✅ 成功計數包含所有同步更新的訂單

---

## ⚡ 效能優化措施

### 1. 分塊讀取

避免一次性載入大量資料造成記憶體溢出。

```php
public function chunkSize(): int
{
    return 100; // 每次處理 100 行
}
```

### 2. 駕駛快取機制

避免重複查詢相同的駕駛資訊。

```php
private $driverCache = [];

private function getDriverByFleetNumber(string $fleetNumber): ?Driver
{
    // 快取檢查
    if (!isset($this->driverCache[$fleetNumber])) {
        $this->driverCache[$fleetNumber] = Driver::where('fleet_number', $fleetNumber)
            ->first();
    }

    return $this->driverCache[$fleetNumber];
}
```

**效益**：
- 假設 100 筆訂單都指派給同一個駕駛（隊編 A001）
- 無快取：查詢資料庫 100 次
- 有快取：只查詢資料庫 1 次

### 3. 事務管理

使用資料庫事務確保資料一致性。

```php
DB::transaction(function () use ($order, $updateData) {
    // 批量更新共乘訂單
    foreach ($ordersToUpdate as $orderToUpdate) {
        $orderToUpdate->update($updateData);
    }
});
```

### 4. 記憶體監控

記錄處理前後的記憶體使用情況，便於效能分析。

```php
public function collection(Collection $rows)
{
    $startTime = microtime(true);
    $startMemory = memory_get_usage(true);

    // 處理資料...

    $processingTime = round(microtime(true) - $startTime, 2);
    $memoryUsed = memory_get_usage(true) - $startMemory;

    Log::info('批量更新匯入完成', [
        'success_count' => $this->successCount,
        'skip_count' => $this->skipCount,
        'processing_time' => $processingTime.'秒',
        'memory_used' => $this->formatBytes($memoryUsed),
        'peak_memory' => $this->formatBytes(memory_get_peak_usage(true)),
    ]);
}
```

---

## 🛡️ 錯誤處理機制

### 1. 行級錯誤處理

單行錯誤不會中斷整個匯入流程。

```php
foreach ($dataRows as $index => $row) {
    try {
        $this->processRow($row, $index + 2);
    } catch (\Exception $e) {
        $this->skipCount++;
        $this->errorMessages[] = '第 '.($index + 2).' 行處理失敗：'.$e->getMessage();
        Log::error('批量更新行處理失敗', [
            'row' => $index + 2,
            'data' => $row->toArray(),
            'error' => $e->getMessage(),
        ]);
        // 繼續處理下一行
    }
}
```

### 2. 欄位級警告

某些欄位錯誤時記錄警告但不中斷。

```php
// 駕駛不存在
if (!$driver) {
    Log::warning("第 {$rowNumber} 行：找不到隊員編號 {$fleetNumber}，跳過駕駛欄位");
    // 繼續處理其他欄位
}

// 時間格式錯誤
catch (\Exception $e) {
    Log::warning("第 {$rowNumber} 行：媒合時間格式錯誤 {$matchTime}，跳過此欄位");
    // 繼續處理其他欄位
}

// 未知狀態值
if (!array_key_exists($cleanStatus, $statusMapping)) {
    Log::warning("第 {$rowNumber} 行：未知的狀態值 {$status}，跳過此欄位");
    // 繼續處理其他欄位
}
```

### 3. 驗證失敗處理

關鍵驗證失敗時拋出例外，跳過該行。

```php
// 訂單編號為空
if (empty($orderNumber)) {
    throw new \Exception('訂單編號不可為空');
}

// 找不到訂單
if (!$order) {
    throw new \Exception("找不到訂單編號：{$orderNumber}");
}
```

### 錯誤處理層級總結

| 錯誤類型 | 處理方式 | 影響範圍 |
|---------|---------|---------|
| 訂單編號為空 | 拋出例外 | 跳過該行 |
| 找不到訂單 | 拋出例外 | 跳過該行 |
| 找不到駕駛 | 記錄警告 | 跳過駕駛欄位，繼續處理其他欄位 |
| 時間格式錯誤 | 記錄警告 | 跳過時間欄位，繼續處理其他欄位 |
| 未知狀態值 | 記錄警告 | 跳過狀態欄位，繼續處理其他欄位 |

---

## 📈 處理結果展示

### 成功訊息

更新完成後，使用者會看到：

```
✅ 批量更新完成：成功 15 筆，失敗 2 筆。
```

### 錯誤詳情 Modal

如果有失敗的行，會自動彈出錯誤詳情視窗：

```
⚠️ 匯入錯誤詳情

以下資料列無法匯入，請檢查後重新匯入：

❌ 第 3 行處理失敗：找不到訂單編號：ORD20250829999
❌ 第 7 行處理失敗：訂單編號不可為空
```

### 日誌記錄

系統會在 Laravel 日誌中記錄詳細資訊：

```
[2025-11-20 10:30:45] INFO: 成功更新訂單
{
    "order_number": "ORD20250829001",
    "updates": ["driver_id", "driver_name", "driver_fleet_number", "status"],
    "is_carpool_sync": true
}

[2025-11-20 10:30:45] INFO: 批量更新匯入完成
{
    "success_count": 15,
    "skip_count": 2,
    "processing_time": "1.23秒",
    "memory_used": "2.5 MB",
    "peak_memory": "8.7 MB"
}
```

---

## 🎯 總結與亮點

### 核心亮點

1. **✅ 智能駕駛匹配**
   - 輸入隊員編號，自動填入完整駕駛資訊（ID、姓名、車牌、隊編）
   - 使用快取機制避免重複查詢，提升效能

2. **✅ 共乘同步更新**
   - 自動識別共乘關係
   - 更新一筆訂單，同組所有訂單自動同步
   - 使用事務確保資料一致性

3. **✅ 多格式支援**
   - 支援 8 種日期時間格式
   - 支援中文狀態名稱，自動轉換為英文代碼
   - 自動移除 HTML 標籤

4. **✅ 容錯機制**
   - 單行錯誤不影響整體處理
   - 欄位級警告不中斷流程
   - 詳細的錯誤訊息和日誌記錄

5. **✅ 效能優化**
   - 分塊讀取（100 行/批）避免記憶體溢出
   - 駕駛快取機制減少資料庫查詢
   - 事務管理確保資料完整性
   - 記憶體監控便於效能分析

6. **✅ 詳細日誌**
   - 記錄每筆更新的詳細資訊
   - 記錄處理時間和記憶體使用情況
   - 便於問題追蹤和效能分析

### 適用場景

- 📋 批量指派駕駛給多筆訂單
- 🕐 批量更新訂單媒合時間
- 📊 批量更新訂單狀態
- 🔗 共乘訂單的統一管理
- 📂 從外部系統匯入更新資料

### 技術特性

- **資料庫事務**：確保共乘訂單同步更新的原子性
- **快取機制**：減少重複查詢，提升效能
- **分塊處理**：支援大量資料處理而不溢位
- **錯誤隔離**：單行錯誤不影響其他行
- **詳細日誌**：完整追蹤處理過程

---

## 📝 使用建議

### 最佳實踐

1. **檔案準備**
   - 使用「下載範本」功能取得正確格式
   - 先匯出現有訂單，修改後再匯入（確保訂單編號正確）

2. **駕駛指派**
   - 確保隊員編號（fleet_number）在 drivers 表中存在
   - 使用標準化的隊員編號格式

3. **時間格式**
   - 建議使用 `YYYY-MM-DD HH:MM:SS` 格式（最標準）
   - 避免使用特殊符號或非標準格式

4. **狀態更新**
   - 使用中文狀態名稱（待搶單、已指派、已取消、已候補、已完成）
   - 確保狀態轉換符合業務邏輯

5. **共乘訂單**
   - 只需更新共乘群組中的任一筆訂單
   - 系統會自動同步更新同組所有訂單
   - 無需重複更新每一筆

### 常見問題

**Q1: 更新失敗但沒有錯誤訊息？**
- 檢查 Laravel 日誌 (`storage/logs/laravel.log`)
- 確認訂單編號是否正確
- 確認 Excel 欄位格式是否符合規範

**Q2: 駕駛資訊沒有自動填入？**
- 檢查隊員編號（E 欄）是否正確
- 確認 drivers 表中是否存在該 fleet_number
- 查看日誌是否有「找不到隊員編號」警告

**Q3: 共乘訂單沒有同步更新？**
- 檢查 `carpool_group_id` 是否一致
- 確認 `is_group_dissolved` 是否為 false
- 查看日誌中的 `is_carpool_sync` 欄位

**Q4: 記憶體不足錯誤？**
- 減少單次上傳的資料量
- 檢查 PHP memory_limit 設定
- 查看日誌中的記憶體使用情況

---

## 🔧 維護注意事項

### 定期檢查

1. **駕駛資料完整性**
   - 確保所有駕駛都有正確的 fleet_number
   - 定期清理無效駕駛資料

2. **共乘群組狀態**
   - 定期檢查是否有殘留的共乘群組
   - 確認已解散群組的 `is_group_dissolved` 標記正確

3. **日誌管理**
   - 定期檢查錯誤日誌
   - 分析處理時間和記憶體使用趨勢

### 效能監控

1. **處理時間**
   - 正常情況：100 筆訂單約 1-2 秒
   - 超過 5 秒應檢查資料庫索引

2. **記憶體使用**
   - 正常情況：100 筆訂單約 2-5 MB
   - 超過 10 MB 應檢查是否有記憶體洩漏

3. **快取效果**
   - 查看日誌中駕駛查詢次數
   - 快取命中率應達 80% 以上（多筆訂單指派同一駕駛時）

---

## 📚 相關文件

- [CLAUDE.md](CLAUDE.md) - 專案整體說明
- [共乘單方案.md](共乘單方案.md) - 共乘功能設計文件
- [訂單建立多天功能.md](訂單建立多天功能.md) - 批量訂單建立規劃
- [EXCEL_匯入格式規格說明.md](EXCEL_匯入格式規格說明.md) - Excel 匯入格式定義

---

**最後更新**：2025-11-20
**文件版本**：1.0
**維護人員**：開發團隊
