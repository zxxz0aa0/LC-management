# å…±ä¹˜ç³»çµ±è¦åŠƒè¨­è¨ˆæ–‡ä»¶

æœ¬æ–‡ä»¶è¨˜éŒ„ LC-management é•·ç…§æœå‹™ç®¡ç†ç³»çµ±ä¸­å…±ä¹˜åŠŸèƒ½çš„å®Œæ•´è¨­è¨ˆè¦åŠƒï¼ŒåŒ…å«æ¥­å‹™éœ€æ±‚åˆ†æã€æŠ€è¡“æ–¹æ¡ˆè¨­è¨ˆã€å¯¦ä½œæŒ‡å—å’Œæœªä¾†æ“´å±•ç­–ç•¥ã€‚

## ğŸ“‹ æ–‡ä»¶ç›®éŒ„

1. [å…±ä¹˜ç³»çµ±ç¸½è¦½](#å…±ä¹˜ç³»çµ±ç¸½è¦½)
2. [è¨­è¨ˆæ–¹æ¡ˆå°æ¯”](#è¨­è¨ˆæ–¹æ¡ˆå°æ¯”)
3. [ç¾¤çµ„æ¶æ§‹è©³ç´°è¨­è¨ˆ](#ç¾¤çµ„æ¶æ§‹è©³ç´°è¨­è¨ˆ)
4. [ç¾¤çµ„è§£é™¤åŠŸèƒ½è¨­è¨ˆ](#ç¾¤çµ„è§£é™¤åŠŸèƒ½è¨­è¨ˆ)
5. [æŠ€è¡“å¯¦ä½œæŒ‡å—](#æŠ€è¡“å¯¦ä½œæŒ‡å—)
6. [é€²éšåŠŸèƒ½æ“´å±•](#é€²éšåŠŸèƒ½æ“´å±•)
7. [è¨˜æ†¶é«”ç®¡ç†è€ƒé‡](#è¨˜æ†¶é«”ç®¡ç†è€ƒé‡)
8. [æ¸¬è©¦èˆ‡é©—è­‰ç­–ç•¥](#æ¸¬è©¦èˆ‡é©—è­‰ç­–ç•¥)

---

## å…±ä¹˜ç³»çµ±ç¸½è¦½

### æ¥­å‹™éœ€æ±‚åˆ†æ

**æ ¸å¿ƒéœ€æ±‚**ï¼š
- ç•¶é¸æ“‡å…±ä¹˜å°è±¡æ™‚ï¼Œè‡ªå‹•ç‚ºå…±ä¹˜å°è±¡å»ºç«‹ç›¸åŒçš„è¨‚å–®
- æ”¯æ´å¾€è¿”åŠŸèƒ½ï¼šæœ‰å›ç¨‹æ™‚é–“æ™‚ï¼Œå…±ä¹˜å°è±¡ä¹Ÿè¦å»ºç«‹å›ç¨‹è¨‚å–®
- è§£æ±ºæ´¾é£é‡è¤‡å•é¡Œï¼šé¿å…ç‚ºåŒä¸€è¶Ÿè¡Œç¨‹æ´¾é£å…©å°è»Š
- æä¾›ç¾¤çµ„ç®¡ç†åŠŸèƒ½ï¼šå…è¨±å¾ŒçºŒè§£é™¤å…±ä¹˜é—œä¿‚

**ä½¿ç”¨å ´æ™¯**ï¼š
```
å ´æ™¯1ï¼šåŸºæœ¬å…±ä¹˜
å®¢æˆ¶Aï¼ˆå¼µä¸‰ï¼‰+ å®¢æˆ¶Bï¼ˆæå››ï¼‰
å¾ å°åŒ—è»Šç«™ â†’ å°å¤§é†«é™¢ 14:00
çµæœï¼šå»ºç«‹2ç­†é—œè¯è¨‚å–®ï¼Œåªæ´¾é£1å°è»Š

å ´æ™¯2ï¼šå¾€è¿”å…±ä¹˜  
å®¢æˆ¶Aï¼ˆå¼µä¸‰ï¼‰+ å®¢æˆ¶Bï¼ˆæå››ï¼‰
å»ç¨‹ï¼šå°åŒ—è»Šç«™ â†’ å°å¤§é†«é™¢ 14:00
å›ç¨‹ï¼šå°å¤§é†«é™¢ â†’ å°åŒ—è»Šç«™ 16:00
çµæœï¼šå»ºç«‹4ç­†é—œè¯è¨‚å–®ï¼Œæ´¾é£2å°è»Šï¼ˆå»ç¨‹1å°ï¼Œå›ç¨‹1å°ï¼‰

å ´æ™¯3ï¼šè§£é™¤å…±ä¹˜
åŸæœ¬ï¼šå¼µä¸‰+æå›› å…±ä¹˜
è§£é™¤å¾Œï¼šå¼µä¸‰ç¨ç«‹è¨‚å–® + æå››ç¨ç«‹è¨‚å–®
```

### ç¾æœ‰åŠŸèƒ½è©•ä¼°

**âœ… å·²å¯¦ç¾åŠŸèƒ½**ï¼š
- å…±ä¹˜å°è±¡æœå°‹ï¼ˆå§“åã€èº«åˆ†è­‰ã€é›»è©±ï¼‰
- å…±ä¹˜è³‡è¨Šè¨˜éŒ„åœ¨ä¸»è¨‚å–®ä¸­
- å…±ä¹˜å°è±¡è³‡æ–™é¡¯ç¤ºï¼ˆå§“åã€èº«åˆ†è­‰ã€é›»è©±ã€åœ°å€ï¼‰

**âŒ ç¼ºå°‘åŠŸèƒ½**ï¼š
- æ²’æœ‰ç‚ºå…±ä¹˜å°è±¡å»ºç«‹ç¨ç«‹è¨‚å–®
- æ²’æœ‰ç¾¤çµ„é—œè¯æ©Ÿåˆ¶
- æ´¾é£ç³»çµ±æœƒé‡è¤‡æ´¾è»Š
- ç„¡æ³•è¿½è¹¤å…±ä¹˜å°è±¡çš„å€‹äººè¨‚å–®æ­·å²

### æ ¸å¿ƒå•é¡Œè­˜åˆ¥

1. **æ´¾é£é‡è¤‡å•é¡Œ**ï¼šç³»çµ±æœƒç‚ºæ¯ç­†è¨‚å–®æ´¾é£ä¸€å°è»Š
2. **è³‡æ–™å®Œæ•´æ€§å•é¡Œ**ï¼šå…±ä¹˜å°è±¡æ²’æœ‰å€‹äººè¨‚å–®è¨˜éŒ„
3. **ç‹€æ…‹åŒæ­¥å•é¡Œ**ï¼šç„¡æ³•çµ±ä¸€ç®¡ç†å…±ä¹˜ç¾¤çµ„çš„ç‹€æ…‹
4. **æ­·å²è¿½è¹¤å•é¡Œ**ï¼šå…±ä¹˜å°è±¡çš„æ­è»Šè¨˜éŒ„ä¸å®Œæ•´

---

## è¨­è¨ˆæ–¹æ¡ˆå°æ¯”

### æ–¹æ¡ˆAï¼šè¨‚å–®ç¾¤çµ„æ¶æ§‹ï¼ˆğŸ† æ¨è–¦æ–¹æ¡ˆï¼‰

```
ä¸»è¨‚å–®ï¼šå¼µä¸‰ â†’ Aåœ°åˆ°Båœ° 14:00 [ç¾¤çµ„ID: carpool_001]
â”œâ”€ é—œè¯è¨‚å–®ï¼šæå›› â†’ Aåœ°åˆ°Båœ° 14:00 [ç¾¤çµ„ID: carpool_001]
â””â”€ ç‹€æ…‹åŒæ­¥ï¼šæŒ‡æ´¾å¸æ©Ÿæ™‚ï¼Œå…©ç­†è¨‚å–®åŒæ™‚æ›´æ–°
```

**å„ªé»**ï¼š
- âœ… æ¯äººéƒ½æœ‰ç¨ç«‹è¨‚å–®è¨˜éŒ„ï¼ˆå®Œæ•´çš„å€‹äººæ­·å²ï¼‰
- âœ… æ´¾é£æ™‚è¦–ç‚ºä¸€çµ„ï¼Œåªæ´¾ä¸€å°è»Š
- âœ… æ”¯æ´éˆæ´»çš„ç‹€æ…‹ç®¡ç†å’Œç¾¤çµ„æ“ä½œ
- âœ… è¨ˆè²»æ–¹å¼å¯éˆæ´»èª¿æ•´ï¼ˆåˆ†åˆ¥è¨ˆè²»/å…±åŒè¨ˆè²»/åˆ†æ”¤è¨ˆè²»ï¼‰
- âœ… æ”¯æ´ç¾¤çµ„è§£é™¤åŠŸèƒ½

**ç¼ºé»**ï¼š
- âŒ è³‡æ–™åº«çµæ§‹éœ€è¦èª¿æ•´
- âŒ é‚è¼¯ç›¸å°è¤‡é›œï¼Œéœ€è¦ç‹€æ…‹åŒæ­¥æ©Ÿåˆ¶
- âŒ é–‹ç™¼å·¥ä½œé‡è¼ƒå¤§

### æ–¹æ¡ˆBï¼šå–®ä¸€è¨‚å–®å¤šä¹˜å®¢

```
ä¸»è¨‚å–®ï¼šå¼µä¸‰+æå›› â†’ Aåœ°åˆ°Båœ° 14:00
â”œâ”€ ä¸»ä¹˜å®¢ï¼šå¼µä¸‰ï¼ˆè¨‚å–®æ‰€æœ‰è€…ï¼‰
â””â”€ ä¹˜å®¢æ¸…å–®ï¼š[å¼µä¸‰, æå››]
```

**å„ªé»**ï¼š
- âœ… æ´¾é£ç°¡å–®ï¼Œå¤©ç„¶é¿å…é‡è¤‡æ´¾è»Š
- âœ… è³‡æ–™ä¸€è‡´æ€§å®¹æ˜“ç¶­è­·
- âœ… é–‹ç™¼å·¥ä½œé‡è¼ƒå°

**ç¼ºé»**ï¼š
- âŒ æå››æ²’æœ‰å€‹äººè¨‚å–®æ­·å²è¨˜éŒ„
- âŒ ç‹€æ…‹ç®¡ç†è¤‡é›œï¼ˆå¦‚ä½•è™•ç†å€‹äººç‹€æ…‹å·®ç•°ï¼‰
- âŒ è¨ˆè²»é‚è¼¯å—é™
- âŒ ç„¡æ³•æ”¯æ´éˆæ´»çš„ç¾¤çµ„æ“ä½œ

### æ–¹æ¡ˆé¸æ“‡çµè«–

**é¸æ“‡æ–¹æ¡ˆAï¼šè¨‚å–®ç¾¤çµ„æ¶æ§‹**

**é¸æ“‡ç†ç”±**ï¼š
1. **æ¥­å‹™å®Œæ•´æ€§**ï¼šæ¯ä½å®¢æˆ¶éƒ½æœ‰å®Œæ•´çš„æ­è»Šè¨˜éŒ„
2. **ç³»çµ±æ“´å±•æ€§**ï¼šæ”¯æ´æ›´å¤šå…ƒçš„ç¾¤çµ„æ“ä½œå’Œè¨ˆè²»æ–¹å¼
3. **ç”¨æˆ¶é«”é©—**ï¼šå€‹äººè¨‚å–®æ­·å²å®Œæ•´ï¼Œç‹€æ…‹æ¸…æ¥š
4. **æŠ€è¡“éˆæ´»æ€§**ï¼šå¯ä»¥æ”¯æ´è¤‡é›œçš„æ¥­å‹™å ´æ™¯

**ä»£åƒ¹æ¥å—**ï¼šé¡˜æ„æ‰¿æ“”è¼ƒé«˜çš„é–‹ç™¼è¤‡é›œåº¦ï¼Œæ›å–æ›´å®Œæ•´çš„åŠŸèƒ½å’Œæ›´å¥½çš„ç”¨æˆ¶é«”é©—ã€‚

---

## ç¾¤çµ„æ¶æ§‹è©³ç´°è¨­è¨ˆ

### è³‡æ–™åº«çµæ§‹èª¿æ•´

#### æ–°å¢æ¬„ä½åˆ° orders è¡¨

```sql
-- ç¾¤çµ„ç›¸é—œæ¬„ä½
ALTER TABLE orders ADD COLUMN carpool_group_id VARCHAR(50) NULL COMMENT 'å…±ä¹˜ç¾¤çµ„ID';
ALTER TABLE orders ADD COLUMN is_main_order BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦ç‚ºä¸»è¨‚å–®';
ALTER TABLE orders ADD COLUMN carpool_member_count INT DEFAULT 1 COMMENT 'ç¾¤çµ„æˆå“¡æ•¸é‡';

-- ç¾¤çµ„è§£é™¤ç›¸é—œæ¬„ä½
ALTER TABLE orders ADD COLUMN is_group_dissolved BOOLEAN DEFAULT FALSE COMMENT 'ç¾¤çµ„æ˜¯å¦å·²è§£é™¤';
ALTER TABLE orders ADD COLUMN dissolved_at TIMESTAMP NULL COMMENT 'ç¾¤çµ„è§£é™¤æ™‚é–“';
ALTER TABLE orders ADD COLUMN dissolved_by VARCHAR(255) NULL COMMENT 'è§£é™¤æ“ä½œäºº';
ALTER TABLE orders ADD COLUMN original_group_id VARCHAR(50) NULL COMMENT 'åŸç¾¤çµ„IDï¼ˆä¿ç•™æ­·å²è¨˜éŒ„ï¼‰';

-- ç´¢å¼•å„ªåŒ–
CREATE INDEX idx_carpool_group_id ON orders(carpool_group_id);
CREATE INDEX idx_main_order ON orders(is_main_order);
CREATE INDEX idx_group_dissolved ON orders(is_group_dissolved);
```

#### Order Model èª¿æ•´

```php
// app/Models/Order.php
protected $fillable = [
    // ... ç¾æœ‰æ¬„ä½
    'carpool_group_id',
    'is_main_order', 
    'carpool_member_count',
    'is_group_dissolved',
    'dissolved_at',
    'dissolved_by',
    'original_group_id',
];

protected $casts = [
    // ... ç¾æœ‰æ¬„ä½
    'is_main_order' => 'boolean',
    'is_group_dissolved' => 'boolean',
    'dissolved_at' => 'datetime',
];

// ç¾¤çµ„è¨‚å–®é—œè¯
public function groupMembers()
{
    return $this->hasMany(Order::class, 'carpool_group_id', 'carpool_group_id')
                ->where('id', '!=', $this->id);
}

// ç¾¤çµ„ä¸»è¨‚å–®
public function mainOrder()
{
    return $this->belongsTo(Order::class, 'carpool_group_id', 'carpool_group_id')
                ->where('is_main_order', true);
}

// Scope: åƒ…ä¸»è¨‚å–®
public function scopeMainOrders($query)
{
    return $query->where('is_main_order', true);
}

// Scope: ç¾¤çµ„è¨‚å–®
public function scopeGroupOrders($query)
{
    return $query->whereNotNull('carpool_group_id');
}
```

### æ ¸å¿ƒæ¥­å‹™é‚è¼¯

#### å…±ä¹˜è¨‚å–®å‰µå»ºæµç¨‹

```php
// app/Http/Controllers/OrderController.php - store() æ–¹æ³•ä¿®æ”¹

public function store(Request $request)
{
    DB::transaction(function() use ($request, $validated) {
        // 1. å»ºç«‹ä¸»è¨‚å–®ï¼ˆåŸå®¢æˆ¶ï¼‰
        $mainOrder = $this->createMainOrder($validated);
        
        // 2. æª¢æŸ¥æ˜¯å¦æœ‰å…±ä¹˜å°è±¡
        if ($request->filled('carpool_customer_id')) {
            // ç”Ÿæˆç¾¤çµ„ID
            $groupId = 'carpool_' . time() . '_' . rand(1000, 9999);
            
            // æ›´æ–°ä¸»è¨‚å–®ç¾¤çµ„è³‡è¨Š
            $mainOrder->update([
                'carpool_group_id' => $groupId,
                'is_main_order' => true,
                'carpool_member_count' => 2
            ]);
            
            // å»ºç«‹å…±ä¹˜å°è±¡è¨‚å–®
            $carpoolOrder = $this->createCarpoolOrder($validated, $groupId);
            
            // 3. è™•ç†å›ç¨‹è¨‚å–®
            if (!empty($validated['back_time'])) {
                $this->createReturnOrders($mainOrder, $carpoolOrder, $validated);
            }
        }
        
        // 4. è¨˜éŒ„åœ°æ¨™ä½¿ç”¨æ¬¡æ•¸
        $this->recordLandmarkUsage($request);
    });
}

private function createCarpoolOrder($validated, $groupId)
{
    // å–å¾—å…±ä¹˜å°è±¡è³‡æ–™
    $carpoolCustomer = Customer::find($validated['carpool_customer_id']);
    
    // ç”Ÿæˆå…±ä¹˜è¨‚å–®ç·¨è™Ÿ
    $carpoolOrderNumber = $this->generateOrderNumber($carpoolCustomer);
    
    return Order::create([
        'order_number' => $carpoolOrderNumber,
        'carpool_group_id' => $groupId,
        'is_main_order' => false,
        'carpool_member_count' => 2,
        
        // ä½¿ç”¨å…±ä¹˜å°è±¡çš„å®¢æˆ¶è³‡æ–™
        'customer_id' => $carpoolCustomer->id,
        'customer_name' => $carpoolCustomer->name,
        'customer_id_number' => $carpoolCustomer->id_number,
        'customer_phone' => is_array($carpoolCustomer->phone_number) 
            ? $carpoolCustomer->phone_number[0] 
            : $carpoolCustomer->phone_number,
            
        // å…¶ä»–è¨‚å–®è³‡æ–™èˆ‡ä¸»è¨‚å–®ç›¸åŒ
        'ride_date' => $validated['ride_date'],
        'ride_time' => $validated['ride_time'],
        'pickup_address' => $validated['pickup_address'],
        'dropoff_address' => $validated['dropoff_address'],
        'status' => $validated['status'],
        // ... å…¶ä»–ç›¸åŒæ¬„ä½
    ]);
}
```

### ç‹€æ…‹åŒæ­¥æ©Ÿåˆ¶

#### ç¾¤çµ„ç‹€æ…‹åŒæ­¥ Service

```php
// app/Services/CarpoolGroupService.php

class CarpoolGroupService
{
    /**
     * åŒæ­¥ç¾¤çµ„ç‹€æ…‹
     */
    public function syncGroupStatus($groupId, $newStatus, $updateData = [])
    {
        DB::transaction(function() use ($groupId, $newStatus, $updateData) {
            Order::where('carpool_group_id', $groupId)
                 ->update(array_merge([
                     'status' => $newStatus,
                     'updated_at' => now()
                 ], $updateData));
        });
    }
    
    /**
     * æŒ‡æ´¾å¸æ©Ÿçµ¦ç¾¤çµ„
     */
    public function assignDriverToGroup($groupId, $driverId, $driverData)
    {
        $driver = Driver::find($driverId);
        
        $this->syncGroupStatus($groupId, 'assigned', [
            'driver_id' => $driverId,
            'driver_name' => $driver->name,
            'driver_fleet_number' => $driver->fleet_number,
            'driver_plate_number' => $driver->plate_number,
        ]);
    }
    
    /**
     * å–æ¶ˆç¾¤çµ„è¨‚å–®
     */
    public function cancelGroup($groupId, $reason = '')
    {
        $this->syncGroupStatus($groupId, 'cancelled', [
            'remark' => $reason ? "å–æ¶ˆåŸå› ï¼š{$reason}" : ''
        ]);
    }
}
```

### æ´¾é£ç³»çµ±æ•´åˆ

#### æ´¾é£æ¸…å–®æŸ¥è©¢èª¿æ•´

```php
// æ´¾é£æ¸…å–®åªé¡¯ç¤ºä¸»è¨‚å–®
public function getDispatchOrders(Request $request)
{
    $orders = Order::mainOrders() // åªæŸ¥è©¢ä¸»è¨‚å–®
                   ->where('status', 'open')
                   ->with(['customer', 'groupMembers'])
                   ->orderBy('ride_date', 'asc')
                   ->orderBy('ride_time', 'asc')
                   ->paginate(50);
    
    return view('dispatch.index', compact('orders'));
}
```

#### æ´¾é£æ¸…å–®é¡¯ç¤ºé‚è¼¯

```php
// åœ¨æ´¾é£æ¸…å–®ä¸­é¡¯ç¤ºç¾¤çµ„è³‡è¨Š
public function getOrderDisplayInfo($order)
{
    if ($order->carpool_group_id) {
        $memberCount = $order->carpool_member_count;
        $memberNames = $order->groupMembers->pluck('customer_name')->join(', ');
        
        return [
            'display_name' => "{$order->customer_name} (+{$memberCount-1})",
            'member_info' => "å…±ä¹˜æˆå“¡ï¼š{$memberNames}",
            'is_group' => true
        ];
    }
    
    return [
        'display_name' => $order->customer_name,
        'member_info' => '',
        'is_group' => false
    ];
}
```

---

## ç¾¤çµ„è§£é™¤åŠŸèƒ½è¨­è¨ˆ

### è§£é™¤å ´æ™¯åˆ†æ

#### å ´æ™¯1ï¼šè¨ˆåŠƒéšæ®µè§£é™¤ï¼ˆç‹€æ…‹ï¼šopenï¼‰
```php
/**
 * è™•ç†é›£åº¦ï¼šâ­â­â­ å®¹æ˜“
 * å½±éŸ¿ç¯„åœï¼šç„¡å¸æ©ŸæŒ‡æ´¾ï¼Œç›´æ¥è§£é™¤å³å¯
 */
åŸå§‹ï¼šå¼µä¸‰+æå›› å…±ä¹˜ Aâ†’B 14:00 [ç‹€æ…‹: open]
è§£é™¤å¾Œï¼š
- å¼µä¸‰ï¼šAâ†’B 14:00ï¼ˆç¨ç«‹è¨‚å–®ï¼‰[ç‹€æ…‹: open]
- æå››ï¼šAâ†’B 14:00ï¼ˆç¨ç«‹è¨‚å–®ï¼‰[ç‹€æ…‹: open]
```

#### å ´æ™¯2ï¼šå·²æŒ‡æ´¾å¸æ©Ÿå¾Œè§£é™¤ï¼ˆç‹€æ…‹ï¼šassignedï¼‰
```php
/**
 * è™•ç†é›£åº¦ï¼šâ­â­â­â­ éœ€è¦é‡æ–°æ´¾é£é‚è¼¯
 * å½±éŸ¿ç¯„åœï¼šå¸æ©Ÿè³‡æºé‡æ–°åˆ†é…
 */
åŸå§‹ï¼šå¼µä¸‰+æå›› â†’ ç‹å¸æ©Ÿ â†’ Aâ†’B 14:00 [ç‹€æ…‹: assigned]
è§£é™¤å¾Œï¼š
- å¼µä¸‰ï¼šAâ†’B 14:00 â†’ ç‹å¸æ©Ÿï¼ˆä¿æŒæŒ‡æ´¾ï¼‰[ç‹€æ…‹: assigned]
- æå››ï¼šAâ†’B 14:00 â†’ å¾…é‡æ–°æ´¾é£ [ç‹€æ…‹: open]
```

#### å ´æ™¯3ï¼šæœå‹™é€²è¡Œä¸­è§£é™¤ï¼ˆç‹€æ…‹ï¼šin_progressï¼‰
```php
/**
 * è™•ç†é›£åº¦ï¼šâ­â­â­â­â­ éœ€è¦ç‰¹æ®Šæ¬Šé™å’Œè™•ç†
 * å½±éŸ¿ç¯„åœï¼šå¯èƒ½å½±éŸ¿æ­£åœ¨é€²è¡Œçš„æœå‹™
 */
åŸå§‹ï¼šå¼µä¸‰+æå›› â†’ ç‹å¸æ©Ÿ â†’ æœå‹™ä¸­ [ç‹€æ…‹: in_progress]
è§£é™¤å¾Œï¼šåƒ…è¨˜éŒ„è§£é™¤è«‹æ±‚ï¼Œä¸ç«‹å³åŸ·è¡Œ
```

### æŠ€è¡“å¯¦ä½œæ–¹æ¡ˆ

#### ç¾¤çµ„è§£é™¤ Controller

```php
// app/Http/Controllers/CarpoolGroupController.php

class CarpoolGroupController extends Controller
{
    protected $carpoolService;
    
    public function __construct(CarpoolGroupService $carpoolService)
    {
        $this->carpoolService = $carpoolService;
    }
    
    /**
     * è§£é™¤å…±ä¹˜ç¾¤çµ„
     */
    public function dissolveGroup(Request $request, $groupId)
    {
        $request->validate([
            'reason' => 'nullable|string|max:500',
            'force' => 'boolean'
        ]);
        
        try {
            $result = DB::transaction(function() use ($groupId, $request) {
                return $this->carpoolService->dissolveGroup(
                    $groupId, 
                    $request->reason,
                    $request->force
                );
            });
            
            return response()->json([
                'success' => true,
                'message' => $result['message'],
                'affected_orders' => $result['orders']
            ]);
            
        } catch (CarpoolDissolutionException $e) {
            return response()->json([
                'success' => false,
                'message' => $e->getMessage(),
                'error_code' => $e->getCode()
            ], 400);
        }
    }
}
```

#### ç¾¤çµ„è§£é™¤ Service é‚è¼¯

```php
// app/Services/CarpoolGroupService.php - è§£é™¤åŠŸèƒ½

/**
 * è§£é™¤å…±ä¹˜ç¾¤çµ„
 */
public function dissolveGroup($groupId, $reason = '', $force = false)
{
    $groupOrders = Order::where('carpool_group_id', $groupId)->get();
    
    if ($groupOrders->isEmpty()) {
        throw new CarpoolDissolutionException('ç¾¤çµ„ä¸å­˜åœ¨');
    }
    
    // æª¢æŸ¥è§£é™¤æ¢ä»¶
    $this->validateDissolutionConditions($groupOrders, $force);
    
    $result = ['orders' => [], 'message' => ''];
    
    foreach ($groupOrders as $order) {
        $dissolvedOrder = $this->dissolveOrder($order, $reason);
        $result['orders'][] = $dissolvedOrder;
    }
    
    $result['message'] = $this->generateDissolutionMessage($result['orders']);
    
    return $result;
}

/**
 * è§£é™¤å–®ä¸€è¨‚å–®
 */
private function dissolveOrder($order, $reason)
{
    $originalStatus = $order->status;
    
    $updateData = [
        'original_group_id' => $order->carpool_group_id,
        'carpool_group_id' => null,
        'is_main_order' => true,
        'carpool_member_count' => 1,
        'is_group_dissolved' => true,
        'dissolved_at' => now(),
        'dissolved_by' => auth()->user()->name,
        
        // æ¸…é™¤å…±ä¹˜è³‡è¨Š
        'carpool_customer_id' => null,
        'carpool_name' => null,
        'carpool_id' => null,
    ];
    
    // æ ¹æ“šåŸç‹€æ…‹æ±ºå®šè§£é™¤å¾Œçš„è™•ç†
    if ($originalStatus === 'assigned' && !$order->is_main_order) {
        // éä¸»è¨‚å–®é‡‹æ”¾å¸æ©Ÿï¼Œå›åˆ°å¾…æ´¾é£ç‹€æ…‹
        $updateData = array_merge($updateData, [
            'driver_id' => null,
            'driver_name' => null,
            'driver_fleet_number' => null,
            'driver_plate_number' => null,
            'status' => 'open'
        ]);
    }
    
    $order->update($updateData);
    
    // è¨˜éŒ„è§£é™¤æ—¥èªŒ
    $this->logDissolution($order, $reason);
    
    return [
        'order_id' => $order->id,
        'customer_name' => $order->customer_name,
        'original_status' => $originalStatus,
        'new_status' => $order->status,
        'driver_retained' => $order->driver_id ? true : false
    ];
}

/**
 * é©—è­‰è§£é™¤æ¢ä»¶
 */
private function validateDissolutionConditions($groupOrders, $force)
{
    $inProgressOrders = $groupOrders->where('status', 'in_progress');
    
    if ($inProgressOrders->isNotEmpty() && !$force) {
        throw new CarpoolDissolutionException(
            'ç¾¤çµ„ä¸­æœ‰æ­£åœ¨é€²è¡Œçš„è¨‚å–®ï¼Œç„¡æ³•è§£é™¤ã€‚å¦‚éœ€å¼·åˆ¶è§£é™¤ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ã€‚',
            CarpoolDissolutionException::IN_PROGRESS_ERROR
        );
    }
    
    $completedOrders = $groupOrders->whereIn('status', ['completed', 'cancelled']);
    
    if ($completedOrders->count() === $groupOrders->count()) {
        throw new CarpoolDissolutionException(
            'ç¾¤çµ„ä¸­æ‰€æœ‰è¨‚å–®å·²å®Œæˆæˆ–å–æ¶ˆï¼Œç„¡éœ€è§£é™¤ã€‚',
            CarpoolDissolutionException::ALREADY_COMPLETED_ERROR
        );
    }
}
```

### å‰ç«¯æ“ä½œä»‹é¢

#### ç¾¤çµ„ç®¡ç† Modal

```html
<!-- resources/views/orders/components/carpool-group-modal.blade.php -->
<div class="modal fade" id="carpoolGroupModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-users me-2"></i>å…±ä¹˜ç¾¤çµ„ç®¡ç†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- ç¾¤çµ„è³‡è¨Š -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">ç¾¤çµ„è³‡è¨Š</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>ç¾¤çµ„IDï¼š</strong><span id="groupId"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>æˆå“¡æ•¸é‡ï¼š</strong><span id="memberCount"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>å»ºç«‹æ™‚é–“ï¼š</strong><span id="createdAt"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>ç¾¤çµ„ç‹€æ…‹ï¼š</strong><span id="groupStatus"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æˆå“¡åˆ—è¡¨ -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">ç¾¤çµ„æˆå“¡</h6>
                    </div>
                    <div class="card-body">
                        <div id="memberList">
                            <!-- å‹•æ…‹å¡«å…¥æˆå“¡è³‡æ–™ -->
                        </div>
                    </div>
                </div>
                
                <!-- è§£é™¤ç¾¤çµ„å€åŸŸ -->
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>è§£é™¤ç¾¤çµ„
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <h6>è§£é™¤ç¾¤çµ„å°‡æœƒï¼š</h6>
                            <ul class="mb-2">
                                <li>å°‡ç¾¤çµ„å…§æ‰€æœ‰è¨‚å–®è®Šç‚ºç¨ç«‹è¨‚å–®</li>
                                <li>éä¸»è¨‚å–®å¯èƒ½éœ€è¦é‡æ–°æ´¾é£å¸æ©Ÿ</li>
                                <li>è¨ˆè²»æ–¹å¼å¯èƒ½æ”¹è®Š</li>
                            </ul>
                            <strong class="text-danger">æ­¤æ“ä½œç„¡æ³•å¾©åŸ</strong>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">è§£é™¤åŸå› ï¼ˆé¸å¡«ï¼‰</label>
                            <textarea id="dissolutionReason" class="form-control" rows="3" 
                                    placeholder="è«‹èªªæ˜è§£é™¤ç¾¤çµ„çš„åŸå› ..."></textarea>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-warning" onclick="dissolveGroup()">
                                <i class="fas fa-unlink me-2"></i>ç¢ºèªè§£é™¤ç¾¤çµ„
                            </button>
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                å–æ¶ˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
```

#### JavaScript ç¾¤çµ„ç®¡ç†é‚è¼¯

```javascript
// public/js/orders/carpool-group.js

class CarpoolGroupManager {
    constructor() {
        this.currentGroupId = null;
        this.init();
    }
    
    init() {
        this.bindEvents();
    }
    
    bindEvents() {
        // ç¾¤çµ„ç®¡ç†æŒ‰éˆ•é»æ“Š
        $(document).on('click', '.manage-group-btn', this.handleGroupManage.bind(this));
        
        // è§£é™¤ç¾¤çµ„ç¢ºèª
        $('#confirmDissolveBtn').on('click', this.confirmDissolveGroup.bind(this));
    }
    
    /**
     * é–‹å•Ÿç¾¤çµ„ç®¡ç† Modal
     */
    handleGroupManage(e) {
        const groupId = $(e.target).data('group-id');
        this.currentGroupId = groupId;
        this.loadGroupInfo(groupId);
        $('#carpoolGroupModal').modal('show');
    }
    
    /**
     * è¼‰å…¥ç¾¤çµ„è³‡è¨Š
     */
    async loadGroupInfo(groupId) {
        try {
            const response = await fetch(`/carpool-groups/${groupId}`);
            const data = await response.json();
            
            if (data.success) {
                this.displayGroupInfo(data.group);
            } else {
                this.showError('è¼‰å…¥ç¾¤çµ„è³‡è¨Šå¤±æ•—');
            }
        } catch (error) {
            console.error('è¼‰å…¥ç¾¤çµ„è³‡è¨ŠéŒ¯èª¤ï¼š', error);
            this.showError('è¼‰å…¥ç¾¤çµ„è³‡è¨Šå¤±æ•—');
        }
    }
    
    /**
     * é¡¯ç¤ºç¾¤çµ„è³‡è¨Š
     */
    displayGroupInfo(group) {
        $('#groupId').text(group.id);
        $('#memberCount').text(group.member_count);
        $('#createdAt').text(group.created_at);
        $('#groupStatus').html(this.getStatusBadge(group.status));
        
        // é¡¯ç¤ºæˆå“¡åˆ—è¡¨
        let memberHtml = '';
        group.members.forEach(member => {
            memberHtml += `
                <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                    <div>
                        <strong>${member.customer_name}</strong>
                        ${member.is_main_order ? '<span class="badge bg-primary ms-2">ä¸»è¨‚å–®</span>' : ''}
                        <br>
                        <small class="text-muted">
                            è¨‚å–®è™Ÿï¼š${member.order_number} | 
                            ç‹€æ…‹ï¼š${this.getStatusText(member.status)}
                        </small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-info" 
                                onclick="viewOrder('${member.id}')">
                            æŸ¥çœ‹è¨‚å–®
                        </button>
                    </div>
                </div>
            `;
        });
        $('#memberList').html(memberHtml);
    }
    
    /**
     * è§£é™¤ç¾¤çµ„
     */
    async dissolveGroup() {
        const reason = $('#dissolutionReason').val().trim();
        
        // äºŒæ¬¡ç¢ºèª
        const confirmed = await Swal.fire({
            title: 'ç¢ºèªè§£é™¤å…±ä¹˜ç¾¤çµ„ï¼Ÿ',
            text: 'æ­¤æ“ä½œç„¡æ³•å¾©åŸ',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ç¢ºèªè§£é™¤',
            cancelButtonText: 'å–æ¶ˆ'
        });
        
        if (!confirmed.isConfirmed) return;
        
        try {
            const response = await fetch(`/carpool-groups/${this.currentGroupId}/dissolve`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                body: JSON.stringify({
                    reason: reason
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.showSuccess(data.message);
                $('#carpoolGroupModal').modal('hide');
                
                // åˆ·æ–°é é¢æˆ–æ›´æ–°è¨‚å–®åˆ—è¡¨
                if (typeof refreshOrderTable === 'function') {
                    refreshOrderTable();
                } else {
                    location.reload();
                }
            } else {
                this.showError(data.message);
            }
            
        } catch (error) {
            console.error('è§£é™¤ç¾¤çµ„éŒ¯èª¤ï¼š', error);
            this.showError('è§£é™¤ç¾¤çµ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
    }
    
    /**
     * ç²å–ç‹€æ…‹æ¨™ç±¤
     */
    getStatusBadge(status) {
        const statusMap = {
            'open': '<span class="badge bg-success">å¯æ´¾é£</span>',
            'assigned': '<span class="badge bg-primary">å·²æŒ‡æ´¾</span>',
            'in_progress': '<span class="badge bg-warning">é€²è¡Œä¸­</span>',
            'completed': '<span class="badge bg-secondary">å·²å®Œæˆ</span>',
            'cancelled': '<span class="badge bg-danger">å·²å–æ¶ˆ</span>'
        };
        
        return statusMap[status] || '<span class="badge bg-secondary">æœªçŸ¥</span>';
    }
    
    /**
     * ç²å–ç‹€æ…‹æ–‡å­—
     */
    getStatusText(status) {
        const statusMap = {
            'open': 'å¯æ´¾é£',
            'assigned': 'å·²æŒ‡æ´¾',
            'in_progress': 'é€²è¡Œä¸­', 
            'completed': 'å·²å®Œæˆ',
            'cancelled': 'å·²å–æ¶ˆ'
        };
        
        return statusMap[status] || 'æœªçŸ¥';
    }
    
    /**
     * é¡¯ç¤ºæˆåŠŸè¨Šæ¯
     */
    showSuccess(message) {
        Swal.fire({
            title: 'æ“ä½œæˆåŠŸ',
            text: message,
            icon: 'success',
            timer: 3000
        });
    }
    
    /**
     * é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
     */
    showError(message) {
        Swal.fire({
            title: 'æ“ä½œå¤±æ•—',
            text: message,
            icon: 'error'
        });
    }
}

// åˆå§‹åŒ–ç¾¤çµ„ç®¡ç†å™¨
$(document).ready(function() {
    window.carpoolGroupManager = new CarpoolGroupManager();
});
```

---

## æŠ€è¡“å¯¦ä½œæŒ‡å—

### å¯¦ä½œéšæ®µè¦åŠƒ

#### éšæ®µ1ï¼šè³‡æ–™åº«èª¿æ•´ï¼ˆ2-3å°æ™‚ï¼‰

**æ­¥é©Ÿ1ï¼šå‰µå»ºé·ç§»æª”æ¡ˆ**
```bash
php artisan make:migration add_carpool_group_fields_to_orders_table
```

**æ­¥é©Ÿ2ï¼šé·ç§»æª”æ¡ˆå…§å®¹**
```php
// database/migrations/xxxx_add_carpool_group_fields_to_orders_table.php

public function up()
{
    Schema::table('orders', function (Blueprint $table) {
        // ç¾¤çµ„ç›¸é—œæ¬„ä½
        $table->string('carpool_group_id', 50)->nullable()->index()->comment('å…±ä¹˜ç¾¤çµ„ID');
        $table->boolean('is_main_order')->default(true)->index()->comment('æ˜¯å¦ç‚ºä¸»è¨‚å–®');
        $table->integer('carpool_member_count')->default(1)->comment('ç¾¤çµ„æˆå“¡æ•¸é‡');
        
        // ç¾¤çµ„è§£é™¤ç›¸é—œæ¬„ä½
        $table->boolean('is_group_dissolved')->default(false)->index()->comment('ç¾¤çµ„æ˜¯å¦å·²è§£é™¤');
        $table->timestamp('dissolved_at')->nullable()->comment('ç¾¤çµ„è§£é™¤æ™‚é–“');
        $table->string('dissolved_by')->nullable()->comment('è§£é™¤æ“ä½œäºº');
        $table->string('original_group_id', 50)->nullable()->comment('åŸç¾¤çµ„ID');
    });
}

public function down()
{
    Schema::table('orders', function (Blueprint $table) {
        $table->dropIndex(['carpool_group_id']);
        $table->dropIndex(['is_main_order']); 
        $table->dropIndex(['is_group_dissolved']);
        
        $table->dropColumn([
            'carpool_group_id',
            'is_main_order',
            'carpool_member_count',
            'is_group_dissolved',
            'dissolved_at',
            'dissolved_by',
            'original_group_id'
        ]);
    });
}
```

**æ­¥é©Ÿ3ï¼šåŸ·è¡Œé·ç§»**
```bash
php artisan migrate
```

#### éšæ®µ2ï¼šå¾Œç«¯é‚è¼¯å¯¦ä½œï¼ˆ8-12å°æ™‚ï¼‰

**æ­¥é©Ÿ1ï¼šå»ºç«‹ Service é¡åˆ¥**
```bash
php artisan make:service CarpoolGroupService
```

**æ­¥é©Ÿ2ï¼šå»ºç«‹ Exception é¡åˆ¥**
```bash
php artisan make:exception CarpoolDissolutionException
```

**æ­¥é©Ÿ3ï¼šå»ºç«‹ Controller**
```bash
php artisan make:controller CarpoolGroupController
```

**æ­¥é©Ÿ4ï¼šæ›´æ–° Order Model**
```php
// åœ¨ app/Models/Order.php ä¸­æ·»åŠ ç›¸é—œæ–¹æ³•å’Œé—œè¯
```

**æ­¥é©Ÿ5ï¼šä¿®æ”¹ OrderController::store()**
```php
// æ•´åˆå…±ä¹˜è¨‚å–®å‰µå»ºé‚è¼¯
```

#### éšæ®µ3ï¼šå‰ç«¯æ•´åˆï¼ˆ4-6å°æ™‚ï¼‰

**æ­¥é©Ÿ1ï¼šå‰µå»ºç¾¤çµ„ç®¡ç† JavaScript**
```bash
touch public/js/orders/carpool-group.js
```

**æ­¥é©Ÿ2ï¼šå‰µå»º Blade çµ„ä»¶**
```bash
touch resources/views/orders/components/carpool-group-modal.blade.php
```

**æ­¥é©Ÿ3ï¼šæ›´æ–°è¨‚å–®è¡¨å–®é‚è¼¯**
```javascript
// ä¿®æ”¹ public/js/orders/form.js
```

**æ­¥é©Ÿ4ï¼šæ›´æ–°è¨‚å–®åˆ—è¡¨é¡¯ç¤º**
```php
// ä¿®æ”¹ resources/views/orders/components/order-table.blade.php
```

#### éšæ®µ4ï¼šæ´¾é£ç³»çµ±æ•´åˆï¼ˆ6-8å°æ™‚ï¼‰

**æ­¥é©Ÿ1ï¼šèª¿æ•´æ´¾é£æŸ¥è©¢é‚è¼¯**
```php
// åªé¡¯ç¤ºä¸»è¨‚å–®çš„æ´¾é£æ¸…å–®
```

**æ­¥é©Ÿ2ï¼šç¾¤çµ„ç‹€æ…‹åŒæ­¥æ©Ÿåˆ¶**
```php
// å¯¦ä½œç‹€æ…‹åŒæ­¥ Service
```

**æ­¥é©Ÿ3ï¼šæ´¾é£ä»‹é¢å„ªåŒ–**
```html
<!-- é¡¯ç¤ºç¾¤çµ„è³‡è¨Šçš„æ´¾é£ä»‹é¢ -->
```

### API è¨­è¨ˆè¦ç¯„

#### å…±ä¹˜ç¾¤çµ„ç›¸é—œ API

```php
// routes/web.php
Route::middleware('auth')->group(function () {
    // ç¾¤çµ„è³‡è¨Š
    Route::get('/carpool-groups/{groupId}', [CarpoolGroupController::class, 'show']);
    
    // è§£é™¤ç¾¤çµ„
    Route::post('/carpool-groups/{groupId}/dissolve', [CarpoolGroupController::class, 'dissolveGroup']);
    
    // ç¾¤çµ„ç‹€æ…‹åŒæ­¥
    Route::patch('/carpool-groups/{groupId}/status', [CarpoolGroupController::class, 'updateStatus']);
    
    // æŒ‡æ´¾å¸æ©Ÿçµ¦ç¾¤çµ„
    Route::post('/carpool-groups/{groupId}/assign-driver', [CarpoolGroupController::class, 'assignDriver']);
});
```

#### API å›æ‡‰æ ¼å¼

```json
// ç¾¤çµ„è³‡è¨Š API å›æ‡‰
{
    "success": true,
    "group": {
        "id": "carpool_1640995200_1234",
        "member_count": 2,
        "status": "open",
        "created_at": "2023-12-31 14:00:00",
        "members": [
            {
                "id": 123,
                "order_number": "NTPC00120231231140001",
                "customer_name": "å¼µä¸‰",
                "is_main_order": true,
                "status": "open"
            },
            {
                "id": 124,
                "order_number": "NTPC00420231231140002", 
                "customer_name": "æå››",
                "is_main_order": false,
                "status": "open"
            }
        ]
    }
}

// è§£é™¤ç¾¤çµ„ API å›æ‡‰
{
    "success": true,
    "message": "å…±ä¹˜ç¾¤çµ„å·²æˆåŠŸè§£é™¤",
    "affected_orders": [
        {
            "order_id": 123,
            "customer_name": "å¼µä¸‰",
            "original_status": "assigned",
            "new_status": "assigned",
            "driver_retained": true
        },
        {
            "order_id": 124,
            "customer_name": "æå››", 
            "original_status": "assigned",
            "new_status": "open",
            "driver_retained": false
        }
    ]
}
```

### é©—è­‰è¦å‰‡èª¿æ•´

```php
// app/Http/Requests/StoreOrderRequest.php
public function rules(): array
{
    return [
        // ... ç¾æœ‰è¦å‰‡
        'carpool_customer_id' => 'nullable|exists:customers,id',
        'carpool_with' => 'nullable|string|max:255',
        'carpool_id_number' => 'nullable|string|max:20',
        'carpool_phone_number' => 'nullable|string|max:20',
        'carpool_addresses' => 'nullable|string|max:500',
    ];
}

// app/Http/Requests/DissolveGroupRequest.php
class DissolveGroupRequest extends FormRequest
{
    public function rules(): array
    {
        return [
            'reason' => 'nullable|string|max:500',
            'force' => 'boolean'
        ];
    }
}
```

---

## é€²éšåŠŸèƒ½æ“´å±•

### 1. æ™ºèƒ½é…å°å»ºè­°ç³»çµ±

#### æ¥­å‹™é‚è¼¯
```php
// app/Services/CarpoolMatchingService.php

class CarpoolMatchingService
{
    /**
     * å°‹æ‰¾æ½›åœ¨å…±ä¹˜å°è±¡
     */
    public function findPotentialMatches($orderId)
    {
        $order = Order::findOrFail($orderId);
        
        // åŸºæœ¬æ¢ä»¶ï¼šç›¸åŒæ—¥æœŸã€ç›¸è¿‘æ™‚é–“ã€ç›¸åŒè·¯ç·š
        $matches = Order::where('ride_date', $order->ride_date)
            ->where('status', 'open')
            ->where('id', '!=', $orderId)
            ->whereNull('carpool_group_id') // æœªåŠ å…¥å…¶ä»–ç¾¤çµ„
            ->whereBetween('ride_time', [
                Carbon::parse($order->ride_time)->subMinutes(30),
                Carbon::parse($order->ride_time)->addMinutes(30)
            ])
            ->get();
        
        // è·¯ç·šç›¸ä¼¼åº¦è¨ˆç®—
        return $matches->map(function($match) use ($order) {
            $similarity = $this->calculateRouteSimilarity($order, $match);
            $match->similarity_score = $similarity;
            return $match;
        })->where('similarity_score', '>', 0.7)
          ->sortByDesc('similarity_score');
    }
    
    /**
     * è¨ˆç®—è·¯ç·šç›¸ä¼¼åº¦
     */
    private function calculateRouteSimilarity($order1, $order2)
    {
        // ç°¡åŒ–çš„ç›¸ä¼¼åº¦è¨ˆç®—ï¼ˆå¯¦éš›å¯ç”¨æ›´è¤‡é›œçš„åœ°ç†ç®—æ³•ï¼‰
        $pickupMatch = similar_text($order1->pickup_address, $order2->pickup_address) / 100;
        $dropoffMatch = similar_text($order1->dropoff_address, $order2->dropoff_address) / 100;
        
        return ($pickupMatch + $dropoffMatch) / 2;
    }
}
```

#### å‰ç«¯æ™ºèƒ½æ¨è–¦ç•Œé¢
```html
<!-- åœ¨è¨‚å–®å»ºç«‹é é¢é¡¯ç¤ºæ¨è–¦å…±ä¹˜ -->
<div class="card border-info mb-3" id="carpoolSuggestions" style="display: none;">
    <div class="card-header bg-info text-white">
        <h6 class="mb-0">
            <i class="fas fa-lightbulb me-2"></i>æ™ºèƒ½å…±ä¹˜æ¨è–¦
        </h6>
    </div>
    <div class="card-body">
        <p class="text-muted">ç³»çµ±ç‚ºæ‚¨æ‰¾åˆ°ä»¥ä¸‹æ½›åœ¨çš„å…±ä¹˜å°è±¡ï¼š</p>
        <div id="suggestedMatches">
            <!-- å‹•æ…‹è¼‰å…¥æ¨è–¦åˆ—è¡¨ -->
        </div>
    </div>
</div>
```

### 2. é‡æ–°çµ„ç¾¤åŠŸèƒ½

#### æ¥­å‹™å ´æ™¯
```
å ´æ™¯ï¼šå…©å€‹ç¨ç«‹è¨‚å–®å¸Œæœ›åˆä½µæˆå…±ä¹˜
è¨‚å–®Aï¼šå¼µä¸‰ Aåœ°â†’Båœ° 14:00
è¨‚å–®Bï¼šæå›› Aåœ°â†’Båœ° 14:10
æ“ä½œï¼šé¸æ“‡å…©ç­†è¨‚å–®ï¼Œåˆä½µæˆå…±ä¹˜ç¾¤çµ„
```

#### å¯¦ä½œé‚è¼¯
```php
// app/Services/CarpoolGroupService.php

/**
 * é‡æ–°çµ„ç¾¤åŠŸèƒ½
 */
public function createGroupFromOrders(array $orderIds, $mainOrderId = null)
{
    DB::transaction(function() use ($orderIds, $mainOrderId) {
        $orders = Order::whereIn('id', $orderIds)
            ->where('status', 'open') // åªå…è¨±æœªæ´¾é£çš„è¨‚å–®çµ„ç¾¤
            ->whereNull('carpool_group_id') // æœªåŠ å…¥å…¶ä»–ç¾¤çµ„
            ->get();
        
        if ($orders->count() !== count($orderIds)) {
            throw new CarpoolGroupException('éƒ¨åˆ†è¨‚å–®ç„¡æ³•çµ„ç¾¤');
        }
        
        // é©—è­‰è¨‚å–®ç›¸å®¹æ€§
        $this->validateOrderCompatibility($orders);
        
        // ç”Ÿæˆæ–°ç¾¤çµ„ID
        $groupId = 'regroup_' . time() . '_' . rand(1000, 9999);
        
        // è¨­å®šä¸»è¨‚å–®
        $mainOrder = $mainOrderId ? $orders->find($mainOrderId) : $orders->first();
        
        foreach ($orders as $order) {
            $order->update([
                'carpool_group_id' => $groupId,
                'is_main_order' => $order->id === $mainOrder->id,
                'carpool_member_count' => $orders->count()
            ]);
        }
        
        return $groupId;
    });
}

/**
 * é©—è­‰è¨‚å–®ç›¸å®¹æ€§
 */
private function validateOrderCompatibility($orders)
{
    $firstOrder = $orders->first();
    
    foreach ($orders as $order) {
        // æª¢æŸ¥æ—¥æœŸ
        if ($order->ride_date !== $firstOrder->ride_date) {
            throw new CarpoolGroupException('è¨‚å–®æ—¥æœŸä¸åŒï¼Œç„¡æ³•çµ„ç¾¤');
        }
        
        // æª¢æŸ¥æ™‚é–“å·®ç•°ï¼ˆä¸è¶…é30åˆ†é˜ï¼‰
        $timeDiff = abs(Carbon::parse($order->ride_time)
            ->diffInMinutes(Carbon::parse($firstOrder->ride_time)));
        
        if ($timeDiff > 30) {
            throw new CarpoolGroupException('è¨‚å–®æ™‚é–“å·®ç•°éå¤§ï¼Œç„¡æ³•çµ„ç¾¤');
        }
        
        // æª¢æŸ¥è·¯ç·šç›¸ä¼¼åº¦
        $similarity = $this->calculateRouteSimilarity($order, $firstOrder);
        if ($similarity < 0.8) {
            throw new CarpoolGroupException('è¨‚å–®è·¯ç·šå·®ç•°éå¤§ï¼Œç„¡æ³•çµ„ç¾¤');
        }
    }
}
```

### 3. éƒ¨åˆ†é€€å‡ºåŠŸèƒ½

#### æ¥­å‹™é‚è¼¯
```php
/**
 * å–®ä¸€æˆå“¡é€€å‡ºç¾¤çµ„
 */
public function leaveGroup($orderId, $reason = '')
{
    DB::transaction(function() use ($orderId, $reason) {
        $order = Order::findOrFail($orderId);
        $groupId = $order->carpool_group_id;
        
        if (!$groupId) {
            throw new CarpoolGroupException('è©²è¨‚å–®ä¸åœ¨ä»»ä½•ç¾¤çµ„ä¸­');
        }
        
        $groupOrders = Order::where('carpool_group_id', $groupId)->get();
        
        if ($groupOrders->count() <= 2) {
            // åªå‰©2äººçš„ç¾¤çµ„ï¼Œç›´æ¥è§£æ•£
            return $this->dissolveGroup($groupId, "æˆå“¡ {$order->customer_name} é€€å‡º");
        }
        
        // ç§»é™¤è©²æˆå“¡
        $order->update([
            'original_group_id' => $groupId,
            'carpool_group_id' => null,
            'is_main_order' => true,
            'carpool_member_count' => 1,
            'carpool_customer_id' => null,
            'carpool_name' => null,
            'carpool_id' => null,
        ]);
        
        // æ›´æ–°å‰©é¤˜æˆå“¡çš„äººæ•¸
        $remainingCount = $groupOrders->count() - 1;
        Order::where('carpool_group_id', $groupId)
             ->update(['carpool_member_count' => $remainingCount]);
        
        // å¦‚æœé€€å‡ºçš„æ˜¯ä¸»è¨‚å–®ï¼Œéœ€è¦é‡æ–°æŒ‡å®šä¸»è¨‚å–®
        if ($order->is_main_order) {
            $newMainOrder = Order::where('carpool_group_id', $groupId)->first();
            $newMainOrder->update(['is_main_order' => true]);
        }
        
        // è¨˜éŒ„é€€å‡ºæ—¥èªŒ
        $this->logGroupLeave($order, $reason);
    });
}
```

### 4. ç¾¤çµ„è½‰ç§»åŠŸèƒ½

#### ä¸»è¨‚å–®è½‰ç§»é‚è¼¯
```php
/**
 * è½‰ç§»ç¾¤çµ„ä¸»è¨‚å–®
 */
public function transferGroupOwnership($groupId, $newMainOrderId)
{
    DB::transaction(function() use ($groupId, $newMainOrderId) {
        // å–æ¶ˆåŸä¸»è¨‚å–®
        Order::where('carpool_group_id', $groupId)
             ->where('is_main_order', true)
             ->update(['is_main_order' => false]);
        
        // è¨­å®šæ–°ä¸»è¨‚å–®
        $newMainOrder = Order::where('carpool_group_id', $groupId)
                             ->where('id', $newMainOrderId)
                             ->first();
        
        if (!$newMainOrder) {
            throw new CarpoolGroupException('æŒ‡å®šçš„è¨‚å–®ä¸åœ¨è©²ç¾¤çµ„ä¸­');
        }
        
        $newMainOrder->update(['is_main_order' => true]);
        
        // è¨˜éŒ„è½‰ç§»æ—¥èªŒ
        $this->logOwnershipTransfer($groupId, $newMainOrder);
    });
}
```

### 5. å‹•æ…‹è¨ˆè²»ç³»çµ±

#### è¨ˆè²»æ¨¡å¼è¨­è¨ˆ
```php
// app/Services/CarpoolBillingService.php

class CarpoolBillingService
{
    const BILLING_SEPARATE = 'separate';     // åˆ†åˆ¥è¨ˆè²»
    const BILLING_SHARED = 'shared';         // å…±åŒè¨ˆè²»
    const BILLING_SPLIT = 'split';           // åˆ†æ”¤è¨ˆè²»
    
    /**
     * è¨ˆç®—ç¾¤çµ„è²»ç”¨
     */
    public function calculateGroupBilling($groupId, $billingMode = self::BILLING_SPLIT)
    {
        $groupOrders = Order::where('carpool_group_id', $groupId)->get();
        $baseFare = $this->calculateBaseFare($groupOrders->first());
        
        switch ($billingMode) {
            case self::BILLING_SEPARATE:
                return $this->calculateSeparateBilling($groupOrders, $baseFare);
                
            case self::BILLING_SHARED:
                return $this->calculateSharedBilling($groupOrders, $baseFare);
                
            case self::BILLING_SPLIT:
                return $this->calculateSplitBilling($groupOrders, $baseFare);
                
            default:
                throw new InvalidArgumentException('ç„¡æ•ˆçš„è¨ˆè²»æ¨¡å¼');
        }
    }
    
    /**
     * åˆ†åˆ¥è¨ˆè²»ï¼šæ¯äººä»˜å…¨é¡
     */
    private function calculateSeparateBilling($orders, $baseFare)
    {
        return $orders->mapWithKeys(function($order) use ($baseFare) {
            return [$order->id => $baseFare];
        });
    }
    
    /**
     * å…±åŒè¨ˆè²»ï¼šä¸»è¨‚å–®ä»˜å…¨é¡
     */
    private function calculateSharedBilling($orders, $baseFare)
    {
        return $orders->mapWithKeys(function($order) use ($baseFare) {
            return [$order->id => $order->is_main_order ? $baseFare : 0];
        });
    }
    
    /**
     * åˆ†æ”¤è¨ˆè²»ï¼šå¹³å‡åˆ†é…
     */
    private function calculateSplitBilling($orders, $baseFare)
    {
        $splitAmount = $baseFare / $orders->count();
        
        return $orders->mapWithKeys(function($order) use ($splitAmount) {
            return [$order->id => $splitAmount];
        });
    }
}
```

---

## è¨˜æ†¶é«”ç®¡ç†è€ƒé‡

### å…±ä¹˜åŠŸèƒ½è¨˜æ†¶é«”å½±éŸ¿åˆ†æ

#### 1. è³‡æ–™åº«æŸ¥è©¢è¨˜æ†¶é«”å½±éŸ¿

**ç¾¤çµ„æŸ¥è©¢é–‹éŠ·**ï¼š
```php
// åŸå§‹å–®ç­†è¨‚å–®æŸ¥è©¢
Order::find($id); // ~2KB

// ç¾¤çµ„è¨‚å–®æŸ¥è©¢ï¼ˆå«é—œè¯ï¼‰
Order::with('groupMembers')->find($id); // ~6-10KB (è¦–ç¾¤çµ„å¤§å°)

// æ´¾é£æ¸…å–®æŸ¥è©¢å„ªåŒ–
Order::mainOrders()->with('groupMembers'); // æ¸›å°‘50%æŸ¥è©¢é‡
```

**è¨˜æ†¶é«”å„ªåŒ–ç­–ç•¥**ï¼š
```php
// å¤§é‡ç¾¤çµ„æŸ¥è©¢æ™‚ä½¿ç”¨åˆ†å¡Šè¼‰å…¥
Order::where('carpool_group_id', '!=', null)
     ->chunk(100, function($orders) {
         // è™•ç†æ¯100ç­†ç¾¤çµ„è¨‚å–®
     });

// é¸æ“‡æ€§è¼‰å…¥ç¾¤çµ„è³‡è¨Š
Order::select(['id', 'order_number', 'customer_name', 'carpool_group_id'])
     ->mainOrders()
     ->paginate(50);
```

#### 2. ç¾¤çµ„ç‹€æ…‹åŒæ­¥è¨˜æ†¶é«”ç®¡ç†

**åŒæ­¥æ“ä½œè¨˜æ†¶é«”ä½¿ç”¨**ï¼š
```php
// é«˜è¨˜æ†¶é«”é¢¨éšªï¼šå¤§ç¾¤çµ„åŒæ­¥
public function syncGroupStatus($groupId, $status)
{
    // ä¸€æ¬¡è¼‰å…¥æ‰€æœ‰ç¾¤çµ„è¨‚å–®åˆ°è¨˜æ†¶é«”
    $orders = Order::where('carpool_group_id', $groupId)->get(); // é¢¨éšªé»
    
    foreach ($orders as $order) {
        $order->update(['status' => $status]);
    }
}

// è¨˜æ†¶é«”å„ªåŒ–ç‰ˆæœ¬
public function syncGroupStatusOptimized($groupId, $status)
{
    // ç›´æ¥æ‰¹é‡æ›´æ–°ï¼Œä¸è¼‰å…¥åˆ°è¨˜æ†¶é«”
    Order::where('carpool_group_id', $groupId)
         ->update(['status' => $status, 'updated_at' => now()]);
}
```

#### 3. å‰ç«¯ç¾¤çµ„è³‡æ–™è¨˜æ†¶é«”ç®¡ç†

**JavaScript è¨˜æ†¶é«”ä½¿ç”¨**ï¼š
```javascript
// ç¾¤çµ„è³‡æ–™å¿«å–ç­–ç•¥
class CarpoolGroupCache {
    constructor() {
        this.cache = new Map();
        this.maxSize = 100; // é™åˆ¶å¿«å–å¤§å°
    }
    
    set(groupId, data) {
        if (this.cache.size >= this.maxSize) {
            // LRU æ¸…ç†ç­–ç•¥
            const firstKey = this.cache.keys().next().value;
            this.cache.delete(firstKey);
        }
        this.cache.set(groupId, data);
    }
    
    get(groupId) {
        return this.cache.get(groupId);
    }
}
```

### å¤§é‡å…±ä¹˜è¨‚å–®è™•ç†ç­–ç•¥

#### 1. æ‰¹æ¬¡æ“ä½œå„ªåŒ–

```php
// æ‰¹æ¬¡å»ºç«‹å…±ä¹˜è¨‚å–®
public function batchCreateCarpoolOrders($orderDataArray)
{
    DB::transaction(function() use ($orderDataArray) {
        $groupId = 'batch_' . time();
        $orders = [];
        
        foreach ($orderDataArray as $index => $orderData) {
            $orders[] = array_merge($orderData, [
                'carpool_group_id' => $groupId,
                'is_main_order' => $index === 0,
                'created_at' => now(),
                'updated_at' => now()
            ]);
        }
        
        // æ‰¹æ¬¡æ’å…¥ï¼Œæ¸›å°‘è¨˜æ†¶é«”é–‹éŠ·
        Order::insert($orders);
    });
}
```

#### 2. ç´¢å¼•å„ªåŒ–å»ºè­°

```sql
-- ç¾¤çµ„æŸ¥è©¢ç´¢å¼•
CREATE INDEX idx_carpool_group_composite ON orders(carpool_group_id, is_main_order);

-- æ´¾é£æ¸…å–®ç´¢å¼•
CREATE INDEX idx_dispatch_optimized ON orders(is_main_order, status, ride_date, ride_time);

-- è§£é™¤ç¾¤çµ„æŸ¥è©¢ç´¢å¼•
CREATE INDEX idx_group_dissolution ON orders(is_group_dissolved, dissolved_at);
```

#### 3. è¨˜æ†¶é«”ç›£æ§æŒ‡æ¨™

```php
// å…±ä¹˜åŠŸèƒ½è¨˜æ†¶é«”ç›£æ§
class CarpoolMemoryMonitor
{
    public function monitorGroupOperation($operation, callable $callback)
    {
        $memoryStart = memory_get_usage();
        $result = $callback();
        $memoryEnd = memory_get_usage();
        
        $memoryUsed = $memoryEnd - $memoryStart;
        
        if ($memoryUsed > 10 * 1024 * 1024) { // 10MB
            Log::warning('å…±ä¹˜æ“ä½œé«˜è¨˜æ†¶é«”ä½¿ç”¨', [
                'operation' => $operation,
                'memory_used' => $memoryUsed,
                'peak_memory' => memory_get_peak_usage()
            ]);
        }
        
        return $result;
    }
}
```

### è¨˜æ†¶é«”ä½¿ç”¨åŸºæº–

**å–®ä¸€è¨‚å–® vs ç¾¤çµ„è¨‚å–®è¨˜æ†¶é«”å°æ¯”**ï¼š
```
å–®ä¸€è¨‚å–®ï¼š~2KB
2äººç¾¤çµ„ï¼š~4KB (+100%)
3äººç¾¤çµ„ï¼š~6KB (+200%)
4äººç¾¤çµ„ï¼š~8KB (+300%)

å»ºè­°ç¾¤çµ„å¤§å°é™åˆ¶ï¼šæœ€å¤š4äººï¼Œé¿å…è¨˜æ†¶é«”éåº¦ä½¿ç”¨
```

**æ‰¹é‡æ“ä½œè¨˜æ†¶é«”é™åˆ¶**ï¼š
```php
// è¨­å®šæ‰¹é‡æ“ä½œè¨˜æ†¶é«”é™åˆ¶
ini_set('memory_limit', '512M'); // è‡¨æ™‚æé«˜è¨˜æ†¶é«”é™åˆ¶

// åˆ†æ‰¹è™•ç†å¤§é‡ç¾¤çµ„
$groupIds = collect($allGroupIds)->chunk(50);
foreach ($groupIds as $chunk) {
    $this->processGroupBatch($chunk);
    gc_collect_cycles(); // å¼·åˆ¶åƒåœ¾å›æ”¶
}
```

---

## æ¸¬è©¦èˆ‡é©—è­‰ç­–ç•¥

### å–®å…ƒæ¸¬è©¦è¨ˆåŠƒ

#### 1. å…±ä¹˜ç¾¤çµ„æ ¸å¿ƒåŠŸèƒ½æ¸¬è©¦

```php
// tests/Unit/CarpoolGroupServiceTest.php

class CarpoolGroupServiceTest extends TestCase
{
    protected $carpoolService;
    
    public function setUp(): void
    {
        parent::setUp();
        $this->carpoolService = app(CarpoolGroupService::class);
    }
    
    /** @test */
    public function it_can_create_carpool_group()
    {
        // å»ºç«‹æ¸¬è©¦è³‡æ–™
        $customer1 = Customer::factory()->create();
        $customer2 = Customer::factory()->create();
        
        $orderData = [
            'customer_id' => $customer1->id,
            'carpool_customer_id' => $customer2->id,
            'ride_date' => '2024-01-01',
            'ride_time' => '14:00',
            // ... å…¶ä»–å¿…è¦æ¬„ä½
        ];
        
        // åŸ·è¡Œæ¸¬è©¦
        $result = $this->carpoolService->createCarpoolGroup($orderData);
        
        // é©—è­‰çµæœ
        $this->assertDatabaseHas('orders', [
            'customer_id' => $customer1->id,
            'carpool_group_id' => $result['group_id'],
            'is_main_order' => true
        ]);
        
        $this->assertDatabaseHas('orders', [
            'customer_id' => $customer2->id,
            'carpool_group_id' => $result['group_id'],
            'is_main_order' => false
        ]);
    }
    
    /** @test */
    public function it_can_dissolve_carpool_group()
    {
        // å»ºç«‹æ¸¬è©¦ç¾¤çµ„
        $group = $this->createTestGroup();
        
        // åŸ·è¡Œè§£é™¤
        $result = $this->carpoolService->dissolveGroup($group['group_id']);
        
        // é©—è­‰è§£é™¤çµæœ
        $this->assertDatabaseMissing('orders', [
            'carpool_group_id' => $group['group_id']
        ]);
        
        $this->assertDatabaseHas('orders', [
            'id' => $group['main_order_id'],
            'is_group_dissolved' => true,
            'original_group_id' => $group['group_id']
        ]);
    }
    
    /** @test */
    public function it_handles_return_trip_carpool_correctly()
    {
        // æ¸¬è©¦å¾€è¿”å…±ä¹˜åŠŸèƒ½
        $customer1 = Customer::factory()->create();
        $customer2 = Customer::factory()->create();
        
        $orderData = [
            'customer_id' => $customer1->id,
            'carpool_customer_id' => $customer2->id,
            'ride_date' => '2024-01-01',
            'ride_time' => '14:00',
            'back_time' => '16:00', // å›ç¨‹æ™‚é–“
            // ... å…¶ä»–æ¬„ä½
        ];
        
        $result = $this->carpoolService->createCarpoolGroup($orderData);
        
        // æ‡‰è©²å»ºç«‹4ç­†è¨‚å–®ï¼š2äººå¾€è¿”å„2ç­†
        $orders = Order::where('carpool_group_id', $result['group_id'])->get();
        $this->assertCount(4, $orders);
        
        // é©—è­‰å¾€è¿”è¨‚å–®çš„æ™‚é–“
        $outboundOrders = $orders->where('ride_time', '14:00');
        $returnOrders = $orders->where('ride_time', '16:00');
        
        $this->assertCount(2, $outboundOrders);
        $this->assertCount(2, $returnOrders);
    }
    
    private function createTestGroup()
    {
        $customer1 = Customer::factory()->create();
        $customer2 = Customer::factory()->create();
        
        $groupId = 'test_group_' . time();
        
        $mainOrder = Order::factory()->create([
            'customer_id' => $customer1->id,
            'carpool_group_id' => $groupId,
            'is_main_order' => true,
            'carpool_member_count' => 2
        ]);
        
        $carpoolOrder = Order::factory()->create([
            'customer_id' => $customer2->id,
            'carpool_group_id' => $groupId,
            'is_main_order' => false,
            'carpool_member_count' => 2
        ]);
        
        return [
            'group_id' => $groupId,
            'main_order_id' => $mainOrder->id,
            'carpool_order_id' => $carpoolOrder->id
        ];
    }
}
```

#### 2. ç¾¤çµ„ç‹€æ…‹åŒæ­¥æ¸¬è©¦

```php
// tests/Unit/CarpoolStatusSyncTest.php

class CarpoolStatusSyncTest extends TestCase
{
    /** @test */
    public function it_syncs_driver_assignment_across_group()
    {
        $group = $this->createTestGroup();
        $driver = Driver::factory()->create();
        
        $service = app(CarpoolGroupService::class);
        $service->assignDriverToGroup($group['group_id'], $driver->id, [
            'driver_name' => $driver->name,
            'driver_fleet_number' => $driver->fleet_number,
            'driver_plate_number' => $driver->plate_number
        ]);
        
        // é©—è­‰ç¾¤çµ„å…§æ‰€æœ‰è¨‚å–®éƒ½è¢«æŒ‡æ´¾ç›¸åŒå¸æ©Ÿ
        $orders = Order::where('carpool_group_id', $group['group_id'])->get();
        
        foreach ($orders as $order) {
            $this->assertEquals($driver->id, $order->driver_id);
            $this->assertEquals('assigned', $order->status);
        }
    }
    
    /** @test */
    public function it_handles_group_cancellation_correctly()
    {
        $group = $this->createTestGroup();
        
        $service = app(CarpoolGroupService::class);
        $service->cancelGroup($group['group_id'], 'å®¢æˆ¶å–æ¶ˆ');
        
        // é©—è­‰ç¾¤çµ„å…§æ‰€æœ‰è¨‚å–®éƒ½è¢«å–æ¶ˆ
        $orders = Order::where('carpool_group_id', $group['group_id'])->get();
        
        foreach ($orders as $order) {
            $this->assertEquals('cancelled', $order->status);
            $this->assertStringContains('å®¢æˆ¶å–æ¶ˆ', $order->remark);
        }
    }
}
```

### æ•´åˆæ¸¬è©¦å ´æ™¯

#### 1. å®Œæ•´å…±ä¹˜æµç¨‹æ¸¬è©¦

```php
// tests/Feature/CarpoolIntegrationTest.php

class CarpoolIntegrationTest extends TestCase
{
    use RefreshDatabase, WithFaker;
    
    /** @test */
    public function complete_carpool_workflow()
    {
        // 1. ç™»å…¥ç”¨æˆ¶
        $user = User::factory()->create();
        $this->actingAs($user);
        
        // 2. å»ºç«‹å®¢æˆ¶è³‡æ–™
        $customer1 = Customer::factory()->create();
        $customer2 = Customer::factory()->create();
        
        // 3. å»ºç«‹å…±ä¹˜è¨‚å–®
        $response = $this->post('/orders', [
            'customer_id' => $customer1->id,
            'customer_name' => $customer1->name,
            'customer_id_number' => $customer1->id_number,
            'customer_phone' => $customer1->phone_number[0],
            'carpool_customer_id' => $customer2->id,
            'carpool_with' => $customer2->name,
            'ride_date' => '2024-01-01',
            'ride_time' => '14:00',
            'back_time' => '16:00',
            'pickup_address' => 'å°åŒ—å¸‚ä¸­æ­£å€å¿ å­è¥¿è·¯ä¸€æ®µ49è™Ÿ',
            'dropoff_address' => 'å°åŒ—å¸‚å¤§å®‰å€åŸºéš†è·¯å››æ®µ43è™Ÿ',
            // ... å…¶ä»–å¿…è¦æ¬„ä½
        ]);
        
        $response->assertRedirect();
        $response->assertSessionHas('success', 'æˆåŠŸå»ºç«‹ 4 ç­†è¨‚å–®ï¼ˆå»ç¨‹å’Œå›ç¨‹ï¼‰');
        
        // 4. é©—è­‰å»ºç«‹çš„è¨‚å–®
        $orders = Order::whereNotNull('carpool_group_id')->get();
        $this->assertCount(4, $orders);
        
        // 5. æŒ‡æ´¾å¸æ©Ÿ
        $driver = Driver::factory()->create();
        $groupId = $orders->first()->carpool_group_id;
        
        $response = $this->post("/carpool-groups/{$groupId}/assign-driver", [
            'driver_id' => $driver->id
        ]);
        
        $response->assertJson(['success' => true]);
        
        // 6. é©—è­‰å¸æ©ŸæŒ‡æ´¾
        $orders->each(function($order) use ($driver) {
            $order->refresh();
            $this->assertEquals($driver->id, $order->driver_id);
            $this->assertEquals('assigned', $order->status);
        });
        
        // 7. è§£é™¤ç¾¤çµ„
        $response = $this->post("/carpool-groups/{$groupId}/dissolve", [
            'reason' => 'å®¢æˆ¶ä¸æƒ³å…±ä¹˜äº†'
        ]);
        
        $response->assertJson(['success' => true]);
        
        // 8. é©—è­‰è§£é™¤çµæœ
        $orders->each(function($order) {
            $order->refresh();
            $this->assertNull($order->carpool_group_id);
            $this->assertTrue($order->is_group_dissolved);
        });
    }
}
```

#### 2. è¨˜æ†¶é«”å£“åŠ›æ¸¬è©¦

```php
// tests/Performance/CarpoolMemoryTest.php

class CarpoolMemoryTest extends TestCase
{
    /** @test */
    public function it_handles_large_carpool_groups_efficiently()
    {
        $memoryStart = memory_get_usage();
        
        // å»ºç«‹100å€‹ç¾¤çµ„ï¼Œæ¯ç¾¤çµ„4äºº
        for ($i = 0; $i < 100; $i++) {
            $customers = Customer::factory()->count(4)->create();
            $this->createCarpoolGroup($customers);
        }
        
        $memoryEnd = memory_get_usage();
        $memoryUsed = $memoryEnd - $memoryStart;
        
        // é©—è­‰è¨˜æ†¶é«”ä½¿ç”¨ä¸è¶…é100MB
        $this->assertLessThan(100 * 1024 * 1024, $memoryUsed);
        
        // æ¸¬è©¦æ‰¹é‡æŸ¥è©¢æ•ˆèƒ½
        $start = microtime(true);
        $mainOrders = Order::mainOrders()->with('groupMembers')->get();
        $queryTime = microtime(true) - $start;
        
        // æŸ¥è©¢æ™‚é–“æ‡‰è©²åœ¨åˆç†ç¯„åœå…§
        $this->assertLessThan(2.0, $queryTime); // 2ç§’å…§
    }
    
    private function createCarpoolGroup($customers)
    {
        $groupId = 'perf_test_' . uniqid();
        
        foreach ($customers as $index => $customer) {
            Order::factory()->create([
                'customer_id' => $customer->id,
                'carpool_group_id' => $groupId,
                'is_main_order' => $index === 0,
                'carpool_member_count' => $customers->count()
            ]);
        }
    }
}
```

### ç”¨æˆ¶é«”é©—æ¸¬è©¦

#### 1. å‰ç«¯äº’å‹•æ¸¬è©¦

```php
// tests/Browser/CarpoolUserExperienceTest.php

class CarpoolUserExperienceTest extends DuskTestCase
{
    /** @test */
    public function user_can_create_carpool_order_smoothly()
    {
        $user = User::factory()->create();
        $customer1 = Customer::factory()->create();
        $customer2 = Customer::factory()->create();
        
        $this->browse(function (Browser $browser) use ($user, $customer1, $customer2) {
            $browser->loginAs($user)
                    ->visit('/orders/create')
                    
                    // é¸æ“‡å®¢æˆ¶
                    ->type('customer_phone', $customer1->phone_number[0])
                    ->click('#searchCustomerBtn')
                    ->waitForText($customer1->name)
                    ->click('.select-customer-btn')
                    
                    // å¡«å¯«è¨‚å–®è³‡è¨Š
                    ->type('ride_date', '2024-01-01')
                    ->type('ride_time', '1400')
                    ->type('back_time', '1600')
                    ->type('pickup_address', 'å°åŒ—å¸‚ä¸­æ­£å€å¿ å­è¥¿è·¯ä¸€æ®µ49è™Ÿ')
                    ->type('dropoff_address', 'å°åŒ—å¸‚å¤§å®‰å€åŸºéš†è·¯å››æ®µ43è™Ÿ')
                    
                    // æœå°‹å…±ä¹˜å°è±¡
                    ->type('#carpoolSearchInput', $customer2->name)
                    ->click('#searchCarpoolBtn')
                    ->waitForText($customer2->name)
                    ->click('.select-carpool-btn')
                    
                    // é©—è­‰å…±ä¹˜è³‡è¨Šå·²å¡«å…¥
                    ->assertInputValue('#carpool_with', $customer2->name)
                    
                    // æäº¤è¨‚å–®
                    ->click('button[type="submit"]')
                    ->waitForText('æˆåŠŸå»ºç«‹ 4 ç­†è¨‚å–®')
                    
                    // é©—è­‰é é¢è·³è½‰å’Œè¨Šæ¯
                    ->assertPathIs('/orders')
                    ->assertSee('æˆåŠŸå»ºç«‹ 4 ç­†è¨‚å–®ï¼ˆå»ç¨‹å’Œå›ç¨‹ï¼‰');
        });
    }
    
    /** @test */
    public function user_can_manage_carpool_group()
    {
        $user = User::factory()->create();
        $group = $this->createTestGroupWithOrders();
        
        $this->browse(function (Browser $browser) use ($user, $group) {
            $browser->loginAs($user)
                    ->visit('/orders')
                    
                    // é»æ“Šç¾¤çµ„ç®¡ç†æŒ‰éˆ•
                    ->click("[data-group-id='{$group['group_id']}']")
                    ->waitFor('#carpoolGroupModal')
                    
                    // é©—è­‰ç¾¤çµ„è³‡è¨Šé¡¯ç¤º
                    ->assertSee($group['group_id'])
                    ->assertSee('æˆå“¡æ•¸é‡ï¼š2')
                    
                    // æ¸¬è©¦è§£é™¤ç¾¤çµ„
                    ->type('#dissolutionReason', 'æ¸¬è©¦è§£é™¤')
                    ->click('.btn-warning')
                    ->waitForText('ç¢ºèªè§£é™¤')
                    ->click('.swal2-confirm')
                    ->waitForText('æ“ä½œæˆåŠŸ')
                    
                    // é©—è­‰é é¢æ›´æ–°
                    ->assertDontSee("[data-group-id='{$group['group_id']}']");
        });
    }
}
```

### æ•ˆèƒ½æ¸¬è©¦åŸºæº–

#### 1. æŸ¥è©¢æ•ˆèƒ½åŸºæº–

```php
// å–®ä¸€è¨‚å–®æŸ¥è©¢ï¼š< 50ms
// ç¾¤çµ„è¨‚å–®æŸ¥è©¢ï¼š< 100ms
// æ´¾é£æ¸…å–®è¼‰å…¥ï¼š< 200ms
// ç¾¤çµ„è§£é™¤æ“ä½œï¼š< 500ms
```

#### 2. è¨˜æ†¶é«”ä½¿ç”¨åŸºæº–

```php
// å»ºç«‹2äººç¾¤çµ„ï¼š< 5MB
// å»ºç«‹4äººç¾¤çµ„ï¼š< 10MB
// æ‰¹é‡ç¾¤çµ„æ“ä½œï¼ˆ100ç¾¤çµ„ï¼‰ï¼š< 100MB
// ç¾¤çµ„è§£é™¤æ“ä½œï¼š< 2MB
```

#### 3. ä½µç™¼è™•ç†åŸºæº–

```php
// åŒæ™‚å»ºç«‹10å€‹ç¾¤çµ„ï¼š< 2ç§’
// åŒæ™‚è§£é™¤10å€‹ç¾¤çµ„ï¼š< 3ç§’
// 100å€‹ä½µç™¼æŸ¥è©¢ï¼š< 5ç§’
```

---

## ç¸½çµèˆ‡å»ºè­°

### å¯¦ä½œå„ªå…ˆé †åº

#### ç¬¬ä¸€éšæ®µï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆå¿…é ˆï¼‰
1. âœ… è³‡æ–™åº«çµæ§‹èª¿æ•´
2. âœ… åŸºæœ¬ç¾¤çµ„å»ºç«‹åŠŸèƒ½
3. âœ… ç¾¤çµ„ç‹€æ…‹åŒæ­¥æ©Ÿåˆ¶
4. âœ… æ´¾é£ç³»çµ±æ•´åˆ

#### ç¬¬äºŒéšæ®µï¼šç®¡ç†åŠŸèƒ½ï¼ˆé‡è¦ï¼‰
1. âœ… ç¾¤çµ„è§£é™¤åŠŸèƒ½
2. âœ… å‰ç«¯ç¾¤çµ„ç®¡ç†ä»‹é¢
3. âœ… API è¨­è¨ˆå’Œå¯¦ä½œ
4. âœ… åŸºæœ¬æ¸¬è©¦è¦†è“‹

#### ç¬¬ä¸‰éšæ®µï¼šé€²éšåŠŸèƒ½ï¼ˆå¯é¸ï¼‰
1. ğŸ”„ æ™ºèƒ½é…å°å»ºè­°
2. ğŸ”„ é‡æ–°çµ„ç¾¤åŠŸèƒ½
3. ğŸ”„ å‹•æ…‹è¨ˆè²»ç³»çµ±
4. ğŸ”„ å®Œæ•´æ¸¬è©¦å¥—ä»¶

### é•·æœŸç¶­è­·å»ºè­°

#### 1. å®šæœŸæ•ˆèƒ½ç›£æ§
- ç›£æ§ç¾¤çµ„æŸ¥è©¢çš„åŸ·è¡Œæ™‚é–“
- è¿½è¹¤è¨˜æ†¶é«”ä½¿ç”¨è¶¨å‹¢
- åˆ†æä½¿ç”¨è€…æ“ä½œæ¨¡å¼

#### 2. åŠŸèƒ½ä½¿ç”¨åˆ†æ
- çµ±è¨ˆå…±ä¹˜åŠŸèƒ½ä½¿ç”¨ç‡
- åˆ†æç¾¤çµ„è§£é™¤åŸå› 
- æ”¶é›†ç”¨æˆ¶åé¥‹æ„è¦‹

#### 3. ç³»çµ±æœ€ä½³åŒ–
- æ ¹æ“šä½¿ç”¨æ¨¡å¼èª¿æ•´ç´¢å¼•
- å„ªåŒ–æŸ¥è©¢é‚è¼¯å’Œå¿«å–ç­–ç•¥
- å®šæœŸæ¸…ç†è§£æ•£çš„ç¾¤çµ„æ­·å²è³‡æ–™

### é¢¨éšªè©•ä¼°èˆ‡é æ¡ˆ

#### é«˜é¢¨éšªé»
1. **è³‡æ–™ä¸€è‡´æ€§**ï¼šç¾¤çµ„æ“ä½œçš„åŸå­æ€§
2. **æ•ˆèƒ½å½±éŸ¿**ï¼šå¤§é‡ç¾¤çµ„æŸ¥è©¢çš„æ•ˆèƒ½
3. **ç”¨æˆ¶é«”é©—**ï¼šè¤‡é›œæ“ä½œçš„æ˜“ç”¨æ€§

#### æ‡‰å°é æ¡ˆ
1. **è³‡æ–™åº«äº¤æ˜“**ï¼šç¢ºä¿æ‰€æœ‰ç¾¤çµ„æ“ä½œçš„åŸå­æ€§
2. **æŸ¥è©¢å„ªåŒ–**ï¼šä½¿ç”¨é©ç•¶çš„ç´¢å¼•å’ŒæŸ¥è©¢ç­–ç•¥
3. **ä»‹é¢è¨­è¨ˆ**ï¼šç°¡åŒ–æ“ä½œæµç¨‹å’Œæä¾›æ¸…æ¥šçš„æç¤º

---

*æ­¤æ–‡ä»¶æœ€å¾Œæ›´æ–°ï¼š2024å¹´12æœˆ31æ—¥*
*ç‰ˆæœ¬ï¼šv1.0*
*ç¶­è­·è€…ï¼šLC-management é–‹ç™¼åœ˜éšŠ*