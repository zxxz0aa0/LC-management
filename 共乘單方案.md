# 共乘系統規劃設計文件

本文件記錄 LC-management 長照服務管理系統中共乘功能的完整設計規劃，包含業務需求分析、技術方案設計、實作指南和未來擴展策略。

## 📋 文件目錄

1. [共乘系統總覽](#共乘系統總覽)
2. [設計方案對比](#設計方案對比)
3. [群組架構詳細設計](#群組架構詳細設計)
4. [群組解除功能設計](#群組解除功能設計)
5. [技術實作指南](#技術實作指南)
6. [進階功能擴展](#進階功能擴展)
7. [記憶體管理考量](#記憶體管理考量)
8. [測試與驗證策略](#測試與驗證策略)

---

## 共乘系統總覽

### 業務需求分析

**核心需求**：
- 當選擇共乘對象時，自動為共乘對象建立相同的訂單
- 支援往返功能：有回程時間時，共乘對象也要建立回程訂單
- 解決派遣重複問題：避免為同一趟行程派遣兩台車
- 提供群組管理功能：允許後續解除共乘關係

**使用場景**：
```
場景1：基本共乘
客戶A（張三）+ 客戶B（李四）
從 台北車站 → 台大醫院 14:00
結果：建立2筆關聯訂單，只派遣1台車

場景2：往返共乘  
客戶A（張三）+ 客戶B（李四）
去程：台北車站 → 台大醫院 14:00
回程：台大醫院 → 台北車站 16:00
結果：建立4筆關聯訂單，派遣2台車（去程1台，回程1台）

場景3：解除共乘
原本：張三+李四 共乘
解除後：張三獨立訂單 + 李四獨立訂單
```

### 現有功能評估

**✅ 已實現功能**：
- 共乘對象搜尋（姓名、身分證、電話）
- 共乘資訊記錄在主訂單中
- 共乘對象資料顯示（姓名、身分證、電話、地址）

**❌ 缺少功能**：
- 沒有為共乘對象建立獨立訂單
- 沒有群組關聯機制
- 派遣系統會重複派車
- 無法追蹤共乘對象的個人訂單歷史

### 核心問題識別

1. **派遣重複問題**：系統會為每筆訂單派遣一台車
2. **資料完整性問題**：共乘對象沒有個人訂單記錄
3. **狀態同步問題**：無法統一管理共乘群組的狀態
4. **歷史追蹤問題**：共乘對象的搭車記錄不完整

---

## 設計方案對比

### 方案A：訂單群組架構（🏆 推薦方案）

```
主訂單：張三 → A地到B地 14:00 [群組ID: carpool_001]
├─ 關聯訂單：李四 → A地到B地 14:00 [群組ID: carpool_001]
└─ 狀態同步：指派司機時，兩筆訂單同時更新
```

**優點**：
- ✅ 每人都有獨立訂單記錄（完整的個人歷史）
- ✅ 派遣時視為一組，只派一台車
- ✅ 支援靈活的狀態管理和群組操作
- ✅ 計費方式可靈活調整（分別計費/共同計費/分攤計費）
- ✅ 支援群組解除功能

**缺點**：
- ❌ 資料庫結構需要調整
- ❌ 邏輯相對複雜，需要狀態同步機制
- ❌ 開發工作量較大

### 方案B：單一訂單多乘客

```
主訂單：張三+李四 → A地到B地 14:00
├─ 主乘客：張三（訂單所有者）
└─ 乘客清單：[張三, 李四]
```

**優點**：
- ✅ 派遣簡單，天然避免重複派車
- ✅ 資料一致性容易維護
- ✅ 開發工作量較小

**缺點**：
- ❌ 李四沒有個人訂單歷史記錄
- ❌ 狀態管理複雜（如何處理個人狀態差異）
- ❌ 計費邏輯受限
- ❌ 無法支援靈活的群組操作

### 方案選擇結論

**選擇方案A：訂單群組架構**

**選擇理由**：
1. **業務完整性**：每位客戶都有完整的搭車記錄
2. **系統擴展性**：支援更多元的群組操作和計費方式
3. **用戶體驗**：個人訂單歷史完整，狀態清楚
4. **技術靈活性**：可以支援複雜的業務場景

**代價接受**：願意承擔較高的開發複雜度，換取更完整的功能和更好的用戶體驗。

---

## 群組架構詳細設計

### 資料庫結構調整

#### 新增欄位到 orders 表

```sql
-- 群組相關欄位
ALTER TABLE orders ADD COLUMN carpool_group_id VARCHAR(50) NULL COMMENT '共乘群組ID';
ALTER TABLE orders ADD COLUMN is_main_order BOOLEAN DEFAULT TRUE COMMENT '是否為主訂單';
ALTER TABLE orders ADD COLUMN carpool_member_count INT DEFAULT 1 COMMENT '群組成員數量';

-- 群組解除相關欄位
ALTER TABLE orders ADD COLUMN is_group_dissolved BOOLEAN DEFAULT FALSE COMMENT '群組是否已解除';
ALTER TABLE orders ADD COLUMN dissolved_at TIMESTAMP NULL COMMENT '群組解除時間';
ALTER TABLE orders ADD COLUMN dissolved_by VARCHAR(255) NULL COMMENT '解除操作人';
ALTER TABLE orders ADD COLUMN original_group_id VARCHAR(50) NULL COMMENT '原群組ID（保留歷史記錄）';

-- 索引優化
CREATE INDEX idx_carpool_group_id ON orders(carpool_group_id);
CREATE INDEX idx_main_order ON orders(is_main_order);
CREATE INDEX idx_group_dissolved ON orders(is_group_dissolved);
```

#### Order Model 調整

```php
// app/Models/Order.php
protected $fillable = [
    // ... 現有欄位
    'carpool_group_id',
    'is_main_order', 
    'carpool_member_count',
    'is_group_dissolved',
    'dissolved_at',
    'dissolved_by',
    'original_group_id',
];

protected $casts = [
    // ... 現有欄位
    'is_main_order' => 'boolean',
    'is_group_dissolved' => 'boolean',
    'dissolved_at' => 'datetime',
];

// 群組訂單關聯
public function groupMembers()
{
    return $this->hasMany(Order::class, 'carpool_group_id', 'carpool_group_id')
                ->where('id', '!=', $this->id);
}

// 群組主訂單
public function mainOrder()
{
    return $this->belongsTo(Order::class, 'carpool_group_id', 'carpool_group_id')
                ->where('is_main_order', true);
}

// Scope: 僅主訂單
public function scopeMainOrders($query)
{
    return $query->where('is_main_order', true);
}

// Scope: 群組訂單
public function scopeGroupOrders($query)
{
    return $query->whereNotNull('carpool_group_id');
}
```

### 核心業務邏輯

#### 共乘訂單創建流程

```php
// app/Http/Controllers/OrderController.php - store() 方法修改

public function store(Request $request)
{
    DB::transaction(function() use ($request, $validated) {
        // 1. 建立主訂單（原客戶）
        $mainOrder = $this->createMainOrder($validated);
        
        // 2. 檢查是否有共乘對象
        if ($request->filled('carpool_customer_id')) {
            // 生成群組ID
            $groupId = 'carpool_' . time() . '_' . rand(1000, 9999);
            
            // 更新主訂單群組資訊
            $mainOrder->update([
                'carpool_group_id' => $groupId,
                'is_main_order' => true,
                'carpool_member_count' => 2
            ]);
            
            // 建立共乘對象訂單
            $carpoolOrder = $this->createCarpoolOrder($validated, $groupId);
            
            // 3. 處理回程訂單
            if (!empty($validated['back_time'])) {
                $this->createReturnOrders($mainOrder, $carpoolOrder, $validated);
            }
        }
        
        // 4. 記錄地標使用次數
        $this->recordLandmarkUsage($request);
    });
}

private function createCarpoolOrder($validated, $groupId)
{
    // 取得共乘對象資料
    $carpoolCustomer = Customer::find($validated['carpool_customer_id']);
    
    // 生成共乘訂單編號
    $carpoolOrderNumber = $this->generateOrderNumber($carpoolCustomer);
    
    return Order::create([
        'order_number' => $carpoolOrderNumber,
        'carpool_group_id' => $groupId,
        'is_main_order' => false,
        'carpool_member_count' => 2,
        
        // 使用共乘對象的客戶資料
        'customer_id' => $carpoolCustomer->id,
        'customer_name' => $carpoolCustomer->name,
        'customer_id_number' => $carpoolCustomer->id_number,
        'customer_phone' => is_array($carpoolCustomer->phone_number) 
            ? $carpoolCustomer->phone_number[0] 
            : $carpoolCustomer->phone_number,
            
        // 其他訂單資料與主訂單相同
        'ride_date' => $validated['ride_date'],
        'ride_time' => $validated['ride_time'],
        'pickup_address' => $validated['pickup_address'],
        'dropoff_address' => $validated['dropoff_address'],
        'status' => $validated['status'],
        // ... 其他相同欄位
    ]);
}
```

### 狀態同步機制

#### 群組狀態同步 Service

```php
// app/Services/CarpoolGroupService.php

class CarpoolGroupService
{
    /**
     * 同步群組狀態
     */
    public function syncGroupStatus($groupId, $newStatus, $updateData = [])
    {
        DB::transaction(function() use ($groupId, $newStatus, $updateData) {
            Order::where('carpool_group_id', $groupId)
                 ->update(array_merge([
                     'status' => $newStatus,
                     'updated_at' => now()
                 ], $updateData));
        });
    }
    
    /**
     * 指派司機給群組
     */
    public function assignDriverToGroup($groupId, $driverId, $driverData)
    {
        $driver = Driver::find($driverId);
        
        $this->syncGroupStatus($groupId, 'assigned', [
            'driver_id' => $driverId,
            'driver_name' => $driver->name,
            'driver_fleet_number' => $driver->fleet_number,
            'driver_plate_number' => $driver->plate_number,
        ]);
    }
    
    /**
     * 取消群組訂單
     */
    public function cancelGroup($groupId, $reason = '')
    {
        $this->syncGroupStatus($groupId, 'cancelled', [
            'remark' => $reason ? "取消原因：{$reason}" : ''
        ]);
    }
}
```

### 派遣系統整合

#### 派遣清單查詢調整

```php
// 派遣清單只顯示主訂單
public function getDispatchOrders(Request $request)
{
    $orders = Order::mainOrders() // 只查詢主訂單
                   ->where('status', 'open')
                   ->with(['customer', 'groupMembers'])
                   ->orderBy('ride_date', 'asc')
                   ->orderBy('ride_time', 'asc')
                   ->paginate(50);
    
    return view('dispatch.index', compact('orders'));
}
```

#### 派遣清單顯示邏輯

```php
// 在派遣清單中顯示群組資訊
public function getOrderDisplayInfo($order)
{
    if ($order->carpool_group_id) {
        $memberCount = $order->carpool_member_count;
        $memberNames = $order->groupMembers->pluck('customer_name')->join(', ');
        
        return [
            'display_name' => "{$order->customer_name} (+{$memberCount-1})",
            'member_info' => "共乘成員：{$memberNames}",
            'is_group' => true
        ];
    }
    
    return [
        'display_name' => $order->customer_name,
        'member_info' => '',
        'is_group' => false
    ];
}
```

---

## 群組解除功能設計

### 解除場景分析

#### 場景1：計劃階段解除（狀態：open）
```php
/**
 * 處理難度：⭐⭐⭐ 容易
 * 影響範圍：無司機指派，直接解除即可
 */
原始：張三+李四 共乘 A→B 14:00 [狀態: open]
解除後：
- 張三：A→B 14:00（獨立訂單）[狀態: open]
- 李四：A→B 14:00（獨立訂單）[狀態: open]
```

#### 場景2：已指派司機後解除（狀態：assigned）
```php
/**
 * 處理難度：⭐⭐⭐⭐ 需要重新派遣邏輯
 * 影響範圍：司機資源重新分配
 */
原始：張三+李四 → 王司機 → A→B 14:00 [狀態: assigned]
解除後：
- 張三：A→B 14:00 → 王司機（保持指派）[狀態: assigned]
- 李四：A→B 14:00 → 待重新派遣 [狀態: open]
```

#### 場景3：服務進行中解除（狀態：in_progress）
```php
/**
 * 處理難度：⭐⭐⭐⭐⭐ 需要特殊權限和處理
 * 影響範圍：可能影響正在進行的服務
 */
原始：張三+李四 → 王司機 → 服務中 [狀態: in_progress]
解除後：僅記錄解除請求，不立即執行
```

### 技術實作方案

#### 群組解除 Controller

```php
// app/Http/Controllers/CarpoolGroupController.php

class CarpoolGroupController extends Controller
{
    protected $carpoolService;
    
    public function __construct(CarpoolGroupService $carpoolService)
    {
        $this->carpoolService = $carpoolService;
    }
    
    /**
     * 解除共乘群組
     */
    public function dissolveGroup(Request $request, $groupId)
    {
        $request->validate([
            'reason' => 'nullable|string|max:500',
            'force' => 'boolean'
        ]);
        
        try {
            $result = DB::transaction(function() use ($groupId, $request) {
                return $this->carpoolService->dissolveGroup(
                    $groupId, 
                    $request->reason,
                    $request->force
                );
            });
            
            return response()->json([
                'success' => true,
                'message' => $result['message'],
                'affected_orders' => $result['orders']
            ]);
            
        } catch (CarpoolDissolutionException $e) {
            return response()->json([
                'success' => false,
                'message' => $e->getMessage(),
                'error_code' => $e->getCode()
            ], 400);
        }
    }
}
```

#### 群組解除 Service 邏輯

```php
// app/Services/CarpoolGroupService.php - 解除功能

/**
 * 解除共乘群組
 */
public function dissolveGroup($groupId, $reason = '', $force = false)
{
    $groupOrders = Order::where('carpool_group_id', $groupId)->get();
    
    if ($groupOrders->isEmpty()) {
        throw new CarpoolDissolutionException('群組不存在');
    }
    
    // 檢查解除條件
    $this->validateDissolutionConditions($groupOrders, $force);
    
    $result = ['orders' => [], 'message' => ''];
    
    foreach ($groupOrders as $order) {
        $dissolvedOrder = $this->dissolveOrder($order, $reason);
        $result['orders'][] = $dissolvedOrder;
    }
    
    $result['message'] = $this->generateDissolutionMessage($result['orders']);
    
    return $result;
}

/**
 * 解除單一訂單
 */
private function dissolveOrder($order, $reason)
{
    $originalStatus = $order->status;
    
    $updateData = [
        'original_group_id' => $order->carpool_group_id,
        'carpool_group_id' => null,
        'is_main_order' => true,
        'carpool_member_count' => 1,
        'is_group_dissolved' => true,
        'dissolved_at' => now(),
        'dissolved_by' => auth()->user()->name,
        
        // 清除共乘資訊
        'carpool_customer_id' => null,
        'carpool_name' => null,
        'carpool_id' => null,
    ];
    
    // 根據原狀態決定解除後的處理
    if ($originalStatus === 'assigned' && !$order->is_main_order) {
        // 非主訂單釋放司機，回到待派遣狀態
        $updateData = array_merge($updateData, [
            'driver_id' => null,
            'driver_name' => null,
            'driver_fleet_number' => null,
            'driver_plate_number' => null,
            'status' => 'open'
        ]);
    }
    
    $order->update($updateData);
    
    // 記錄解除日誌
    $this->logDissolution($order, $reason);
    
    return [
        'order_id' => $order->id,
        'customer_name' => $order->customer_name,
        'original_status' => $originalStatus,
        'new_status' => $order->status,
        'driver_retained' => $order->driver_id ? true : false
    ];
}

/**
 * 驗證解除條件
 */
private function validateDissolutionConditions($groupOrders, $force)
{
    $inProgressOrders = $groupOrders->where('status', 'in_progress');
    
    if ($inProgressOrders->isNotEmpty() && !$force) {
        throw new CarpoolDissolutionException(
            '群組中有正在進行的訂單，無法解除。如需強制解除，請聯繫管理員。',
            CarpoolDissolutionException::IN_PROGRESS_ERROR
        );
    }
    
    $completedOrders = $groupOrders->whereIn('status', ['completed', 'cancelled']);
    
    if ($completedOrders->count() === $groupOrders->count()) {
        throw new CarpoolDissolutionException(
            '群組中所有訂單已完成或取消，無需解除。',
            CarpoolDissolutionException::ALREADY_COMPLETED_ERROR
        );
    }
}
```

### 前端操作介面

#### 群組管理 Modal

```html
<!-- resources/views/orders/components/carpool-group-modal.blade.php -->
<div class="modal fade" id="carpoolGroupModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-users me-2"></i>共乘群組管理
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 群組資訊 -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">群組資訊</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>群組ID：</strong><span id="groupId"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>成員數量：</strong><span id="memberCount"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>建立時間：</strong><span id="createdAt"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>群組狀態：</strong><span id="groupStatus"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 成員列表 -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">群組成員</h6>
                    </div>
                    <div class="card-body">
                        <div id="memberList">
                            <!-- 動態填入成員資料 -->
                        </div>
                    </div>
                </div>
                
                <!-- 解除群組區域 -->
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>解除群組
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <h6>解除群組將會：</h6>
                            <ul class="mb-2">
                                <li>將群組內所有訂單變為獨立訂單</li>
                                <li>非主訂單可能需要重新派遣司機</li>
                                <li>計費方式可能改變</li>
                            </ul>
                            <strong class="text-danger">此操作無法復原</strong>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">解除原因（選填）</label>
                            <textarea id="dissolutionReason" class="form-control" rows="3" 
                                    placeholder="請說明解除群組的原因..."></textarea>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-warning" onclick="dissolveGroup()">
                                <i class="fas fa-unlink me-2"></i>確認解除群組
                            </button>
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                取消
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
```

#### JavaScript 群組管理邏輯

```javascript
// public/js/orders/carpool-group.js

class CarpoolGroupManager {
    constructor() {
        this.currentGroupId = null;
        this.init();
    }
    
    init() {
        this.bindEvents();
    }
    
    bindEvents() {
        // 群組管理按鈕點擊
        $(document).on('click', '.manage-group-btn', this.handleGroupManage.bind(this));
        
        // 解除群組確認
        $('#confirmDissolveBtn').on('click', this.confirmDissolveGroup.bind(this));
    }
    
    /**
     * 開啟群組管理 Modal
     */
    handleGroupManage(e) {
        const groupId = $(e.target).data('group-id');
        this.currentGroupId = groupId;
        this.loadGroupInfo(groupId);
        $('#carpoolGroupModal').modal('show');
    }
    
    /**
     * 載入群組資訊
     */
    async loadGroupInfo(groupId) {
        try {
            const response = await fetch(`/carpool-groups/${groupId}`);
            const data = await response.json();
            
            if (data.success) {
                this.displayGroupInfo(data.group);
            } else {
                this.showError('載入群組資訊失敗');
            }
        } catch (error) {
            console.error('載入群組資訊錯誤：', error);
            this.showError('載入群組資訊失敗');
        }
    }
    
    /**
     * 顯示群組資訊
     */
    displayGroupInfo(group) {
        $('#groupId').text(group.id);
        $('#memberCount').text(group.member_count);
        $('#createdAt').text(group.created_at);
        $('#groupStatus').html(this.getStatusBadge(group.status));
        
        // 顯示成員列表
        let memberHtml = '';
        group.members.forEach(member => {
            memberHtml += `
                <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                    <div>
                        <strong>${member.customer_name}</strong>
                        ${member.is_main_order ? '<span class="badge bg-primary ms-2">主訂單</span>' : ''}
                        <br>
                        <small class="text-muted">
                            訂單號：${member.order_number} | 
                            狀態：${this.getStatusText(member.status)}
                        </small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-info" 
                                onclick="viewOrder('${member.id}')">
                            查看訂單
                        </button>
                    </div>
                </div>
            `;
        });
        $('#memberList').html(memberHtml);
    }
    
    /**
     * 解除群組
     */
    async dissolveGroup() {
        const reason = $('#dissolutionReason').val().trim();
        
        // 二次確認
        const confirmed = await Swal.fire({
            title: '確認解除共乘群組？',
            text: '此操作無法復原',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '確認解除',
            cancelButtonText: '取消'
        });
        
        if (!confirmed.isConfirmed) return;
        
        try {
            const response = await fetch(`/carpool-groups/${this.currentGroupId}/dissolve`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                body: JSON.stringify({
                    reason: reason
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.showSuccess(data.message);
                $('#carpoolGroupModal').modal('hide');
                
                // 刷新頁面或更新訂單列表
                if (typeof refreshOrderTable === 'function') {
                    refreshOrderTable();
                } else {
                    location.reload();
                }
            } else {
                this.showError(data.message);
            }
            
        } catch (error) {
            console.error('解除群組錯誤：', error);
            this.showError('解除群組失敗，請稍後再試');
        }
    }
    
    /**
     * 獲取狀態標籤
     */
    getStatusBadge(status) {
        const statusMap = {
            'open': '<span class="badge bg-success">可派遣</span>',
            'assigned': '<span class="badge bg-primary">已指派</span>',
            'in_progress': '<span class="badge bg-warning">進行中</span>',
            'completed': '<span class="badge bg-secondary">已完成</span>',
            'cancelled': '<span class="badge bg-danger">已取消</span>'
        };
        
        return statusMap[status] || '<span class="badge bg-secondary">未知</span>';
    }
    
    /**
     * 獲取狀態文字
     */
    getStatusText(status) {
        const statusMap = {
            'open': '可派遣',
            'assigned': '已指派',
            'in_progress': '進行中', 
            'completed': '已完成',
            'cancelled': '已取消'
        };
        
        return statusMap[status] || '未知';
    }
    
    /**
     * 顯示成功訊息
     */
    showSuccess(message) {
        Swal.fire({
            title: '操作成功',
            text: message,
            icon: 'success',
            timer: 3000
        });
    }
    
    /**
     * 顯示錯誤訊息
     */
    showError(message) {
        Swal.fire({
            title: '操作失敗',
            text: message,
            icon: 'error'
        });
    }
}

// 初始化群組管理器
$(document).ready(function() {
    window.carpoolGroupManager = new CarpoolGroupManager();
});
```

---

## 技術實作指南

### 實作階段規劃

#### 階段1：資料庫調整（2-3小時）

**步驟1：創建遷移檔案**
```bash
php artisan make:migration add_carpool_group_fields_to_orders_table
```

**步驟2：遷移檔案內容**
```php
// database/migrations/xxxx_add_carpool_group_fields_to_orders_table.php

public function up()
{
    Schema::table('orders', function (Blueprint $table) {
        // 群組相關欄位
        $table->string('carpool_group_id', 50)->nullable()->index()->comment('共乘群組ID');
        $table->boolean('is_main_order')->default(true)->index()->comment('是否為主訂單');
        $table->integer('carpool_member_count')->default(1)->comment('群組成員數量');
        
        // 群組解除相關欄位
        $table->boolean('is_group_dissolved')->default(false)->index()->comment('群組是否已解除');
        $table->timestamp('dissolved_at')->nullable()->comment('群組解除時間');
        $table->string('dissolved_by')->nullable()->comment('解除操作人');
        $table->string('original_group_id', 50)->nullable()->comment('原群組ID');
    });
}

public function down()
{
    Schema::table('orders', function (Blueprint $table) {
        $table->dropIndex(['carpool_group_id']);
        $table->dropIndex(['is_main_order']); 
        $table->dropIndex(['is_group_dissolved']);
        
        $table->dropColumn([
            'carpool_group_id',
            'is_main_order',
            'carpool_member_count',
            'is_group_dissolved',
            'dissolved_at',
            'dissolved_by',
            'original_group_id'
        ]);
    });
}
```

**步驟3：執行遷移**
```bash
php artisan migrate
```

#### 階段2：後端邏輯實作（8-12小時）

**步驟1：建立 Service 類別**
```bash
php artisan make:service CarpoolGroupService
```

**步驟2：建立 Exception 類別**
```bash
php artisan make:exception CarpoolDissolutionException
```

**步驟3：建立 Controller**
```bash
php artisan make:controller CarpoolGroupController
```

**步驟4：更新 Order Model**
```php
// 在 app/Models/Order.php 中添加相關方法和關聯
```

**步驟5：修改 OrderController::store()**
```php
// 整合共乘訂單創建邏輯
```

#### 階段3：前端整合（4-6小時）

**步驟1：創建群組管理 JavaScript**
```bash
touch public/js/orders/carpool-group.js
```

**步驟2：創建 Blade 組件**
```bash
touch resources/views/orders/components/carpool-group-modal.blade.php
```

**步驟3：更新訂單表單邏輯**
```javascript
// 修改 public/js/orders/form.js
```

**步驟4：更新訂單列表顯示**
```php
// 修改 resources/views/orders/components/order-table.blade.php
```

#### 階段4：派遣系統整合（6-8小時）

**步驟1：調整派遣查詢邏輯**
```php
// 只顯示主訂單的派遣清單
```

**步驟2：群組狀態同步機制**
```php
// 實作狀態同步 Service
```

**步驟3：派遣介面優化**
```html
<!-- 顯示群組資訊的派遣介面 -->
```

### API 設計規範

#### 共乘群組相關 API

```php
// routes/web.php
Route::middleware('auth')->group(function () {
    // 群組資訊
    Route::get('/carpool-groups/{groupId}', [CarpoolGroupController::class, 'show']);
    
    // 解除群組
    Route::post('/carpool-groups/{groupId}/dissolve', [CarpoolGroupController::class, 'dissolveGroup']);
    
    // 群組狀態同步
    Route::patch('/carpool-groups/{groupId}/status', [CarpoolGroupController::class, 'updateStatus']);
    
    // 指派司機給群組
    Route::post('/carpool-groups/{groupId}/assign-driver', [CarpoolGroupController::class, 'assignDriver']);
});
```

#### API 回應格式

```json
// 群組資訊 API 回應
{
    "success": true,
    "group": {
        "id": "carpool_1640995200_1234",
        "member_count": 2,
        "status": "open",
        "created_at": "2023-12-31 14:00:00",
        "members": [
            {
                "id": 123,
                "order_number": "NTPC00120231231140001",
                "customer_name": "張三",
                "is_main_order": true,
                "status": "open"
            },
            {
                "id": 124,
                "order_number": "NTPC00420231231140002", 
                "customer_name": "李四",
                "is_main_order": false,
                "status": "open"
            }
        ]
    }
}

// 解除群組 API 回應
{
    "success": true,
    "message": "共乘群組已成功解除",
    "affected_orders": [
        {
            "order_id": 123,
            "customer_name": "張三",
            "original_status": "assigned",
            "new_status": "assigned",
            "driver_retained": true
        },
        {
            "order_id": 124,
            "customer_name": "李四", 
            "original_status": "assigned",
            "new_status": "open",
            "driver_retained": false
        }
    ]
}
```

### 驗證規則調整

```php
// app/Http/Requests/StoreOrderRequest.php
public function rules(): array
{
    return [
        // ... 現有規則
        'carpool_customer_id' => 'nullable|exists:customers,id',
        'carpool_with' => 'nullable|string|max:255',
        'carpool_id_number' => 'nullable|string|max:20',
        'carpool_phone_number' => 'nullable|string|max:20',
        'carpool_addresses' => 'nullable|string|max:500',
    ];
}

// app/Http/Requests/DissolveGroupRequest.php
class DissolveGroupRequest extends FormRequest
{
    public function rules(): array
    {
        return [
            'reason' => 'nullable|string|max:500',
            'force' => 'boolean'
        ];
    }
}
```

---

## 進階功能擴展

### 1. 智能配對建議系統

#### 業務邏輯
```php
// app/Services/CarpoolMatchingService.php

class CarpoolMatchingService
{
    /**
     * 尋找潛在共乘對象
     */
    public function findPotentialMatches($orderId)
    {
        $order = Order::findOrFail($orderId);
        
        // 基本條件：相同日期、相近時間、相同路線
        $matches = Order::where('ride_date', $order->ride_date)
            ->where('status', 'open')
            ->where('id', '!=', $orderId)
            ->whereNull('carpool_group_id') // 未加入其他群組
            ->whereBetween('ride_time', [
                Carbon::parse($order->ride_time)->subMinutes(30),
                Carbon::parse($order->ride_time)->addMinutes(30)
            ])
            ->get();
        
        // 路線相似度計算
        return $matches->map(function($match) use ($order) {
            $similarity = $this->calculateRouteSimilarity($order, $match);
            $match->similarity_score = $similarity;
            return $match;
        })->where('similarity_score', '>', 0.7)
          ->sortByDesc('similarity_score');
    }
    
    /**
     * 計算路線相似度
     */
    private function calculateRouteSimilarity($order1, $order2)
    {
        // 簡化的相似度計算（實際可用更複雜的地理算法）
        $pickupMatch = similar_text($order1->pickup_address, $order2->pickup_address) / 100;
        $dropoffMatch = similar_text($order1->dropoff_address, $order2->dropoff_address) / 100;
        
        return ($pickupMatch + $dropoffMatch) / 2;
    }
}
```

#### 前端智能推薦界面
```html
<!-- 在訂單建立頁面顯示推薦共乘 -->
<div class="card border-info mb-3" id="carpoolSuggestions" style="display: none;">
    <div class="card-header bg-info text-white">
        <h6 class="mb-0">
            <i class="fas fa-lightbulb me-2"></i>智能共乘推薦
        </h6>
    </div>
    <div class="card-body">
        <p class="text-muted">系統為您找到以下潛在的共乘對象：</p>
        <div id="suggestedMatches">
            <!-- 動態載入推薦列表 -->
        </div>
    </div>
</div>
```

### 2. 重新組群功能

#### 業務場景
```
場景：兩個獨立訂單希望合併成共乘
訂單A：張三 A地→B地 14:00
訂單B：李四 A地→B地 14:10
操作：選擇兩筆訂單，合併成共乘群組
```

#### 實作邏輯
```php
// app/Services/CarpoolGroupService.php

/**
 * 重新組群功能
 */
public function createGroupFromOrders(array $orderIds, $mainOrderId = null)
{
    DB::transaction(function() use ($orderIds, $mainOrderId) {
        $orders = Order::whereIn('id', $orderIds)
            ->where('status', 'open') // 只允許未派遣的訂單組群
            ->whereNull('carpool_group_id') // 未加入其他群組
            ->get();
        
        if ($orders->count() !== count($orderIds)) {
            throw new CarpoolGroupException('部分訂單無法組群');
        }
        
        // 驗證訂單相容性
        $this->validateOrderCompatibility($orders);
        
        // 生成新群組ID
        $groupId = 'regroup_' . time() . '_' . rand(1000, 9999);
        
        // 設定主訂單
        $mainOrder = $mainOrderId ? $orders->find($mainOrderId) : $orders->first();
        
        foreach ($orders as $order) {
            $order->update([
                'carpool_group_id' => $groupId,
                'is_main_order' => $order->id === $mainOrder->id,
                'carpool_member_count' => $orders->count()
            ]);
        }
        
        return $groupId;
    });
}

/**
 * 驗證訂單相容性
 */
private function validateOrderCompatibility($orders)
{
    $firstOrder = $orders->first();
    
    foreach ($orders as $order) {
        // 檢查日期
        if ($order->ride_date !== $firstOrder->ride_date) {
            throw new CarpoolGroupException('訂單日期不同，無法組群');
        }
        
        // 檢查時間差異（不超過30分鐘）
        $timeDiff = abs(Carbon::parse($order->ride_time)
            ->diffInMinutes(Carbon::parse($firstOrder->ride_time)));
        
        if ($timeDiff > 30) {
            throw new CarpoolGroupException('訂單時間差異過大，無法組群');
        }
        
        // 檢查路線相似度
        $similarity = $this->calculateRouteSimilarity($order, $firstOrder);
        if ($similarity < 0.8) {
            throw new CarpoolGroupException('訂單路線差異過大，無法組群');
        }
    }
}
```

### 3. 部分退出功能

#### 業務邏輯
```php
/**
 * 單一成員退出群組
 */
public function leaveGroup($orderId, $reason = '')
{
    DB::transaction(function() use ($orderId, $reason) {
        $order = Order::findOrFail($orderId);
        $groupId = $order->carpool_group_id;
        
        if (!$groupId) {
            throw new CarpoolGroupException('該訂單不在任何群組中');
        }
        
        $groupOrders = Order::where('carpool_group_id', $groupId)->get();
        
        if ($groupOrders->count() <= 2) {
            // 只剩2人的群組，直接解散
            return $this->dissolveGroup($groupId, "成員 {$order->customer_name} 退出");
        }
        
        // 移除該成員
        $order->update([
            'original_group_id' => $groupId,
            'carpool_group_id' => null,
            'is_main_order' => true,
            'carpool_member_count' => 1,
            'carpool_customer_id' => null,
            'carpool_name' => null,
            'carpool_id' => null,
        ]);
        
        // 更新剩餘成員的人數
        $remainingCount = $groupOrders->count() - 1;
        Order::where('carpool_group_id', $groupId)
             ->update(['carpool_member_count' => $remainingCount]);
        
        // 如果退出的是主訂單，需要重新指定主訂單
        if ($order->is_main_order) {
            $newMainOrder = Order::where('carpool_group_id', $groupId)->first();
            $newMainOrder->update(['is_main_order' => true]);
        }
        
        // 記錄退出日誌
        $this->logGroupLeave($order, $reason);
    });
}
```

### 4. 群組轉移功能

#### 主訂單轉移邏輯
```php
/**
 * 轉移群組主訂單
 */
public function transferGroupOwnership($groupId, $newMainOrderId)
{
    DB::transaction(function() use ($groupId, $newMainOrderId) {
        // 取消原主訂單
        Order::where('carpool_group_id', $groupId)
             ->where('is_main_order', true)
             ->update(['is_main_order' => false]);
        
        // 設定新主訂單
        $newMainOrder = Order::where('carpool_group_id', $groupId)
                             ->where('id', $newMainOrderId)
                             ->first();
        
        if (!$newMainOrder) {
            throw new CarpoolGroupException('指定的訂單不在該群組中');
        }
        
        $newMainOrder->update(['is_main_order' => true]);
        
        // 記錄轉移日誌
        $this->logOwnershipTransfer($groupId, $newMainOrder);
    });
}
```

### 5. 動態計費系統

#### 計費模式設計
```php
// app/Services/CarpoolBillingService.php

class CarpoolBillingService
{
    const BILLING_SEPARATE = 'separate';     // 分別計費
    const BILLING_SHARED = 'shared';         // 共同計費
    const BILLING_SPLIT = 'split';           // 分攤計費
    
    /**
     * 計算群組費用
     */
    public function calculateGroupBilling($groupId, $billingMode = self::BILLING_SPLIT)
    {
        $groupOrders = Order::where('carpool_group_id', $groupId)->get();
        $baseFare = $this->calculateBaseFare($groupOrders->first());
        
        switch ($billingMode) {
            case self::BILLING_SEPARATE:
                return $this->calculateSeparateBilling($groupOrders, $baseFare);
                
            case self::BILLING_SHARED:
                return $this->calculateSharedBilling($groupOrders, $baseFare);
                
            case self::BILLING_SPLIT:
                return $this->calculateSplitBilling($groupOrders, $baseFare);
                
            default:
                throw new InvalidArgumentException('無效的計費模式');
        }
    }
    
    /**
     * 分別計費：每人付全額
     */
    private function calculateSeparateBilling($orders, $baseFare)
    {
        return $orders->mapWithKeys(function($order) use ($baseFare) {
            return [$order->id => $baseFare];
        });
    }
    
    /**
     * 共同計費：主訂單付全額
     */
    private function calculateSharedBilling($orders, $baseFare)
    {
        return $orders->mapWithKeys(function($order) use ($baseFare) {
            return [$order->id => $order->is_main_order ? $baseFare : 0];
        });
    }
    
    /**
     * 分攤計費：平均分配
     */
    private function calculateSplitBilling($orders, $baseFare)
    {
        $splitAmount = $baseFare / $orders->count();
        
        return $orders->mapWithKeys(function($order) use ($splitAmount) {
            return [$order->id => $splitAmount];
        });
    }
}
```

---

## 記憶體管理考量

### 共乘功能記憶體影響分析

#### 1. 資料庫查詢記憶體影響

**群組查詢開銷**：
```php
// 原始單筆訂單查詢
Order::find($id); // ~2KB

// 群組訂單查詢（含關聯）
Order::with('groupMembers')->find($id); // ~6-10KB (視群組大小)

// 派遣清單查詢優化
Order::mainOrders()->with('groupMembers'); // 減少50%查詢量
```

**記憶體優化策略**：
```php
// 大量群組查詢時使用分塊載入
Order::where('carpool_group_id', '!=', null)
     ->chunk(100, function($orders) {
         // 處理每100筆群組訂單
     });

// 選擇性載入群組資訊
Order::select(['id', 'order_number', 'customer_name', 'carpool_group_id'])
     ->mainOrders()
     ->paginate(50);
```

#### 2. 群組狀態同步記憶體管理

**同步操作記憶體使用**：
```php
// 高記憶體風險：大群組同步
public function syncGroupStatus($groupId, $status)
{
    // 一次載入所有群組訂單到記憶體
    $orders = Order::where('carpool_group_id', $groupId)->get(); // 風險點
    
    foreach ($orders as $order) {
        $order->update(['status' => $status]);
    }
}

// 記憶體優化版本
public function syncGroupStatusOptimized($groupId, $status)
{
    // 直接批量更新，不載入到記憶體
    Order::where('carpool_group_id', $groupId)
         ->update(['status' => $status, 'updated_at' => now()]);
}
```

#### 3. 前端群組資料記憶體管理

**JavaScript 記憶體使用**：
```javascript
// 群組資料快取策略
class CarpoolGroupCache {
    constructor() {
        this.cache = new Map();
        this.maxSize = 100; // 限制快取大小
    }
    
    set(groupId, data) {
        if (this.cache.size >= this.maxSize) {
            // LRU 清理策略
            const firstKey = this.cache.keys().next().value;
            this.cache.delete(firstKey);
        }
        this.cache.set(groupId, data);
    }
    
    get(groupId) {
        return this.cache.get(groupId);
    }
}
```

### 大量共乘訂單處理策略

#### 1. 批次操作優化

```php
// 批次建立共乘訂單
public function batchCreateCarpoolOrders($orderDataArray)
{
    DB::transaction(function() use ($orderDataArray) {
        $groupId = 'batch_' . time();
        $orders = [];
        
        foreach ($orderDataArray as $index => $orderData) {
            $orders[] = array_merge($orderData, [
                'carpool_group_id' => $groupId,
                'is_main_order' => $index === 0,
                'created_at' => now(),
                'updated_at' => now()
            ]);
        }
        
        // 批次插入，減少記憶體開銷
        Order::insert($orders);
    });
}
```

#### 2. 索引優化建議

```sql
-- 群組查詢索引
CREATE INDEX idx_carpool_group_composite ON orders(carpool_group_id, is_main_order);

-- 派遣清單索引
CREATE INDEX idx_dispatch_optimized ON orders(is_main_order, status, ride_date, ride_time);

-- 解除群組查詢索引
CREATE INDEX idx_group_dissolution ON orders(is_group_dissolved, dissolved_at);
```

#### 3. 記憶體監控指標

```php
// 共乘功能記憶體監控
class CarpoolMemoryMonitor
{
    public function monitorGroupOperation($operation, callable $callback)
    {
        $memoryStart = memory_get_usage();
        $result = $callback();
        $memoryEnd = memory_get_usage();
        
        $memoryUsed = $memoryEnd - $memoryStart;
        
        if ($memoryUsed > 10 * 1024 * 1024) { // 10MB
            Log::warning('共乘操作高記憶體使用', [
                'operation' => $operation,
                'memory_used' => $memoryUsed,
                'peak_memory' => memory_get_peak_usage()
            ]);
        }
        
        return $result;
    }
}
```

### 記憶體使用基準

**單一訂單 vs 群組訂單記憶體對比**：
```
單一訂單：~2KB
2人群組：~4KB (+100%)
3人群組：~6KB (+200%)
4人群組：~8KB (+300%)

建議群組大小限制：最多4人，避免記憶體過度使用
```

**批量操作記憶體限制**：
```php
// 設定批量操作記憶體限制
ini_set('memory_limit', '512M'); // 臨時提高記憶體限制

// 分批處理大量群組
$groupIds = collect($allGroupIds)->chunk(50);
foreach ($groupIds as $chunk) {
    $this->processGroupBatch($chunk);
    gc_collect_cycles(); // 強制垃圾回收
}
```

---

## 測試與驗證策略

### 單元測試計劃

#### 1. 共乘群組核心功能測試

```php
// tests/Unit/CarpoolGroupServiceTest.php

class CarpoolGroupServiceTest extends TestCase
{
    protected $carpoolService;
    
    public function setUp(): void
    {
        parent::setUp();
        $this->carpoolService = app(CarpoolGroupService::class);
    }
    
    /** @test */
    public function it_can_create_carpool_group()
    {
        // 建立測試資料
        $customer1 = Customer::factory()->create();
        $customer2 = Customer::factory()->create();
        
        $orderData = [
            'customer_id' => $customer1->id,
            'carpool_customer_id' => $customer2->id,
            'ride_date' => '2024-01-01',
            'ride_time' => '14:00',
            // ... 其他必要欄位
        ];
        
        // 執行測試
        $result = $this->carpoolService->createCarpoolGroup($orderData);
        
        // 驗證結果
        $this->assertDatabaseHas('orders', [
            'customer_id' => $customer1->id,
            'carpool_group_id' => $result['group_id'],
            'is_main_order' => true
        ]);
        
        $this->assertDatabaseHas('orders', [
            'customer_id' => $customer2->id,
            'carpool_group_id' => $result['group_id'],
            'is_main_order' => false
        ]);
    }
    
    /** @test */
    public function it_can_dissolve_carpool_group()
    {
        // 建立測試群組
        $group = $this->createTestGroup();
        
        // 執行解除
        $result = $this->carpoolService->dissolveGroup($group['group_id']);
        
        // 驗證解除結果
        $this->assertDatabaseMissing('orders', [
            'carpool_group_id' => $group['group_id']
        ]);
        
        $this->assertDatabaseHas('orders', [
            'id' => $group['main_order_id'],
            'is_group_dissolved' => true,
            'original_group_id' => $group['group_id']
        ]);
    }
    
    /** @test */
    public function it_handles_return_trip_carpool_correctly()
    {
        // 測試往返共乘功能
        $customer1 = Customer::factory()->create();
        $customer2 = Customer::factory()->create();
        
        $orderData = [
            'customer_id' => $customer1->id,
            'carpool_customer_id' => $customer2->id,
            'ride_date' => '2024-01-01',
            'ride_time' => '14:00',
            'back_time' => '16:00', // 回程時間
            // ... 其他欄位
        ];
        
        $result = $this->carpoolService->createCarpoolGroup($orderData);
        
        // 應該建立4筆訂單：2人往返各2筆
        $orders = Order::where('carpool_group_id', $result['group_id'])->get();
        $this->assertCount(4, $orders);
        
        // 驗證往返訂單的時間
        $outboundOrders = $orders->where('ride_time', '14:00');
        $returnOrders = $orders->where('ride_time', '16:00');
        
        $this->assertCount(2, $outboundOrders);
        $this->assertCount(2, $returnOrders);
    }
    
    private function createTestGroup()
    {
        $customer1 = Customer::factory()->create();
        $customer2 = Customer::factory()->create();
        
        $groupId = 'test_group_' . time();
        
        $mainOrder = Order::factory()->create([
            'customer_id' => $customer1->id,
            'carpool_group_id' => $groupId,
            'is_main_order' => true,
            'carpool_member_count' => 2
        ]);
        
        $carpoolOrder = Order::factory()->create([
            'customer_id' => $customer2->id,
            'carpool_group_id' => $groupId,
            'is_main_order' => false,
            'carpool_member_count' => 2
        ]);
        
        return [
            'group_id' => $groupId,
            'main_order_id' => $mainOrder->id,
            'carpool_order_id' => $carpoolOrder->id
        ];
    }
}
```

#### 2. 群組狀態同步測試

```php
// tests/Unit/CarpoolStatusSyncTest.php

class CarpoolStatusSyncTest extends TestCase
{
    /** @test */
    public function it_syncs_driver_assignment_across_group()
    {
        $group = $this->createTestGroup();
        $driver = Driver::factory()->create();
        
        $service = app(CarpoolGroupService::class);
        $service->assignDriverToGroup($group['group_id'], $driver->id, [
            'driver_name' => $driver->name,
            'driver_fleet_number' => $driver->fleet_number,
            'driver_plate_number' => $driver->plate_number
        ]);
        
        // 驗證群組內所有訂單都被指派相同司機
        $orders = Order::where('carpool_group_id', $group['group_id'])->get();
        
        foreach ($orders as $order) {
            $this->assertEquals($driver->id, $order->driver_id);
            $this->assertEquals('assigned', $order->status);
        }
    }
    
    /** @test */
    public function it_handles_group_cancellation_correctly()
    {
        $group = $this->createTestGroup();
        
        $service = app(CarpoolGroupService::class);
        $service->cancelGroup($group['group_id'], '客戶取消');
        
        // 驗證群組內所有訂單都被取消
        $orders = Order::where('carpool_group_id', $group['group_id'])->get();
        
        foreach ($orders as $order) {
            $this->assertEquals('cancelled', $order->status);
            $this->assertStringContains('客戶取消', $order->remark);
        }
    }
}
```

### 整合測試場景

#### 1. 完整共乘流程測試

```php
// tests/Feature/CarpoolIntegrationTest.php

class CarpoolIntegrationTest extends TestCase
{
    use RefreshDatabase, WithFaker;
    
    /** @test */
    public function complete_carpool_workflow()
    {
        // 1. 登入用戶
        $user = User::factory()->create();
        $this->actingAs($user);
        
        // 2. 建立客戶資料
        $customer1 = Customer::factory()->create();
        $customer2 = Customer::factory()->create();
        
        // 3. 建立共乘訂單
        $response = $this->post('/orders', [
            'customer_id' => $customer1->id,
            'customer_name' => $customer1->name,
            'customer_id_number' => $customer1->id_number,
            'customer_phone' => $customer1->phone_number[0],
            'carpool_customer_id' => $customer2->id,
            'carpool_with' => $customer2->name,
            'ride_date' => '2024-01-01',
            'ride_time' => '14:00',
            'back_time' => '16:00',
            'pickup_address' => '台北市中正區忠孝西路一段49號',
            'dropoff_address' => '台北市大安區基隆路四段43號',
            // ... 其他必要欄位
        ]);
        
        $response->assertRedirect();
        $response->assertSessionHas('success', '成功建立 4 筆訂單（去程和回程）');
        
        // 4. 驗證建立的訂單
        $orders = Order::whereNotNull('carpool_group_id')->get();
        $this->assertCount(4, $orders);
        
        // 5. 指派司機
        $driver = Driver::factory()->create();
        $groupId = $orders->first()->carpool_group_id;
        
        $response = $this->post("/carpool-groups/{$groupId}/assign-driver", [
            'driver_id' => $driver->id
        ]);
        
        $response->assertJson(['success' => true]);
        
        // 6. 驗證司機指派
        $orders->each(function($order) use ($driver) {
            $order->refresh();
            $this->assertEquals($driver->id, $order->driver_id);
            $this->assertEquals('assigned', $order->status);
        });
        
        // 7. 解除群組
        $response = $this->post("/carpool-groups/{$groupId}/dissolve", [
            'reason' => '客戶不想共乘了'
        ]);
        
        $response->assertJson(['success' => true]);
        
        // 8. 驗證解除結果
        $orders->each(function($order) {
            $order->refresh();
            $this->assertNull($order->carpool_group_id);
            $this->assertTrue($order->is_group_dissolved);
        });
    }
}
```

#### 2. 記憶體壓力測試

```php
// tests/Performance/CarpoolMemoryTest.php

class CarpoolMemoryTest extends TestCase
{
    /** @test */
    public function it_handles_large_carpool_groups_efficiently()
    {
        $memoryStart = memory_get_usage();
        
        // 建立100個群組，每群組4人
        for ($i = 0; $i < 100; $i++) {
            $customers = Customer::factory()->count(4)->create();
            $this->createCarpoolGroup($customers);
        }
        
        $memoryEnd = memory_get_usage();
        $memoryUsed = $memoryEnd - $memoryStart;
        
        // 驗證記憶體使用不超過100MB
        $this->assertLessThan(100 * 1024 * 1024, $memoryUsed);
        
        // 測試批量查詢效能
        $start = microtime(true);
        $mainOrders = Order::mainOrders()->with('groupMembers')->get();
        $queryTime = microtime(true) - $start;
        
        // 查詢時間應該在合理範圍內
        $this->assertLessThan(2.0, $queryTime); // 2秒內
    }
    
    private function createCarpoolGroup($customers)
    {
        $groupId = 'perf_test_' . uniqid();
        
        foreach ($customers as $index => $customer) {
            Order::factory()->create([
                'customer_id' => $customer->id,
                'carpool_group_id' => $groupId,
                'is_main_order' => $index === 0,
                'carpool_member_count' => $customers->count()
            ]);
        }
    }
}
```

### 用戶體驗測試

#### 1. 前端互動測試

```php
// tests/Browser/CarpoolUserExperienceTest.php

class CarpoolUserExperienceTest extends DuskTestCase
{
    /** @test */
    public function user_can_create_carpool_order_smoothly()
    {
        $user = User::factory()->create();
        $customer1 = Customer::factory()->create();
        $customer2 = Customer::factory()->create();
        
        $this->browse(function (Browser $browser) use ($user, $customer1, $customer2) {
            $browser->loginAs($user)
                    ->visit('/orders/create')
                    
                    // 選擇客戶
                    ->type('customer_phone', $customer1->phone_number[0])
                    ->click('#searchCustomerBtn')
                    ->waitForText($customer1->name)
                    ->click('.select-customer-btn')
                    
                    // 填寫訂單資訊
                    ->type('ride_date', '2024-01-01')
                    ->type('ride_time', '1400')
                    ->type('back_time', '1600')
                    ->type('pickup_address', '台北市中正區忠孝西路一段49號')
                    ->type('dropoff_address', '台北市大安區基隆路四段43號')
                    
                    // 搜尋共乘對象
                    ->type('#carpoolSearchInput', $customer2->name)
                    ->click('#searchCarpoolBtn')
                    ->waitForText($customer2->name)
                    ->click('.select-carpool-btn')
                    
                    // 驗證共乘資訊已填入
                    ->assertInputValue('#carpool_with', $customer2->name)
                    
                    // 提交訂單
                    ->click('button[type="submit"]')
                    ->waitForText('成功建立 4 筆訂單')
                    
                    // 驗證頁面跳轉和訊息
                    ->assertPathIs('/orders')
                    ->assertSee('成功建立 4 筆訂單（去程和回程）');
        });
    }
    
    /** @test */
    public function user_can_manage_carpool_group()
    {
        $user = User::factory()->create();
        $group = $this->createTestGroupWithOrders();
        
        $this->browse(function (Browser $browser) use ($user, $group) {
            $browser->loginAs($user)
                    ->visit('/orders')
                    
                    // 點擊群組管理按鈕
                    ->click("[data-group-id='{$group['group_id']}']")
                    ->waitFor('#carpoolGroupModal')
                    
                    // 驗證群組資訊顯示
                    ->assertSee($group['group_id'])
                    ->assertSee('成員數量：2')
                    
                    // 測試解除群組
                    ->type('#dissolutionReason', '測試解除')
                    ->click('.btn-warning')
                    ->waitForText('確認解除')
                    ->click('.swal2-confirm')
                    ->waitForText('操作成功')
                    
                    // 驗證頁面更新
                    ->assertDontSee("[data-group-id='{$group['group_id']}']");
        });
    }
}
```

### 效能測試基準

#### 1. 查詢效能基準

```php
// 單一訂單查詢：< 50ms
// 群組訂單查詢：< 100ms
// 派遣清單載入：< 200ms
// 群組解除操作：< 500ms
```

#### 2. 記憶體使用基準

```php
// 建立2人群組：< 5MB
// 建立4人群組：< 10MB
// 批量群組操作（100群組）：< 100MB
// 群組解除操作：< 2MB
```

#### 3. 併發處理基準

```php
// 同時建立10個群組：< 2秒
// 同時解除10個群組：< 3秒
// 100個併發查詢：< 5秒
```

---

## 總結與建議

### 實作優先順序

#### 第一階段：核心功能（必須）
1. ✅ 資料庫結構調整
2. ✅ 基本群組建立功能
3. ✅ 群組狀態同步機制
4. ✅ 派遣系統整合

#### 第二階段：管理功能（重要）
1. ✅ 群組解除功能
2. ✅ 前端群組管理介面
3. ✅ API 設計和實作
4. ✅ 基本測試覆蓋

#### 第三階段：進階功能（可選）
1. 🔄 智能配對建議
2. 🔄 重新組群功能
3. 🔄 動態計費系統
4. 🔄 完整測試套件

### 長期維護建議

#### 1. 定期效能監控
- 監控群組查詢的執行時間
- 追蹤記憶體使用趨勢
- 分析使用者操作模式

#### 2. 功能使用分析
- 統計共乘功能使用率
- 分析群組解除原因
- 收集用戶反饋意見

#### 3. 系統最佳化
- 根據使用模式調整索引
- 優化查詢邏輯和快取策略
- 定期清理解散的群組歷史資料

### 風險評估與預案

#### 高風險點
1. **資料一致性**：群組操作的原子性
2. **效能影響**：大量群組查詢的效能
3. **用戶體驗**：複雜操作的易用性

#### 應對預案
1. **資料庫交易**：確保所有群組操作的原子性
2. **查詢優化**：使用適當的索引和查詢策略
3. **介面設計**：簡化操作流程和提供清楚的提示

---

*此文件最後更新：2024年12月31日*
*版本：v1.0*
*維護者：LC-management 開發團隊*