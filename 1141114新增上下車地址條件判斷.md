# 訂單地址驗證與自動不派遣功能技術文件

**文件版本**: 1.0
**建立日期**: 2025-11-14
**最後更新**: 2025-11-14
**負責開發**: Claude Code
**系統版本**: Laravel 10 + LC-management

---

## 📋 目錄

1. [功能概述](#功能概述)
2. [需求說明](#需求說明)
3. [技術架構](#技術架構)
4. [實作細節](#實作細節)
5. [程式碼位置](#程式碼位置)
6. [測試案例](#測試案例)
7. [故障排除](#故障排除)
8. [未來擴展](#未來擴展)

---

## 功能概述

本功能為長照訂單管理系統新增地址驗證機制，針對不同訂單類型（台北長照、新北長照）實施地址限制，並自動標記特定服務範圍外的訂單為「不派遣」狀態。

### 核心功能

1. **台北長照地址限制**: 上下車地址必須在新北市或台北市
2. **新北長照地址限制**: 上下車地址必須在新北市、台北市、桃園市或基隆市
3. **新北長照自動不派遣**: 客戶地址在 7 個特定區域時自動設為不派遣狀態

### 設計原則

- **雙重驗證**: 前端即時提示 + 後端安全驗證
- **使用者友善**: 即時反饋，清楚的錯誤訊息
- **向下相容**: 不影響現有訂單和匯入功能
- **可維護性**: 集中式驗證服務，易於修改規則

---

## 需求說明

### 需求 1: 台北長照地址縣市限制

**業務規則**:
- 訂單類型為「台北長照」時
- **上車地址**和**下車地址**都必須在允許的縣市範圍內
- 允許的縣市: `['新北市', '台北市']`

**驗證邏輯**:
```
IF order_type = '台北長照' THEN
    IF (上車縣市 NOT IN ['新北市', '台北市']) OR (下車縣市 NOT IN ['新北市', '台北市']) THEN
        拒絕建立訂單
        顯示錯誤: "上車/下車地址必須在新北市或台北市"
    END IF
END IF
```

**影響範圍**:
- ✅ 訂單建立（單筆）
- ✅ 訂單批量建立（50筆）
- ⚠️ 訂單編輯（警告但允許儲存）
- ❌ Excel 匯入（不影響）

---

### 需求 2: 新北長照地址縣市限制

**業務規則**:
- 訂單類型為「新北長照」時
- **上車地址**和**下車地址**都必須在允許的縣市範圍內
- 允許的縣市: `['新北市', '台北市', '桃園市', '基隆市']`

**驗證邏輯**:
```
IF order_type = '新北長照' THEN
    IF (上車縣市 NOT IN ['新北市', '台北市', '桃園市', '基隆市']) OR
       (下車縣市 NOT IN ['新北市', '台北市', '桃園市', '基隆市']) THEN
        拒絕建立訂單
        顯示錯誤: "上車/下車地址必須在新北市、台北市、桃園市或基隆市"
    END IF
END IF
```

**影響範圍**:
- ✅ 訂單建立（單筆）
- ✅ 訂單批量建立（50筆）
- ⚠️ 訂單編輯（警告但允許儲存）
- ❌ Excel 匯入（不影響）

---

### 需求 3: 新北長照特定區域自動不派遣

**業務規則**:
- 訂單類型為「新北長照」時
- 檢查**客戶地址**（通常為上車地址）的區域
- 如果客戶地址在 7 個特定區域，訂單狀態自動設為「不派遣」

**特定區域清單**:
```php
[
    '金山區',  // 新北市金山區
    '鶯歌區',  // 新北市鶯歌區
    '三峽區',  // 新北市三峽區
    '淡水區',  // 新北市淡水區
    '五股區',  // 新北市五股區
    '瑞芳區',  // 新北市瑞芳區
    '萬里區',  // 新北市萬里區
]
```

**驗證邏輯**:
```
IF order_type = '新北長照' THEN
    上車區域 = extractDistrict(上車地址)
    IF 上車區域 IN ['金山區', '鶯歌區', '三峽區', '淡水區', '五股區', '瑞芳區', '萬里區'] THEN
        訂單狀態 = 'no_send'
        顯示警告: "⚠️ 此客戶地址位於服務範圍外（{區域名稱}），訂單將自動設為「不派遣」狀態"
    END IF
END IF
```

**處理方式**:
- ✅ 前端: 顯示黃色警告訊息 + 自動切換狀態下拉選單
- ✅ 後端: 自動設定 `status = 'no_send'`
- ⚠️ 允許使用者手動修改狀態（有警告提示）

---

## 技術架構

### 系統架構圖

```
┌─────────────────────────────────────────────────────────────┐
│                      訂單建立/編輯頁面                           │
│  (resources/views/orders/components/order-form.blade.php)   │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │ 使用者輸入地址
                        ▼
┌─────────────────────────────────────────────────────────────┐
│              前端 JavaScript 即時驗證                          │
│           (public/js/orders/form.js)                        │
│                                                             │
│  • extractCounty() - 提取縣市                                │
│  • extractDistrict() - 提取區域                              │
│  • validateAddressByOrderType() - 驗證地址                   │
│  • showAddressErrors() - 顯示錯誤                            │
│  • showNoSendWarning() - 顯示不派遣警告                       │
│  • autoSetStatusToNoSend() - 自動設定狀態                     │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │ 表單提交
                        ▼
┌─────────────────────────────────────────────────────────────┐
│              後端 Controller 驗證                             │
│      (app/Http/Controllers/OrderController.php)            │
│                                                             │
│  • store() - 建立訂單時驗證                                   │
│  • update() - 編輯訂單時驗證（警告）                           │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │ 調用驗證服務
                        ▼
┌─────────────────────────────────────────────────────────────┐
│           AddressValidationService（核心驗證邏輯）             │
│        (app/Services/AddressValidationService.php)         │
│                                                             │
│  • validateOrderAddresses() - 主要驗證方法                    │
│  • validateTaipeiLongTermCare() - 台北長照驗證                │
│  • validateNewTaipeiLongTermCare() - 新北長照驗證             │
│  • getAllowedCounties() - 取得允許縣市                        │
│  • getNoSendDistricts() - 取得不派遣區域                      │
│  • shouldAutoSetNoSend() - 判斷是否自動不派遣                 │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │ 地址解析
                        ▼
┌─────────────────────────────────────────────────────────────┐
│          TaiwanAddressResolver（地址解析服務）                 │
│        (app/Services/TaiwanAddressResolver.php)            │
│                                                             │
│  • extractCounty() - 從地址提取縣市                           │
│  • extractDistrict() - 從地址提取區域                         │
└─────────────────────────────────────────────────────────────┘
```

---

## 實作細節

### 已修改的檔案清單

#### 新建檔案（1個）
- ✨ `app/Services/AddressValidationService.php` - 地址驗證服務

#### 修改檔案（4個）
- ✏️ `app/Http/Controllers/OrderController.php`
  - store() 方法：加入地址驗證（行號 195-219）
  - update() 方法：加入警告提示（行號 465-489）

- ✏️ `app/Services/BatchOrderService.php`
  - createSingleOrder() 方法：批量訂單驗證（行號 267-300）

- ✏️ `public/js/orders/form.js`
  - bindAddressEvents()：綁定驗證事件（行號 212）
  - 新增 5 個驗證相關方法（行號 3093-3238）

- ✏️ `resources/views/orders/components/order-form.blade.php`
  - 新增警告訊息顯示區域（行號 42-57）

---

## 程式碼位置

### 核心檔案清單

| 檔案路徑 | 說明 | 修改類型 |
|---------|------|---------|
| `app/Services/AddressValidationService.php` | 地址驗證服務（核心邏輯） | ✨ 新建 |
| `app/Http/Controllers/OrderController.php` | 訂單控制器（整合驗證） | ✏️ 修改 |
| `app/Services/BatchOrderService.php` | 批量訂單服務（整合驗證） | ✏️ 修改 |
| `public/js/orders/form.js` | 訂單表單 JavaScript（前端驗證） | ✏️ 修改 |
| `resources/views/orders/components/order-form.blade.php` | 訂單表單模板（警告顯示） | ✏️ 修改 |

### 關鍵程式碼行數

| 功能 | 檔案 | 行號 | 說明 |
|-----|------|-----|------|
| 地址驗證主方法 | `AddressValidationService.php` | 22-59 | validateOrderAddresses() |
| 台北長照驗證 | `AddressValidationService.php` | 65-78 | validateTaipeiLongTermCare() |
| 新北長照驗證 | `AddressValidationService.php` | 84-105 | validateNewTaipeiLongTermCare() |
| 不派遣區域清單 | `AddressValidationService.php` | 122-139 | getNoSendDistricts() |
| 訂單建立驗證 | `OrderController.php` | 195-219 | store() 方法整合 |
| 訂單編輯警告 | `OrderController.php` | 465-489 | update() 方法整合 |
| 批量訂單驗證 | `BatchOrderService.php` | 267-300 | createSingleOrder() 整合 |
| 前端地址驗證 | `form.js` | 3114-3179 | validateAddressByOrderType() |
| 自動不派遣設定 | `form.js` | 3219-3229 | autoSetStatusToNoSend() |
| 警告訊息顯示 | `order-form.blade.php` | 42-57 | Session Flash 訊息 |

---

## 測試案例

### 功能測試案例表格

| 測試編號 | 訂單類型 | 上車地址 | 下車地址 | 預期結果 | 預期狀態 |
|---------|---------|---------|---------|---------|---------|
| **台北長照測試** |
| T1 | 台北長照 | 台北市信義區市府路1號 | 新北市板橋區文化路168號 | ✅ 建立成功 | open |
| T2 | 台北長照 | 新北市新店區北新路3段 | 台北市大安區信義路五段7號 | ✅ 建立成功 | open |
| T3 | 台北長照 | 桃園市中壢區中正路100號 | 台北市信義區市府路1號 | ❌ 驗證失敗 | - |
| T4 | 台北長照 | 台北市中山區中山北路1號 | 基隆市中正區義一路1號 | ❌ 驗證失敗 | - |
| **新北長照測試** |
| T5 | 新北長照 | 新北市板橋區文化路168號 | 台北市信義區市府路1號 | ✅ 建立成功 | open |
| T6 | 新北長照 | 桃園市中壢區中正路100號 | 基隆市中正區義一路1號 | ✅ 建立成功 | open |
| T7 | 新北長照 | 新北市金山區中山路123號 | 台北市中正區重慶南路1號 | ✅ 建立成功 | **no_send** |
| T8 | 新北長照 | 新北市淡水區中正東路1號 | 台北市松山區市府路1號 | ✅ 建立成功 | **no_send** |
| T9 | 新北長照 | 宜蘭縣羅東鎮中正路1號 | 台北市中山區中山北路1號 | ❌ 驗證失敗 | - |
| **批量建立測試** |
| T10 | 台北長照 | 批量50筆，第10筆在桃園市 | 全部在台北市 | ❌ 全部拒絕 | - |
| T11 | 新北長照 | 批量20筆，全部合法 | 全部合法 | ✅ 20筆全建立 | 部分 no_send |

---

## 故障排除

### 常見問題與解決方案

#### 問題 1: 前端驗證沒有觸發

**症狀**:
- 輸入不合法地址後沒有顯示錯誤訊息
- 狀態沒有自動切換為「不派遣」

**解決方案**:
```javascript
// 檢查瀏覽器控制台是否有錯誤
console.log(orderForm); // 應該返回 OrderForm 物件

// 手動測試驗證方法
orderForm.validateAddressByOrderType();
```

#### 問題 2: 批量建立時部分訂單未檢查

**症狀**:
- 批量建立 10 筆訂單
- 第 5 筆地址不合法但沒有被攔截

**解決方案**:
```php
// 確保拋出 Exception 而不是返回錯誤
if (! $addressValidation['valid']) {
    throw new \Exception('地址驗證失敗：'.implode('；', $errors));
}
```

---

## 未來擴展

### 建議改進項目

#### 1. 服務範圍配置化
- 將規則移到資料庫或設定檔
- 提供管理介面讓管理員動態調整

#### 2. 區域細分控制
- 支援更精細的服務範圍控制
- 新增區域級別的白名單/黑名單機制

#### 3. 地址自動修正建議
- 當地址不合法時，推薦最近的合法地址
- 使用 Google Maps API 或地址資料庫提供建議

#### 4. 歷史統計與報表
- 記錄所有驗證失敗的案例
- 提供統計報表供管理員分析

---

## 附錄

### 版本歷史

| 版本 | 日期 | 變更內容 | 變更人員 |
|-----|------|---------|---------|
| 1.0 | 2025-11-14 | 初版文件建立，完整記錄地址驗證功能實作 | Claude Code |

---

**文件結束**
